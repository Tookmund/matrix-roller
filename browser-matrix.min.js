!function e(t,n,r){function i(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return i(n||e)},l,l.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){(function(n){var r=e("./lib/matrix");r.request(e("browser-request")),n.indexedDB&&r.setCryptoStoreFactory(function(){return new r.IndexedDBCryptoStore(n.indexedDB,"matrix-js-sdk:crypto")}),t.exports=r,n.matrixcs=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./lib/matrix":20,"browser-request":47}],2:[function(e,t,n){"use strict";function r(e){o.checkObjectHasKeys(e,["baseUrl","request"]),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl;var t={baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:i.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs};this._http=new i.MatrixHttpApi(this,t),this._txnCtr=0}var i=e("./http-api"),o=e("./utils");r.prototype.getHomeserverUrl=function(){return this.baseUrl},r.prototype.getIdentityServerUrl=function(){return this.idBaseUrl},r.prototype.getAccessToken=function(){return this._http.opts.accessToken||null},r.prototype.isLoggedIn=function(){return void 0!==this._http.opts.accessToken},r.prototype.makeTxnId=function(){return"m"+(new Date).getTime()+"."+this._txnCtr++},r.prototype.isUsernameAvailable=function(e){return this._http.authedRequest(void 0,"GET","/register/available",{username:e}).then(function(e){return e.available})},r.prototype.register=function(e,t,n,r,i,o,s){!0===i?i={email:!0}:null!==i&&void 0!==i||(i={}),void 0!==r&&null!==r||(r={}),n&&(r.session=n);var a={auth:r};return void 0!==e&&null!==e&&(a.username=e),void 0!==t&&null!==t&&(a.password=t),i.email&&(a.bind_email=!0),i.msisdn&&(a.bind_msisdn=!0),void 0!==o&&null!==o&&(a.guest_access_token=o),void 0!==t&&null!==t&&(a.x_show_msisdn=!0),this.registerRequest(a,void 0,s)},r.prototype.registerGuest=function(e,t){return e=e||{},e.body=e.body||{},this.registerRequest(e.body,"guest",t)},r.prototype.registerRequest=function(e,t,n){var r={};return t&&(r.kind=t),this._http.request(n,"POST","/register",r,e)},r.prototype.loginFlows=function(e){return this._http.request(e,"GET","/login")},r.prototype.login=function(e,t,n){var r={type:e};return o.extend(r,t),this._http.authedRequest(n,"POST","/login",void 0,r)},r.prototype.loginWithPassword=function(e,t,n){return this.login("m.login.password",{user:e,password:t},n)},r.prototype.loginWithSAML2=function(e,t){return this.login("m.login.saml2",{relay_state:e},t)},r.prototype.getCasLoginUrl=function(e){return this._http.getUrl("/login/cas/redirect",{redirectUrl:e},i.PREFIX_UNSTABLE)},r.prototype.loginWithToken=function(e,t){return this.login("m.login.token",{token:e},t)},r.prototype.logout=function(e){return this._http.authedRequest(e,"POST","/logout")},r.prototype.deactivateAccount=function(e,t){var n={};return e&&(n={auth:e}),this._http.authedRequestWithPrefix(t,"POST","/account/deactivate",void 0,n,i.PREFIX_UNSTABLE)},r.prototype.getFallbackAuthUrl=function(e,t){var n=o.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this._http.getUrl(n,{session:t},i.PREFIX_R0)},r.prototype.createRoom=function(e,t){return this._http.authedRequest(t,"POST","/createRoom",void 0,e)},r.prototype.roomState=function(e,t){var n=o.encodeUri("/rooms/$roomId/state",{$roomId:e});return this._http.authedRequest(t,"GET",n)},r.prototype.getStateEvent=function(e,t,n,r){var i={$roomId:e,$eventType:t,$stateKey:n},s=o.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==n&&(s=o.encodeUri(s+"/$stateKey",i)),this._http.authedRequest(r,"GET",s)},r.prototype.sendStateEvent=function(e,t,n,r,i){var s={$roomId:e,$eventType:t,$stateKey:r},a=o.encodeUri("/rooms/$roomId/state/$eventType",s);return void 0!==r&&(a=o.encodeUri(a+"/$stateKey",s)),this._http.authedRequest(i,"PUT",a,void 0,n)},r.prototype.redactEvent=function(e,t,n){var r=o.encodeUri("/rooms/$roomId/redact/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(n,"POST",r,void 0,{})},r.prototype.roomInitialSync=function(e,t,n){o.isFunction(t)&&(n=t,t=void 0);var r=o.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this._http.authedRequest(n,"GET",r,{limit:t})},r.prototype.setRoomReadMarkersHttpRequest=function(e,t,n){var r=o.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),i={"m.fully_read":t,"m.read":n};return this._http.authedRequest(void 0,"POST",r,void 0,i)},r.prototype.publicRooms=function(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});var n={};return e.server&&(n.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(n).length?this._http.authedRequest(t,"GET","/publicRooms"):this._http.authedRequest(t,"POST","/publicRooms",n,e)},r.prototype.createAlias=function(e,t,n){var r=o.encodeUri("/directory/room/$alias",{$alias:e}),i={room_id:t};return this._http.authedRequest(n,"PUT",r,void 0,i)},r.prototype.deleteAlias=function(e,t){var n=o.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"DELETE",n,void 0,void 0)},r.prototype.getRoomIdForAlias=function(e,t){var n=o.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"GET",n)},r.prototype.resolveRoomAlias=function(e,t){var n=o.encodeUri("/directory/room/$alias",{$alias:e});return this._http.request(t,"GET",n)},r.prototype.getRoomDirectoryVisibility=function(e,t){var n=o.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(t,"GET",n)},r.prototype.setRoomDirectoryVisibility=function(e,t,n){var r=o.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(n,"PUT",r,void 0,{visibility:t})},r.prototype.setRoomDirectoryVisibilityAppService=function(e,t,n,r){var i=o.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this._http.authedRequest(r,"PUT",i,void 0,{visibility:n})},r.prototype.searchUserDirectory=function(e){var t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this._http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)},r.prototype.uploadContent=function(e,t){return this._http.uploadContent(e,t)},r.prototype.cancelUpload=function(e){return this._http.cancelUpload(e)},r.prototype.getCurrentUploads=function(){return this._http.getCurrentUploads()},r.prototype.getProfileInfo=function(e,t,n){o.isFunction(t)&&(n=t,t=void 0);var r=t?o.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):o.encodeUri("/profile/$userId",{$userId:e});return this._http.authedRequest(n,"GET",r)},r.prototype.getThreePids=function(e){return this._http.authedRequest(e,"GET","/account/3pid",void 0,void 0)},r.prototype.addThreePid=function(e,t,n){var r={threePidCreds:e,bind:t};return this._http.authedRequest(n,"POST","/account/3pid",null,r)},r.prototype.deleteThreePid=function(e,t){var n={medium:e,address:t};return this._http.authedRequestWithPrefix(void 0,"POST","/account/3pid/delete",null,n,i.PREFIX_UNSTABLE)},r.prototype.setPassword=function(e,t,n){var r={auth:e,new_password:t};return this._http.authedRequest(n,"POST","/account/password",null,r)},r.prototype.getDevices=function(){return this._http.authedRequestWithPrefix(void 0,"GET","/devices",void 0,void 0,i.PREFIX_UNSTABLE)},r.prototype.setDeviceDetails=function(e,t){var n=o.encodeUri("/devices/$device_id",{$device_id:e});return this._http.authedRequestWithPrefix(void 0,"PUT",n,void 0,t,i.PREFIX_UNSTABLE)},r.prototype.deleteDevice=function(e,t){var n=o.encodeUri("/devices/$device_id",{$device_id:e}),r={};return t&&(r.auth=t),this._http.authedRequestWithPrefix(void 0,"DELETE",n,void 0,r,i.PREFIX_UNSTABLE)},r.prototype.getPushers=function(e){return this._http.authedRequest(e,"GET","/pushers",void 0,void 0)},r.prototype.setPusher=function(e,t){return this._http.authedRequest(t,"POST","/pushers/set",null,e)},r.prototype.getPushRules=function(e){return this._http.authedRequest(e,"GET","/pushrules/")},r.prototype.addPushRule=function(e,t,n,r,i){var s=o.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this._http.authedRequest(i,"PUT",s,void 0,r)},r.prototype.deletePushRule=function(e,t,n,r){var i=o.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this._http.authedRequest(r,"DELETE",i)},r.prototype.setPushRuleEnabled=function(e,t,n,r,i){var s=o.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this._http.authedRequest(i,"PUT",s,void 0,{enabled:r})},r.prototype.setPushRuleActions=function(e,t,n,r,i){var s=o.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this._http.authedRequest(i,"PUT",s,void 0,{actions:r})},r.prototype.search=function(e,t){var n={};return e.next_batch&&(n.next_batch=e.next_batch),this._http.authedRequest(t,"POST","/search",n,e.body)},r.prototype.uploadKeysRequest=function(e,t,n){t=t||{};var r=t.device_id,s=void 0;return s=r?o.encodeUri("/keys/upload/$deviceId",{$deviceId:r}):"/keys/upload",this._http.authedRequestWithPrefix(n,"POST",s,void 0,e,i.PREFIX_UNSTABLE)},r.prototype.downloadKeysForUsers=function(e,t){if(o.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");t=t||{};var n={device_keys:{}};return"token"in t&&(n.token=t.token),e.forEach(function(e){n.device_keys[e]={}}),this._http.authedRequestWithPrefix(void 0,"POST","/keys/query",void 0,n,i.PREFIX_UNSTABLE)},r.prototype.claimOneTimeKeys=function(e,t){var n={};void 0===t&&(t="signed_curve25519");for(var r=0;r<e.length;++r){var o=e[r][0],s=e[r][1],a=n[o]||{};n[o]=a,a[s]=t}var u={one_time_keys:n};return this._http.authedRequestWithPrefix(void 0,"POST","/keys/claim",void 0,u,i.PREFIX_UNSTABLE)},r.prototype.getKeyChanges=function(e,t){var n={from:e,to:t};return this._http.authedRequestWithPrefix(void 0,"GET","/keys/changes",n,void 0,i.PREFIX_UNSTABLE)},r.prototype.requestEmailToken=function(e,t,n,r,o){var s={client_secret:t,email:e,send_attempt:n,next_link:r};return this._http.idServerRequest(o,"POST","/validate/email/requestToken",s,i.PREFIX_IDENTITY_V1)},r.prototype.submitMsisdnToken=function(e,t,n){var r={sid:e,client_secret:t,token:n};return this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",r,i.PREFIX_IDENTITY_V1)},r.prototype.lookupThreePid=function(e,t,n){var r={medium:e,address:t};return this._http.idServerRequest(n,"GET","/lookup",r,i.PREFIX_IDENTITY_V1)},r.prototype.sendToDevice=function(e,t,n){var r=o.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),s={messages:t};return this._http.authedRequestWithPrefix(void 0,"PUT",r,void 0,s,i.PREFIX_UNSTABLE)},r.prototype.getThirdpartyProtocols=function(){return this._http.authedRequestWithPrefix(void 0,"GET","/thirdparty/protocols",void 0,void 0,i.PREFIX_UNSTABLE)},r.prototype.getThirdpartyLocation=function(e,t){var n=o.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this._http.authedRequestWithPrefix(void 0,"GET",n,t,void 0,i.PREFIX_UNSTABLE)},t.exports=r},{"./http-api":18,"./utils":44}],3:[function(e,t,n){(function(n){"use strict";function r(e){U.call(this,e),this.store=e.store||new k,this.deviceId=e.deviceId||null;var t=e.userId||null;if(this.credentials={userId:t},this.scheduler=e.scheduler,this.scheduler){var n=this;this.scheduler.setProcessFunction(function(e){var t=n.getRoom(e.getRoomId());return e.status!==w.SENDING&&u(t,e,w.SENDING),c(n,e)})}this.clientRunning=!1,this.callList={};var r=D.createNewMatrixCall(this);this._supportsVoip=!1,r&&(p(this),this._supportsVoip=!0),this._syncingRetry=null,this._syncApi=null,this._peekSync=null,this._isGuest=!1,this._ongoingScrollbacks={},this.timelineSupport=Boolean(e.timelineSupport),this.urlPreviewCache={},this._notifTimelineSet=null,this._crypto=null,this._cryptoStore=e.cryptoStore,M&&Boolean(e.sessionStore)&&Boolean(this._cryptoStore)&&null!==t&&null!==this.deviceId&&(this._crypto=new L(this,this,e.sessionStore,t,this.deviceId,this.store,e.cryptoStore),this.olmVersion=L.getOlmVersion())}function i(e,t,n,r,i,o){if(!e._crypto)throw new Error("End-to-End encryption disabled");var s=e._crypto.setDeviceVerification(t,n,r,i,o);e.emit("deviceVerificationChanged",t,n,s)}function o(e,t){if(!e._crypto)return void s(t,"Encryption not enabled");try{e._crypto.decryptEvent(t)}catch(e){if(console.warn("Error decrypting event (id="+t.getId()+"): "+e),"DecryptionError"!==e.name)throw e;return void s(t,e.message)}}function s(e,t){e.setClearData({type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+t+" **"}})}function a(e,t,n,r){return S().then(function(){var r=null;return e._crypto&&(r=e._crypto.encryptEventIfNeeded(n,t)),r&&(u(t,n,w.ENCRYPTING),r=r.then(function(){u(t,n,w.SENDING)})),r}).then(function(){var r=void 0;return e.scheduler&&(r=e.scheduler.queueEvent(n))&&e.scheduler.getQueueForEvent(n).length>1&&u(t,n,w.QUEUED),r||(r=c(e,n)),r}).then(function(e){return t&&t.updatePendingEvent(n,w.SENT,e.event_id),r&&r(null,e),e},function(e){console.error("Error sending event",e.stack||e);try{u(t,n,w.NOT_SENT),n.error=e,r&&r(e)}catch(t){console.error("Exception in error handler!",t.stack||e)}throw e})}function u(e,t,n){e?e.updatePendingEvent(t,n):t.status=n}function c(e,t){var n=t._txnId?t._txnId:e.makeTxnId(),r={$roomId:t.getRoomId(),$eventType:t.getWireType(),$stateKey:t.getStateKey(),$txnId:n},i=void 0;if(t.isState()){var o="/rooms/$roomId/state/$eventType";t.getStateKey()&&t.getStateKey().length>0&&(o="/rooms/$roomId/state/$eventType/$stateKey"),i=x.encodeUri(o,r)}else i=x.encodeUri("/rooms/$roomId/send/$eventType/$txnId",r);return e._http.authedRequest(void 0,"PUT",i,void 0,t.getWireContent()).then(function(e){return console.log("Event sent to "+t.getRoomId()+" with event id "+e.event_id),e})}function l(e,t,n,r,i,o){x.isFunction(i)&&(o=i,i=void 0);var s=x.encodeUri("/rooms/$roomId/state/m.room.member/$userId",{$roomId:t,$userId:n});return e._http.authedRequest(o,"PUT",s,void 0,{membership:r,reason:i})}function d(e,t,n,r,i,o){x.isFunction(i)&&(o=i,i=void 0);var s=x.encodeUri("/rooms/$room_id/$membership",{$room_id:t,$membership:r});return e._http.authedRequest(o,"POST",s,void 0,{user_id:n,reason:i})}function h(e,t,n,r){var i=x.encodeUri("/presence/list/$userId",{$userId:t.credentials.userId});return t._http.authedRequest(e,r,i,void 0,n)}function p(e){function t(t){if(0===t.getType().indexOf("m.call.")){var r=t.getContent(),i=r.call_id?e.callList[r.call_id]:void 0,o=void 0;if("m.call.invite"===t.getType()){if(t.getSender()===e.credentials.userId)return;if(t.getAge()>r.lifetime)return;if(i&&"ended"===i.state)return;if(i&&console.log("WARN: Already have a MatrixCall with id %s but got an invite. Clobbering.",r.call_id),!(i=D.createNewMatrixCall(e,t.getRoomId())))return void console.log("Incoming call ID "+r.call_id+" but this client doesn't support WebRTC");if(i.callId=r.call_id,i._initWithInvite(t),e.callList[i.callId]=i,n[i.callId])for(o=0;o<n[i.callId].length;o++)i._gotRemoteIceCandidate(n[i.callId][o]);var s=void 0,a=x.values(e.callList);for(o=0;o<a.length;++o){var u=a[o];if(i.roomId===u.roomId&&"outbound"===u.direction&&-1!==["wait_local_media","create_offer","invite_sent"].indexOf(u.state)){s=u;break}}s?"wait_local_media"===s.state||"create_offer"===s.state||s.callId>i.callId?(console.log("Glare detected: answering incoming call "+i.callId+" and canceling outgoing call "+s.callId),s._replacedBy(i),i.answer()):(console.log("Glare detected: rejecting incoming call "+i.callId+" and keeping outgoing call "+s.callId),i.hangup()):e.emit("Call.incoming",i)}else if("m.call.answer"===t.getType()){if(!i)return;t.getSender()===e.credentials.userId?"ringing"===i.state&&i._onAnsweredElsewhere(r):i._receivedAnswer(r)}else if("m.call.candidates"===t.getType()){if(t.getSender()===e.credentials.userId)return;if(i)for(o=0;o<r.candidates.length;o++)i._gotRemoteIceCandidate(r.candidates[o]);else n[r.call_id]||(n[r.call_id]=[]),n[r.call_id]=n[r.call_id].concat(r.candidates)}else"m.call.hangup"===t.getType()&&(i?"ended"!==i.state&&(i._onHangupReceived(r),delete e.callList[r.call_id]):(i=D.createNewMatrixCall(e,t.getRoomId()))&&(i.callId=r.call_id,i._initWithHangup(t),e.callList[r.call_id]=i))}}var n={},r=[],i=!1;e.on("sync",function(e){if("PREPARED"===e){i=!0;for(var n={},o=r.length-1;o>=0;o--){var s=r[o];"m.call.answer"!==s.getType()&&"m.call.hangup"!==s.getType()||(n[s.getContent().call_id]="yep")}r.forEach(function(e){n[e.getContent().call_id]||t(e)}),r=[]}}),e.on("event",function(e){if(!i)return void(0===e.getType().indexOf("m.call.")&&r.push(e));t(e)})}function f(e){e._supportsVoip&&(e.isGuest()||e.turnServer().done(function(t){if(t.uris){console.log("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");var n={urls:t.uris,username:t.username,credential:t.password};e._turnServers=[n],e._checkTurnServersTimeoutID=setTimeout(function(){f(e)},1e3*(t.ttl||3600)*.9)}},function(t){console.error("Failed to get TURN URIs"),e._checkTurnServersTimeoutID=setTimeout(function(){f(e)},6e4)}))}function v(e,t,n){e&&e(n),t.reject(n)}function m(e,t,n){e&&e(null,n),t.resolve(n)}function y(e){function t(t){var n=new T(t);return n.isEncrypted()&&o(e,n),n}return t}var g=e("./pushprocessor"),_=e("events").EventEmitter,S=e("q"),E=e("url"),b=e("./http-api"),T=e("./models/event").MatrixEvent,w=e("./models/event").EventStatus,I=e("./models/event-timeline"),R=e("./models/search-result"),k=e("./store/stub"),D=e("./webrtc/call"),x=e("./utils"),C=e("./content-repo"),A=e("./filter"),O=e("./sync"),U=e("./base-apis"),P=b.MatrixError,M=!1;try{var L=e("./crypto");M=!0}catch(e){console.warn("Unable to load crypto module: crypto will be disabled: "+e)}x.inherits(r,_),x.extend(r.prototype,U.prototype),r.prototype.clearStores=function(){if(this._clientRunning)throw new Error("Cannot clear stores while client is running");var e=[];return e.push(this.store.deleteAllData()),this._cryptoStore&&e.push(this._cryptoStore.deleteAllData()),S.all(e)},r.prototype.getUserId=function(){return this.credentials&&this.credentials.userId?this.credentials.userId:null},r.prototype.getDomain=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null},r.prototype.getUserIdLocalpart=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null},r.prototype.getDeviceId=function(){return this.deviceId},r.prototype.supportsVoip=function(){return this._supportsVoip},r.prototype.getSyncState=function(){return this._syncApi?this._syncApi.getSyncState():null},r.prototype.isGuest=function(){return this._isGuest},r.prototype.getScheduler=function(){return this.scheduler},r.prototype.setGuest=function(e){this._isGuest=e},r.prototype.retryImmediately=function(){return this._syncApi.retryImmediately()},r.prototype.getNotifTimelineSet=function(){return this._notifTimelineSet},r.prototype.setNotifTimelineSet=function(e){this._notifTimelineSet=e},r.prototype.isCryptoEnabled=function(){return null!==this._crypto},r.prototype.getDeviceEd25519Key=function(){return this._crypto?this._crypto.getDeviceEd25519Key():null},r.prototype.uploadKeys=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.uploadDeviceKeys()},r.prototype.downloadKeys=function(e,t){return null===this._crypto?S.reject(new Error("End-to-end encryption disabled")):this._crypto.downloadKeys(e,t)},r.prototype.listDeviceKeys=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.listDeviceKeys(e)},r.prototype.getStoredDevicesForUser=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevicesForUser(e)||[]},r.prototype.getStoredDevice=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevice(e,t)||null},r.prototype.setDeviceVerified=function(e,t,n){void 0===n&&(n=!0),i(this,e,t,n,null)},r.prototype.setDeviceBlocked=function(e,t,n){void 0===n&&(n=!0),i(this,e,t,null,n)},r.prototype.setDeviceKnown=function(e,t,n){void 0===n&&(n=!0),i(this,e,t,null,null,n)},r.prototype.setGlobalBlacklistUnverifiedDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalBlacklistUnverifiedDevices(e)},r.prototype.getGlobalBlacklistUnverifiedDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalBlacklistUnverifiedDevices()},r.prototype.getEventSenderDeviceInfo=function(e){return this._crypto?this._crypto.getEventSenderDeviceInfo(e):null},r.prototype.isEventSenderVerified=function(e){var t=this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()},r.prototype.setRoomEncryption=function(e,t){if(!this._crypto)throw new Error("End-to-End encryption disabled");return this._crypto.setRoomEncryption(e,t),S()},r.prototype.isRoomEncrypted=function(e){return!!this._crypto&&this._crypto.isRoomEncrypted(e)},r.prototype.exportRoomKeys=function(){return this._crypto?this._crypto.exportRoomKeys():S.reject(new Error("End-to-end encryption disabled"))},r.prototype.importRoomKeys=function(e){if(!this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.importRoomKeys(e)},r.prototype.getRoom=function(e){return this.store.getRoom(e)},r.prototype.getRooms=function(){return this.store.getRooms()},r.prototype.getUser=function(e){return this.store.getUser(e)},r.prototype.getUsers=function(){return this.store.getUsers()},r.prototype.setAccountData=function(e,t,n){var r=x.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this._http.authedRequest(n,"PUT",r,void 0,t)},r.prototype.getAccountData=function(e){return this.store.getAccountData(e)},r.prototype.joinRoom=function(e,t,n){if(x.isFunction(t))throw new Error("Expected 'opts' object, got function.");t=t||{},void 0===t.syncRoom&&(t.syncRoom=!0);var r=this.getRoom(e);if(r&&r.hasMembershipState(this.credentials.userId,"join"))return S(r);var i=S();t.inviteSignUrl&&(i=this._http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));var o=S.defer(),s=this;return i.then(function(t){var n={};t&&(n.third_party_signed=t);var r=x.encodeUri("/join/$roomid",{$roomid:e});return s._http.authedRequest(void 0,"POST",r,void 0,n)}).then(function(e){var n=e.room_id,r=new O(s,s._clientOpts),i=r.createRoom(n);return t.syncRoom,S(i)}).done(function(e){m(n,o,e)},function(e){v(n,o,e)}),o.promise},r.prototype.resendEvent=function(e,t){return u(t,e,w.SENDING),a(this,t,e)},r.prototype.cancelPendingEvent=function(e){if([w.QUEUED,w.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e),u(this.getRoom(e.getRoomId()),e,w.CANCELLED)},r.prototype.setRoomName=function(e,t,n){return this.sendStateEvent(e,"m.room.name",{name:t},void 0,n)},r.prototype.setRoomTopic=function(e,t,n){return this.sendStateEvent(e,"m.room.topic",{topic:t},void 0,n)},r.prototype.getRoomTags=function(e,t){var n=x.encodeUri("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this._http.authedRequest(t,"GET",n,void 0)},r.prototype.setRoomTag=function(e,t,n,r){var i=x.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(r,"PUT",i,void 0,n)},r.prototype.deleteRoomTag=function(e,t,n){var r=x.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(n,"DELETE",r,void 0,void 0)},r.prototype.setRoomAccountData=function(e,t,n,r){var i=x.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this._http.authedRequest(r,"PUT",i,void 0,n)},r.prototype.setPowerLevel=function(e,t,n,r,i){var o={users:{}};r&&"m.room.power_levels"===r.getType()&&(o=x.deepCopy(r.getContent())),o.users[t]=n;var s=x.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this._http.authedRequest(i,"PUT",s,void 0,o)},r.prototype.sendEvent=function(e,t,n,r,i){x.isFunction(r)&&(i=r,r=void 0),r||(r=this.makeTxnId()),console.log("sendEvent of type "+t+" in "+e+" with txnId "+r);var o=this.getRoom(e),s=new T({event_id:"~"+e+":"+r,user_id:this.credentials.userId,room_id:e,type:t,origin_server_ts:(new Date).getTime(),content:n});return s._txnId=r,s.status=w.SENDING,o&&o.addPendingEvent(s,r),a(this,o,s,i)},r.prototype.sendMessage=function(e,t,n,r){return x.isFunction(n)&&(r=n,n=void 0),this.sendEvent(e,"m.room.message",t,n,r)},r.prototype.sendTextMessage=function(e,t,n,r){var i={msgtype:"m.text",body:t};return this.sendMessage(e,i,n,r)},r.prototype.sendNotice=function(e,t,n,r){var i={msgtype:"m.notice",body:t};return this.sendMessage(e,i,n,r)},r.prototype.sendEmoteMessage=function(e,t,n,r){var i={msgtype:"m.emote",body:t};return this.sendMessage(e,i,n,r)},r.prototype.sendImageMessage=function(e,t,n,r,i){x.isFunction(r)&&(i=r,r=void 0),r||(r="Image");var o={msgtype:"m.image",url:t,info:n,body:r};return this.sendMessage(e,o,i)},r.prototype.sendHtmlMessage=function(e,t,n,r){var i={msgtype:"m.text",format:"org.matrix.custom.html",body:t,formatted_body:n};return this.sendMessage(e,i,r)},r.prototype.sendHtmlNotice=function(e,t,n,r){var i={msgtype:"m.notice",format:"org.matrix.custom.html",body:t,formatted_body:n};return this.sendMessage(e,i,r)},r.prototype.sendHtmlEmote=function(e,t,n,r){var i={msgtype:"m.emote",format:"org.matrix.custom.html",body:t,formatted_body:n};return this.sendMessage(e,i,r)},r.prototype.sendReceipt=function(e,t,n){if(this.isGuest())return S({});var r=x.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),i=this._http.authedRequest(n,"POST",r,void 0,{}),o=this.getRoom(e.getRoomId());return o&&o._addLocalEchoReceipt(this.credentials.userId,e,t),i},r.prototype.sendReadReceipt=function(e,t){return this.sendReceipt(e,"m.read",t)},r.prototype.setRoomReadMarkers=function(e,t,n){var r=t,i=void 0;if(n){i=n.getId();var o=this.getRoom(e);o&&o._addLocalEchoReceipt(this.credentials.userId,n,"m.read")}return this.setRoomReadMarkersHttpRequest(e,r,i)},r.prototype.getUrlPreview=function(e,t,n){var r=t+"_"+e,i=this.urlPreviewCache[r];if(i)return S(i);var o=this;return this._http.authedRequestWithPrefix(n,"GET","/preview_url",{url:e,ts:t},void 0,b.PREFIX_MEDIA_R0).then(function(e){return o.urlPreviewCache[r]=e,e})},r.prototype.sendTyping=function(e,t,n,r){if(this.isGuest())return S({});var i=x.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),o={typing:t};return t&&(o.timeout=n||2e4),this._http.authedRequest(r,"PUT",i,void 0,o)},r.prototype.invite=function(e,t,n){return d(this,e,t,"invite",void 0,n)},r.prototype.inviteByEmail=function(e,t,n){return this.inviteByThreePid(e,"email",t,n)},r.prototype.inviteByThreePid=function(e,t,n,r){var i=x.encodeUri("/rooms/$roomId/invite",{$roomId:e}),o=this.getIdentityServerUrl();return o?(0!==o.indexOf("http://")&&0!==o.indexOf("https://")||(o=o.split("://")[1]),this._http.authedRequest(r,"POST",i,void 0,{id_server:o,medium:t,address:n})):S.reject(new P({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}))},r.prototype.leave=function(e,t){return d(this,e,void 0,"leave",void 0,t)},r.prototype.ban=function(e,t,n,r){return d(this,e,t,"ban",n,r)},r.prototype.forget=function(e,t,n){void 0===t&&(t=!0);var r=d(this,e,void 0,"forget",void 0,n);if(!t)return r;var i=this;return r.then(function(t){return i.store.removeRoom(e),i.emit("deleteRoom",e),t})},r.prototype.unban=function(e,t,n){var r=x.encodeUri("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this._http.authedRequest(n,"POST",r,void 0,i)},r.prototype.kick=function(e,t,n,r){return l(this,e,t,"leave",n,r)},r.prototype.getPushActionsForEvent=function(e){if(!e.getPushActions()){var t=new g(this);e.setPushActions(t.actionsForEvent(e))}return e.getPushActions()},r.prototype.setProfileInfo=function(e,t,n){var r=x.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this._http.authedRequest(n,"PUT",r,void 0,t)},r.prototype.setDisplayName=function(e,t){return this.setProfileInfo("displayname",{displayname:e},t)},r.prototype.setAvatarUrl=function(e,t){return this.setProfileInfo("avatar_url",{avatar_url:e},t)},r.prototype.mxcUrlToHttp=function(e,t,n,r,i){return C.getHttpUriForMxc(this.baseUrl,e,t,n,r,i)},r.prototype.setPresence=function(e,t){var n=x.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});if("string"==typeof e&&(e={presence:e}),-1==["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this._http.authedRequest(t,"PUT",n,void 0,e)},r.prototype.getPresenceList=function(e){return h(e,this,void 0,"GET")},r.prototype.inviteToPresenceList=function(e,t){return h(e,this,{invite:t},"POST")},r.prototype.dropFromPresenceList=function(e,t){return h(e,this,{drop:t},"POST")},r.prototype.scrollback=function(e,t,n){x.isFunction(t)&&(n=t,t=void 0),t=t||30;var r=0,i=this._ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){var o=Date.now()-i.errorTs;r=Math.max(3e3-o,0)}if(null===e.oldState.paginationToken)return S(e);var s=this.store.scrollback(e,t).length;if(s===t)return S(e);t-=s;var a=x.encodeUri("/rooms/$roomId/messages",{$roomId:e.roomId}),u={from:e.oldState.paginationToken,limit:t,dir:"b"},c=S.defer();i={promise:c.promise,errorTs:null};var l=this;return S.delay(r).then(function(){return l._http.authedRequest(n,"GET",a,u)}).done(function(t){var r=x.map(t.chunk,y(l));e.addEventsToTimeline(r,!0,e.getLiveTimeline()),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),l.store.storeEvents(e,r,t.end,!0),l._ongoingScrollbacks[e.roomId]=null,m(n,c,e)},function(t){l._ongoingScrollbacks[e.roomId]={errorTs:Date.now()},v(n,c,t)}),this._ongoingScrollbacks[e.roomId]=i,c.promise},r.prototype.paginateEventContext=function(e,t){t=t||{};var n=t.backwards||!1,r=e.getPaginateToken(n);if(!r)return S.reject(new Error("No paginate token"));var i=n?"b":"f",o=e._paginateRequests[i];if(o)return o;var s=x.encodeUri("/rooms/$roomId/messages",{$roomId:e.getEvent().getRoomId()}),a={from:r,limit:"limit"in t?t.limit:30,dir:i},u=this,c=u._http.authedRequest(void 0,"GET",s,a).then(function(t){var r=t.end;if(0===t.chunk.length)r=null;else{var i=x.map(t.chunk,u.getEventMapper());n&&i.reverse(),e.addEvents(i,n)}return e.setPaginateToken(r,n),e}).finally(function(){e._paginateRequests[i]=null});return e._paginateRequests[i]=c,c},r.prototype.getEventTimeline=function(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return S(e.getTimelineForEvent(t));var n=x.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),r=this;return r._http.authedRequest(void 0,"GET",n).then(function(n){if(!n.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);n.events_after.reverse();var i=n.events_after.concat([n.event]).concat(n.events_before),o=x.map(i,r.getEventMapper()),s=e.getTimelineForEvent(o[0].getId());return s||(s=e.addTimeline(),s.initialiseState(x.map(n.state,r.getEventMapper())),s.getState(I.FORWARDS).paginationToken=n.end),e.addEventsToTimeline(o,!0,s,n.start),e.getTimelineForEvent(t)||s})},r.prototype.paginateEventTimeline=function(e,t){
var n=e.getTimelineSet()===this._notifTimelineSet;t=t||{};var r=t.backwards||!1;if(n&&!r)throw new Error("paginateNotifTimeline can only paginate backwards");var i=r?I.BACKWARDS:I.FORWARDS,o=e.getPaginationToken(i);if(!o)return S(!1);var s=e._paginationRequests[i];if(s)return s;var a=void 0,u=void 0,c=void 0,l=this;if(n)a="/notifications",u={limit:"limit"in t?t.limit:30,only:"highlight"},o&&"end"!==o&&(u.from=o),c=this._http.authedRequestWithPrefix(void 0,"GET",a,u,void 0,b.PREFIX_UNSTABLE).then(function(t){for(var n=t.next_token,o=[],s=0;s<t.notifications.length;s++){var a=t.notifications[s],u=l.getEventMapper()(a.event);u.setPushActions(g.actionListToActionsObject(a.actions)),u.event.room_id=a.room_id,o[s]=u}return e.getTimelineSet().addEventsToTimeline(o,r,e,n),r&&!t.next_token&&e.setPaginationToken(null,i),!!t.next_token}).finally(function(){e._paginationRequests[i]=null}),e._paginationRequests[i]=c;else{if(!this.getRoom(e.getRoomId()))throw new Error("Unknown room "+e.getRoomId());a=x.encodeUri("/rooms/$roomId/messages",{$roomId:e.getRoomId()}),u={from:o,limit:"limit"in t?t.limit:30,dir:i};var d=e.getFilter();d&&(u.filter=JSON.stringify(d.getRoomTimelineFilterComponent())),c=this._http.authedRequest(void 0,"GET",a,u).then(function(t){var n=t.end,o=x.map(t.chunk,l.getEventMapper());return e.getTimelineSet().addEventsToTimeline(o,r,e,n),r&&t.end==t.start&&e.setPaginationToken(null,i),t.end!=t.start}).finally(function(){e._paginationRequests[i]=null}),e._paginationRequests[i]=c}return c},r.prototype.resetNotifTimelineSet=function(){this._notifTimelineSet&&this._notifTimelineSet.resetLiveTimeline("end",!0)},r.prototype.peekInRoom=function(e){return this._peekSync&&this._peekSync.stopPeeking(),this._peekSync=new O(this,this._clientOpts),this._peekSync.peek(e)},r.prototype.stopPeeking=function(){this._peekSync&&(this._peekSync.stopPeeking(),this._peekSync=null)},r.prototype.setGuestAccess=function(e,t){var n=this.sendStateEvent(e,"m.room.guest_access",{guest_access:t.allowJoin?"can_join":"forbidden"}),r=S();return t.allowRead&&(r=this.sendStateEvent(e,"m.room.history_visibility",{history_visibility:"world_readable"})),S.all(r,n)},r.prototype.requestRegisterEmailToken=function(e,t,n,r){return this._requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})},r.prototype.requestRegisterMsisdnToken=function(e,t,n,r,i){return this._requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})},r.prototype.requestAdd3pidEmailToken=function(e,t,n,r){return this._requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})},r.prototype.requestAdd3pidMsisdnToken=function(e,t,n,r,i){return this._requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})},r.prototype.requestPasswordEmailToken=function(e,t,n,r){return this._requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:r})},r.prototype.requestPasswordMsisdnToken=function(e,t,n,r,i){return this._requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:r,next_link:i})},r.prototype._requestTokenFromEndpoint=function(e,t){var n=E.parse(this.idBaseUrl);if(null===n.host)throw new Error("Invalid ID server URL: "+this.idBaseUrl);var r=Object.assign({},t,{id_server:n.host});return this._http.request(void 0,"POST",e,void 0,r)},r.prototype.getRoomPushRule=function(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(var n=0;n<this.pushRules[e].room.length;n++){var r=this.pushRules[e].room[n];if(r.rule_id===t)return r}},r.prototype.setRoomMutePushRule=function(e,t,n){var r=this,i=void 0,o=void 0,s=this.getRoomPushRule(e,t);if(s&&0<=s.actions.indexOf("dont_notify")&&(o=!0),n?s?o||(i=S.defer(),this.deletePushRule(e,"room",s.rule_id).done(function(){r.addPushRule(e,"room",t,{actions:["dont_notify"]}).done(function(){i.resolve()},function(e){i.reject(e)})},function(e){i.reject(e)}),i=i.promise):i=this.addPushRule(e,"room",t,{actions:["dont_notify"]}):o&&(i=this.deletePushRule(e,"room",s.rule_id)),i){var a=S.defer();return i.done(function(){r.getPushRules().done(function(e){r.pushRules=e,a.resolve()},function(e){a.reject(e)})},function(e){r.getPushRules().done(function(t){r.pushRules=t,a.reject(e)},function(t){a.reject(e)})}),a.promise}},r.prototype.searchMessageText=function(e,t){var n={search_term:e.query};return"keys"in e&&(n.keys=e.keys),this.search({body:{search_categories:{room_events:n}}},t)},r.prototype.searchRoomEvents=function(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then(this._processRoomEventsSearch.bind(this,n))},r.prototype.backPaginateRoomEventsSearch=function(e){if(!e.next_batch)return S.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},n=this.search(t).then(this._processRoomEventsSearch.bind(this,e)).finally(function(){e.pendingRequest=null});return e.pendingRequest=n,n},r.prototype._processRoomEventsSearch=function(e,t){var n=t.search_categories.room_events;e.count=n.count,e.next_batch=n.next_batch;var r={};n.highlights.forEach(function(e){r[e]=1}),e.highlights.forEach(function(e){r[e]=1}),e.highlights=Object.keys(r);for(var i=0;i<n.results.length;i++){var o=R.fromJson(n.results[i],this.getEventMapper());e.results.push(o)}return e},r.prototype.syncLeftRooms=function(){if(this._syncedLeftRooms)return S([]);if(this._syncLeftRoomsPromise)return this._syncLeftRoomsPromise;var e=this,t=new O(this,this._clientOpts);return this._syncLeftRoomsPromise=t.syncLeftRooms(),this._syncLeftRoomsPromise.then(function(t){console.log("Marking success of sync left room request"),e._syncedLeftRooms=!0}).finally(function(){e._syncLeftRoomsPromise=null}),this._syncLeftRoomsPromise},r.prototype.createFilter=function(e){var t=this,n=x.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",n,void 0,e).then(function(n){var r=A.fromJson(t.credentials.userId,n.filter_id,e);return t.store.storeFilter(r),r})},r.prototype.getFilter=function(e,t,n){if(n){var r=this.store.getFilter(e,t);if(r)return S(r)}var i=this,o=x.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this._http.authedRequest(void 0,"GET",o,void 0,void 0).then(function(n){var r=A.fromJson(e,t,n);return i.store.storeFilter(r),r})},r.prototype.getOrCreateFilter=function(e,t){var n=this.store.getFilterIdByName(e),r=S(),i=this;return n&&(r=i.getFilter(i.credentials.userId,n,!0).then(function(r){var o=r.getDefinition(),s=t.getDefinition();if(x.deepCompare(o,s))return S(n);i.store.setFilterIdByName(e,void 0)},function(t){if(404!==t.httpStatus||"M_UNKNOWN"!==t.errcode&&"M_NOT_FOUND"!==t.errcode)throw t;return void i.store.setFilterIdByName(e,void 0)})),r.then(function(n){return n||i.createFilter(t.getDefinition()).then(function(t){return i.store.setFilterIdByName(e,t.filterId),t.filterId})})},r.prototype.getOpenIdToken=function(){var e=x.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",e,void 0,{})},r.prototype.turnServer=function(e){return this._http.authedRequest(e,"GET","/voip/turnServer")},r.prototype.getTurnServers=function(){return this._turnServers||[]},r.prototype.startClient=function(e){var t=this;this.clientRunning||(this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e}),this._crypto&&this._crypto.uploadDeviceKeys().done(),f(this),this._syncApi&&(console.error("Still have sync object whilst not running: stopping old one"),this._syncApi.stop()),e=Object.assign({},e),e.crypto=this._crypto,e.canResetEntireTimeline=function(e){return!!t._canResetTimelineCallback&&t._canResetTimelineCallback(e)},this._clientOpts=e,this._syncApi=new O(this,e),this._syncApi.sync())},r.prototype.stopClient=function(){this.clientRunning=!1,this._syncApi&&(this._syncApi.stop(),this._syncApi=null),this._peekSync&&this._peekSync.stopPeeking(),n.clearTimeout(this._checkTurnServersTimeoutID)},r.prototype.setCanResetTimelineCallback=function(e){this._canResetTimelineCallback=e},r.prototype.getCanResetTimelineCallback=function(){return this._canResetTimelineCallback},r.prototype.getEventMapper=function(){return y(this)},r.prototype.generateClientSecret=function(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<32;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},t.exports.MatrixClient=r,t.exports.CRYPTO_ENABLED=M}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./base-apis":2,"./content-repo":4,"./crypto":12,"./filter":17,"./http-api":18,"./models/event":24,"./models/event-timeline":23,"./models/search-result":29,"./pushprocessor":31,"./store/stub":40,"./sync":42,"./utils":44,"./webrtc/call":45,events:48,q:51,url:55}],4:[function(e,t,n){"use strict";var r=e("./utils");t.exports={getHttpUriForMxc:function(e,t,n,i,o,s){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return s?t:"";var a=t.slice(6),u="/_matrix/media/v1/download/",c={};n&&(c.width=n),i&&(c.height=i),o&&(c.method=o),r.keys(c).length>0&&(u="/_matrix/media/v1/thumbnail/");var l=a.indexOf("#"),d="";return l>=0&&(d=a.substr(l),a=a.substr(0,l)),e+u+a+(0===r.keys(c).length?"":"?"+r.encodeParams(c))+d},getIdenticonUri:function(e,t,n,i){if(!t)return null;n||(n=96),i||(i=96);var o={width:n,height:i};return e+r.encodeUri("/_matrix/media/v1/identicon/$ident",{$ident:t})+(0===r.keys(o).length?"":"?"+r.encodeParams(o))}}},{"./utils":44}],5:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t,n,r){var i=!1;for(var o in n)n.hasOwnProperty(o)&&(o in r||(console.log("Device "+t+":"+o+" has been removed"),delete n[o],i=!0));for(var a in r)if(r.hasOwnProperty(a)){var u=r[a];u.user_id===t?u.device_id===a?s(e,n,u)&&(i=!0):console.warn("Mismatched device_id "+u.device_id+" in keys from "+t+":"+a):console.warn("Mismatched user_id "+u.user_id+" in keys from "+t+":"+a)}return i}function s(e,t,n){if(!n.keys)return!1;var r=n.device_id,i=n.user_id,o="ed25519:"+r,s=n.keys[o];if(!s)return console.warn("Device "+i+":"+r+" has no ed25519 key"),!1;var a=n.unsigned||{};try{p.default.verifySignature(e,n,i,r,s)}catch(e){return console.warn("Unable to verify signature on device "+i+":"+r+":"+e),!1}var u=void 0;if(r in t){if(u=t[r],u.getFingerprint()!=s)return console.warn("Ed25519 key for device "+i+":"+r+" has changed"),!1}else t[r]=u=new d.default(r);return u.keys=n.keys||{},u.algorithms=n.algorithms||[],u.unsigned=a,!0}Object.defineProperty(n,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=e("q"),c=r(u),l=e("./deviceinfo"),d=r(l),h=e("./olmlib"),p=r(h),f=1,v=2,m=function(){function e(t,n,r){i(this,e),this._sessionStore=n,this._serialiser=new y(t,n,r),this._deviceTrackingStatus=n.getEndToEndDeviceTrackingStatus()||{};var o=!0,s=!1,a=void 0;try{for(var u,c=Object.keys(this._deviceTrackingStatus)[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){var l=u.value;this._deviceTrackingStatus[l]==v&&(this._deviceTrackingStatus[l]=f)}}catch(e){s=!0,a=e}finally{try{!o&&c.return&&c.return()}finally{if(s)throw a}}this._keyDownloadsInProgressByUser={},this.lastKnownSyncToken=null}return a(e,[{key:"downloadKeys",value:function(e,t){var n=this,r=[],i=[];if(e.forEach(function(e){var o=n._deviceTrackingStatus[e];n._keyDownloadsInProgressByUser[e]?(console.log("downloadKeys: already have a download in progress for "+e+": awaiting its result"),i.push(n._keyDownloadsInProgressByUser[e])):(t||3!=o)&&r.push(e)}),0!=r.length){console.log("downloadKeys: downloading for",r);var o=this._doKeyDownload(r);i.push(o)}return 0===i.length&&console.log("downloadKeys: already have all necessary keys"),c.default.all(i).then(function(){return n._getDevicesFromStore(e)})}},{key:"_getDevicesFromStore",value:function(e){var t={},n=this;return e.map(function(e){t[e]={},(n.getStoredDevicesForUser(e)||[]).map(function(n){t[e][n.deviceId]=n})}),t}},{key:"getStoredDevicesForUser",value:function(e){var t=this._sessionStore.getEndToEndDevicesForUser(e);if(!t)return null;var n=[];for(var r in t)t.hasOwnProperty(r)&&n.push(d.default.fromStorage(t[r],r));return n}},{key:"getStoredDevice",value:function(e,t){var n=this._sessionStore.getEndToEndDevicesForUser(e);if(n&&n[t])return d.default.fromStorage(n[t],t)}},{key:"getDeviceByIdentityKey",value:function(e,t,n){if(t!==p.default.OLM_ALGORITHM&&t!==p.default.MEGOLM_ALGORITHM)return null;var r=this._sessionStore.getEndToEndDevicesForUser(e);if(!r)return null;for(var i in r)if(r.hasOwnProperty(i)){var o=r[i];for(var s in o.keys)if(o.keys.hasOwnProperty(s)&&0===s.indexOf("curve25519:")){var a=o.keys[s];if(a==n)return d.default.fromStorage(o,i)}}return null}},{key:"startTrackingDeviceList",value:function(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this._deviceTrackingStatus[e]||(console.log("Now tracking device list for "+e),this._deviceTrackingStatus[e]=f)}},{key:"invalidateUserDeviceList",value:function(e){this._deviceTrackingStatus[e]&&(console.log("Marking device list outdated for",e),this._deviceTrackingStatus[e]=f)}},{key:"invalidateAllDeviceLists",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,i=Object.keys(this._deviceTrackingStatus)[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){var o=r.value;this.invalidateUserDeviceList(o)}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}}},{key:"refreshOutdatedDeviceLists",value:function(){var e=[],t=!0,n=!1,r=void 0;try{for(var i,o=Object.keys(this._deviceTrackingStatus)[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;this._deviceTrackingStatus[s]==f&&e.push(s)}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}if(0!=e.length)return this._persistDeviceTrackingStatus(),this._doKeyDownload(e)}},{key:"_doKeyDownload",value:function(e){var t=this;if(0===e.length)return(0,c.default)();var n=this._serialiser.updateDevicesForUsers(e,this.lastKnownSyncToken).then(function(){r(!0)},function(t){throw console.error("Error downloading keys for "+e+":",t),r(!1),t});e.forEach(function(e){t._keyDownloadsInProgressByUser[e]=n,t._deviceTrackingStatus[e]==f&&(t._deviceTrackingStatus[e]=v)});var r=function(r){e.forEach(function(e){if(t._keyDownloadsInProgressByUser[e]!==n)return void console.log("Another update in the queue for",e,"- not marking up-to-date");delete t._keyDownloadsInProgressByUser[e],t._deviceTrackingStatus[e]==v&&(r?(t._deviceTrackingStatus[e]=3,console.log("Device list for",e,"now up to date")):t._deviceTrackingStatus[e]=f)}),t._persistDeviceTrackingStatus()};return n}},{key:"_persistDeviceTrackingStatus",value:function(){this._sessionStore.storeEndToEndDeviceTrackingStatus(this._deviceTrackingStatus)}}]),e}();n.default=m;var y=function(){function e(t,n,r){i(this,e),this._baseApis=t,this._sessionStore=n,this._olmDevice=r,this._downloadInProgress=!1,this._keyDownloadsQueuedByUser={},this._queuedQueryDeferred=null,this._nextSyncToken=null}return a(e,[{key:"updateDevicesForUsers",value:function(e,t){var n=this;return e.forEach(function(e){n._keyDownloadsQueuedByUser[e]=!0}),this._nextSyncToken=t,this._queuedQueryDeferred||(this._queuedQueryDeferred=c.default.defer()),this._downloadInProgress?(console.log("Queued key download for",e),this._queuedQueryDeferred.promise):this._doQueuedQueries()}},{key:"_doQueuedQueries",value:function(){var e=this;if(this._downloadInProgress)throw new Error("DeviceListUpdateSerialiser._doQueuedQueries called with request active");var t=Object.keys(this._keyDownloadsQueuedByUser);this._keyDownloadsQueuedByUser={};var n=this._queuedQueryDeferred;this._queuedQueryDeferred=null,console.log("Starting key download for",t),this._downloadInProgress=!0;var r={};return this._nextSyncToken&&(r.token=this._nextSyncToken),this._baseApis.downloadKeysForUsers(t,r).then(function(n){var r=n.device_keys||{},i=(0,c.default)(),o=!0,s=!1,a=void 0;try{for(var u,l=t[Symbol.iterator]();!(o=(u=l.next()).done);o=!0)!function(){var t=u.value;i=i.delay(5).then(function(){e._processQueryResponseForUser(t,r[t])})}()}catch(e){s=!0,a=e}finally{try{!o&&l.return&&l.return()}finally{if(s)throw a}}return i}).done(function(){console.log("Completed key download for "+t),e._downloadInProgress=!1,n.resolve(),e._queuedQueryDeferred&&e._doQueuedQueries()},function(r){console.warn("Error downloading keys for "+t+":",r),e._downloadInProgressInProgress=!1,n.reject(r)}),n.promise}},{key:"_processQueryResponseForUser",value:function(e,t){console.log("got keys for "+e+":",t);var n={},r=this._sessionStore.getEndToEndDevicesForUser(e);r&&Object.keys(r).forEach(function(e){var t=d.default.fromStorage(r[e],e);n[e]=t}),o(this._olmDevice,e,n,t||{});var i={};Object.keys(n).forEach(function(e){i[e]=n[e].toStorage()}),this._sessionStore.storeEndToEndDevicesForUser(e,i)}}]),e}()},{"./deviceinfo":11,"./olmlib":13,q:51}],6:[function(e,t,n){(function(n){"use strict";function r(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>u)throw new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is "+u+" bytes.")}function i(e){this._sessionStore=e,this._pickleKey="DEFAULT_KEY";var t=void 0,n=new s.Account;try{o(this._sessionStore,this._pickleKey,n),t=JSON.parse(n.identity_keys())}finally{n.free()}this.deviceCurve25519Key=t.curve25519,this.deviceEd25519Key=t.ed25519,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={}}function o(e,t,n){var r=e.getEndToEndAccount();if(null!==r)return void n.unpickle(t,r);n.create();var i=n.pickle(t);e.storeEndToEndAccount(i)}var s=n.Olm;if(!s)throw new Error("global.Olm is not defined");var a=e("../utils"),u=49152;i.getOlmVersion=function(){return s.get_library_version()},i.prototype._getAccount=function(e){var t=new s.Account;try{var n=this._sessionStore.getEndToEndAccount();return t.unpickle(this._pickleKey,n),e(t)}finally{t.free()}},i.prototype._saveAccount=function(e){var t=e.pickle(this._pickleKey);this._sessionStore.storeEndToEndAccount(t)},i.prototype._getSession=function(e,t,n){var r=this._sessionStore.getEndToEndSessions(e),i=r[t],o=new s.Session;try{return o.unpickle(this._pickleKey,i),n(o)}finally{o.free()}},i.prototype._saveSession=function(e,t){var n=t.pickle(this._pickleKey);this._sessionStore.storeEndToEndSession(e,t.session_id(),n)},i.prototype._getUtility=function(e){var t=new s.Utility;try{return e(t)}finally{t.free()}},i.prototype.sign=function(e){return this._getAccount(function(t){return t.sign(e)})},i.prototype.getOneTimeKeys=function(){return this._getAccount(function(e){return JSON.parse(e.one_time_keys())})},i.prototype.maxNumberOfOneTimeKeys=function(){return this._getAccount(function(e){return e.max_number_of_one_time_keys()})},i.prototype.markKeysAsPublished=function(){var e=this;this._getAccount(function(t){t.mark_keys_as_published(),e._saveAccount(t)})},i.prototype.generateOneTimeKeys=function(e){var t=this;this._getAccount(function(n){n.generate_one_time_keys(e),t._saveAccount(n)})},i.prototype.createOutboundSession=function(e,t){var n=this;return this._getAccount(function(r){var i=new s.Session;try{return i.create_outbound(r,e,t),n._saveSession(e,i),i.session_id()}finally{i.free()}})},i.prototype.createInboundSession=function(e,t,n){if(0!==t)throw new Error("Need message_type == 0 to create inbound session");var r=this;return this._getAccount(function(i){var o=new s.Session;try{o.create_inbound_from(i,e,n),i.remove_one_time_keys(o),r._saveAccount(i);var a=o.decrypt(t,n);return r._saveSession(e,o),{payload:a,session_id:o.session_id()}}finally{o.free()}})},i.prototype.getSessionIdsForDevice=function(e){var t=this._sessionStore.getEndToEndSessions(e);return a.keys(t)},i.prototype.getSessionIdForDevice=function(e){var t=this.getSessionIdsForDevice(e);return 0===t.length?null:(t.sort(),t[0])},i.prototype.getSessionInfoForDevice=function(e){function t(e){return{hasReceivedMessage:e.has_received_message()}}var n=this.getSessionIdsForDevice(e);n.sort();for(var r=[],i=0;i<n.length;i++){var o=n[i],s=this._getSession(e,o,t);s.sessionId=o,r.push(s)}return r},i.prototype.encryptMessage=function(e,t,n){var i=this;return r(n),this._getSession(e,t,function(t){var r=t.encrypt(n);return i._saveSession(e,t),r})},i.prototype.decryptMessage=function(e,t,n,r){var i=this;return this._getSession(e,t,function(t){var o=t.decrypt(n,r);return i._saveSession(e,t),o})},i.prototype.matchesSession=function(e,t,n,r){return 0===n&&this._getSession(e,t,function(e){return e.matches_inbound(r)})},i.prototype._saveOutboundGroupSession=function(e){var t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},i.prototype._getOutboundGroupSession=function(e,t){var n=this._outboundGroupSessionStore[e];if(null===n)throw new Error("Unknown outbound group session "+e);var r=new s.OutboundGroupSession;try{return r.unpickle(this._pickleKey,n),t(r)}finally{r.free()}},i.prototype.createOutboundGroupSession=function(){var e=new s.OutboundGroupSession;try{return e.create(),this._saveOutboundGroupSession(e),e.session_id()}finally{e.free()}},i.prototype.encryptGroupMessage=function(e,t){var n=this;return r(t),this._getOutboundGroupSession(e,function(e){var r=e.encrypt(t);return n._saveOutboundGroupSession(e),r})},i.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,function(e){return{chain_index:e.message_index(),key:e.session_key()}})},i.prototype._saveInboundGroupSession=function(e,t,n,r,i){var o={room_id:e,session:r.pickle(this._pickleKey),keysClaimed:i};this._sessionStore.storeEndToEndInboundGroupSession(t,n,JSON.stringify(o))},i.prototype._getInboundGroupSession=function(e,t,n,r){var i=this._sessionStore.getEndToEndInboundGroupSession(t,n);if(null===i)return null;if(i=JSON.parse(i),e!==i.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+i.room_id+", was "+e+")");var o=new s.InboundGroupSession;try{return o.unpickle(this._pickleKey,i.session),r(o,i.keysClaimed||{})}finally{o.free()}},i.prototype.addInboundGroupSession=function(e,t,n,r,i){function o(e){return console.log("Update for megolm session "+t+"/"+n),!0}var a=this;if(null===this._getInboundGroupSession(e,t,n,o)){var u=new s.InboundGroupSession;try{if(u.create(r),n!=u.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);a._saveInboundGroupSession(e,t,n,u,i)}finally{u.free()}}},i.prototype.importInboundGroupSession=function(e){function t(t){return console.log("Update for megolm session "+e.sender_key+"|"+e.session_id),!0}if(null===this._getInboundGroupSession(e.room_id,e.sender_key,e.session_id,t)){var n=new s.InboundGroupSession;try{if(n.import_session(e.session_key),e.session_id!=n.session_id())throw new Error("Mismatched group session ID from senderKey: "+e.sender_key);this._saveInboundGroupSession(e.room_id,e.sender_key,e.session_id,n,e.sender_claimed_keys)}finally{n.free()}}},i.prototype.decryptGroupMessage=function(e,t,n,r){function i(i,s){var a=i.decrypt(r),u=a.plaintext;if(void 0===u)u=a;else{var c=t+"|"+n+"|"+a.message_index;if(c in o._inboundGroupSessionMessageIndexes)throw new Error("Duplicate message index, possible replay attack: "+c);o._inboundGroupSessionMessageIndexes[c]=!0}var l={curve25519:t};return o._saveInboundGroupSession(e,t,n,i,s),{result:u,keysClaimed:s,keysProved:l}}var o=this;return this._getInboundGroupSession(e,t,n,i)},i.prototype.exportInboundGroupSession=function(e,t){var n=this._sessionStore.getEndToEndInboundGroupSession(e,t);if(null===n)throw new Error("Unknown inbound group session ["+e+","+t+"]");var r=JSON.parse(n),i=new s.InboundGroupSession;try{i.unpickle(this._pickleKey,r.session);var o=i.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:i.export_session(o)}}finally{i.free()}},i.prototype.verifySignature=function(e,t,n){this._getUtility(function(r){r.ed25519_verify(e,t,n)})},t.exports=i}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../utils":44}],7:[function(e,t,n){"use strict";function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t,n){u[e]=t,c[e]=n}Object.defineProperty(n,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();n.registerAlgorithm=s;var u=n.ENCRYPTION_CLASSES={},c=n.DECRYPTION_CLASSES={},l=function(){function e(t){o(this,e),this._userId=t.userId,this._deviceId=t.deviceId,this._crypto=t.crypto,this._olmDevice=t.olmDevice,this._baseApis=t.baseApis,this._roomId=t.roomId}return a(e,[{key:"onRoomMembership",value:function(e,t,n){}}]),e}();n.EncryptionAlgorithm=l;var d=function(){function e(t){o(this,e),this._userId=t.userId,this._crypto=t.crypto,this._olmDevice=t.olmDevice,this._roomId=t.roomId}return a(e,[{key:"onRoomKeyEvent",value:function(e){}},{key:"importRoomKey",value:function(e){}}]),e}();n.DecryptionAlgorithm=d;var h=function(e){function t(e,n){o(this,t);var i=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.name="DecryptionError",i.details=n,i}return i(t,e),a(t,[{key:"toString",value:function(){var e=this,t=this.name+"[msg: "+this.message;return this.details&&(t+=", "+Object.keys(this.details).map(function(t){return t+": "+e.details[t]}).join(", ")),t+="]"}}]),t}(Error);n.DecryptionError=h;n.UnknownDeviceError=function(e){function t(e,n){o(this,t);var i=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.name="UnknownDeviceError",i.devices=n,i}return i(t,e),t}(Error)},{}],8:[function(e,t,n){"use strict";var r=e("./base");e("./olm"),e("./megolm"),t.exports.ENCRYPTION_CLASSES=r.ENCRYPTION_CLASSES,t.exports.DECRYPTION_CLASSES=r.DECRYPTION_CLASSES,t.exports.DecryptionError=r.DecryptionError},{"./base":7,"./megolm":9,"./olm":10}],9:[function(e,t,n){"use strict";function r(e){this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={}}function i(e){c.EncryptionAlgorithm.call(this,e),this._setupPromise=s(),this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function o(e){c.DecryptionAlgorithm.call(this,e),this._pendingEvents={}}var s=e("q"),a=e("../../utils"),u=e("../olmlib"),c=e("./base");r.prototype.needsRotation=function(e,t){var n=(new Date).getTime()-this.creationTime;return(this.useCount>=e||n>=t)&&(console.log("Rotating megolm session after "+this.useCount+" messages, "+n+"ms"),!0)},r.prototype.sharedWithTooManyDevices=function(e){for(var t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return console.log("Starting new session because we shared with "+t),!0;for(var n in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(n)&&!e[t].hasOwnProperty(n))return console.log("Starting new session because we shared with "+t+":"+n),!0}},a.inherits(i,c.EncryptionAlgorithm),i.prototype._ensureOutboundSession=function(e){function t(t){i=t,i&&i.needsRotation(r._sessionRotationPeriodMsgs,r._sessionRotationPeriodMs)&&(console.log("Starting new megolm session because we need to rotate."),i=null),i&&i.sharedWithTooManyDevices(e)&&(i=null),i||(console.log("Starting new megolm session for room "+r._roomId),i=r._prepareNewSession());var n={};for(var o in e)if(e.hasOwnProperty(o)){var s=e[o];for(var a in s)if(s.hasOwnProperty(a)){var u=s[a],c=u.getIdentityKey();c!=r._olmDevice.deviceCurve25519Key&&(i.sharedWithDevices[o]&&void 0!==i.sharedWithDevices[o][a]||(n[o]=n[o]||[],n[o].push(u)))}}return r._shareKeyWithDevices(i,n)}function n(){return i}var r=this,i=void 0,o=this._setupPromise.then(t);return this._setupPromise=o.then(n,n),o.then(n)},i.prototype._prepareNewSession=function(){var e=this._olmDevice.createOutboundGroupSession(),t=this._olmDevice.getOutboundGroupSessionKey(e);return this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,e,t.key,{ed25519:this._olmDevice.deviceEd25519Key}),new r(e)},i.prototype._shareKeyWithDevices=function(e,t){var n=this,r=this._olmDevice.getOutboundGroupSessionKey(e.sessionId),i={type:"m.room_key",content:{algorithm:u.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:e.sessionId,session_key:r.key,chain_index:r.chain_index}},o={};return u.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t).then(function(e){var r=!1;for(var a in t)if(t.hasOwnProperty(a))for(var c=t[a],l=e[a],d=0;d<c.length;d++){var h=c[d],p=h.deviceId,f=l[p];if(f.sessionId){console.log("sharing keys with device "+a+":"+p);var v={algorithm:u.OLM_ALGORITHM,sender_key:n._olmDevice.deviceCurve25519Key,ciphertext:{}};u.encryptMessageForDevice(v.ciphertext,n._userId,n._deviceId,n._olmDevice,a,h,i),o[a]||(o[a]={}),o[a][p]=v,r=!0}}return r?n._baseApis.sendToDevice("m.room.encrypted",o):s()}).then(function(){console.log("Completed megolm keyshare in "+n._roomId);for(var i in t)if(t.hasOwnProperty(i)){e.sharedWithDevices[i]||(e.sharedWithDevices[i]={});for(var o=t[i],s=0;s<o.length;s++){var a=o[s];e.sharedWithDevices[i][a.deviceId]=r.chain_index}}})},i.prototype.encryptMessage=function(e,t,n){var r=this;return console.log("Starting to encrypt event for "+this._roomId),this._getDevicesInRoom(e).then(function(e){return r._checkForUnknownDevices(e),r._ensureOutboundSession(e)}).then(function(e){var i={room_id:r._roomId,type:t,content:n},o=r._olmDevice.encryptGroupMessage(e.sessionId,JSON.stringify(i)),s={algorithm:u.MEGOLM_ALGORITHM,sender_key:r._olmDevice.deviceCurve25519Key,ciphertext:o,session_id:e.sessionId,device_id:r._deviceId};return e.useCount++,s})},i.prototype._checkForUnknownDevices=function(e){var t={};if(Object.keys(e).forEach(function(n){Object.keys(e[n]).forEach(function(r){var i=e[n][r];i.isUnverified()&&!i.isKnown()&&(t[n]||(t[n]={}),t[n][r]=i)})}),Object.keys(t).length)throw new c.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},i.prototype._getDevicesInRoom=function(e){var t=this,n=a.map(e.getJoinedMembers(),function(e){return e.userId});return this._crypto.downloadKeys(n,!1).then(function(n){for(var r in n)if(n.hasOwnProperty(r)){var i=n[r]
;for(var o in i)i.hasOwnProperty(o)&&(i[o].isBlocked()||i[o].isUnverified()&&(e.getBlacklistUnverifiedDevices()||t._crypto.getGlobalBlacklistUnverifiedDevices()))&&delete i[o]}return n})},a.inherits(o,c.DecryptionAlgorithm),o.prototype.decryptEvent=function(e){var t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new c.DecryptionError("Missing fields in input");var n=void 0;try{n=this._olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext)}catch(n){throw"OLM.UNKNOWN_MESSAGE_INDEX"===n.message&&this._addEventToPendingList(e),new c.DecryptionError(n.toString(),{session:t.sender_key+"|"+t.session_id})}if(null===n)throw this._addEventToPendingList(e),new c.DecryptionError("The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id});var r=JSON.parse(n.result);if(r.room_id!==e.getRoomId())throw new c.DecryptionError("Message intended for room "+r.room_id);e.setClearData(r,n.keysProved,n.keysClaimed)},o.prototype._addEventToPendingList=function(e){var t=e.getWireContent(),n=t.sender_key+"|"+t.session_id;this._pendingEvents[n]||(this._pendingEvents[n]=[]),this._pendingEvents[n].push(e)},o.prototype.onRoomKeyEvent=function(e){var t=e.getContent(),n=e.getSenderKey(),r=t.session_id;return t.room_id&&r&&t.session_key?n?(console.log("Adding key for megolm session "+n+"|"+r),this._olmDevice.addInboundGroupSession(t.room_id,n,r,t.session_key,e.getKeysClaimed()),void this._retryDecryption(n,r)):void console.error("key event has no sender key (not encrypted?)"):void console.error("key event is missing fields")},o.prototype.importRoomKey=function(e){this._olmDevice.importInboundGroupSession(e),this._retryDecryption(e.sender_key,e.session_id)},o.prototype._retryDecryption=function(e,t){var n=e+"|"+t,r=this._pendingEvents[n];if(r){delete this._pendingEvents[n];for(var i=0;i<r.length;i++)try{this.decryptEvent(r[i]),console.log("successful re-decryption of",r[i])}catch(e){console.log("Still can't decrypt",r[i],e.stack||e)}}},c.registerAlgorithm(u.MEGOLM_ALGORITHM,i,o)},{"../../utils":44,"../olmlib":13,"./base":7,q:51}],10:[function(e,t,n){"use strict";function r(e){l.EncryptionAlgorithm.call(this,e),this._sessionPrepared=!1,this._prepPromise=null}function i(e){l.DecryptionAlgorithm.call(this,e)}var o=e("q"),s=e("../../utils"),a=e("../olmlib"),u=e("../deviceinfo"),c=u.DeviceVerification,l=e("./base");s.inherits(r,l.EncryptionAlgorithm),r.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return o();var t=this;return this._prepPromise=t._crypto.downloadKeys(e).then(function(n){return t._crypto.ensureOlmSessionsForUsers(e)}).then(function(){t._sessionPrepared=!0}).finally(function(){t._prepPromise=null}),this._prepPromise},r.prototype.encryptMessage=function(e,t,n){var r=s.map(e.getJoinedMembers(),function(e){return e.userId}),i=this;return this._ensureSession(r).then(function(){for(var o={room_id:e.roomId,type:t,content:n},s={algorithm:a.OLM_ALGORITHM,sender_key:i._olmDevice.deviceCurve25519Key,ciphertext:{}},u=0;u<r.length;++u)for(var l=r[u],d=i._crypto.getStoredDevicesForUser(l),h=0;h<d.length;++h){var p=d[h],f=p.getIdentityKey();f!=i._olmDevice.deviceCurve25519Key&&(p.verified!=c.BLOCKED&&a.encryptMessageForDevice(s.ciphertext,i._userId,i._deviceId,i._olmDevice,l,p,o))}return s})},s.inherits(i,l.DecryptionAlgorithm),i.prototype.decryptEvent=function(e){var t=e.getWireContent(),n=t.sender_key,r=t.ciphertext;if(!r)throw new l.DecryptionError("Missing ciphertext");if(!(this._olmDevice.deviceCurve25519Key in r))throw new l.DecryptionError("Not included in recipients");var i=r[this._olmDevice.deviceCurve25519Key],o=void 0;try{o=this._decryptMessage(n,i)}catch(e){throw new l.DecryptionError("Bad Encrypted Message",{sender:n,err:e})}var s=JSON.parse(o);if(s.recipient!=this._userId)throw new l.DecryptionError("Message was intented for "+s.recipient);if(s.recipient_keys.ed25519!=this._olmDevice.deviceEd25519Key)throw new l.DecryptionError("Message not intended for this device",{intended:s.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});if(s.sender!=e.getSender())throw new l.DecryptionError("Message forwarded from "+s.sender,{reported_sender:e.getSender()});if(s.room_id!==e.getRoomId())throw new l.DecryptionError("Message intended for room "+s.room_id,{reported_room:e.room_id});e.setClearData(s,{curve25519:n},s.keys||{})},i.prototype._decryptMessage=function(e,t){for(var n=this._olmDevice.getSessionIdsForDevice(e),r={},i=0;i<n.length;i++){var o=n[i];try{var s=this._olmDevice.decryptMessage(e,o,t.type,t.body);return console.log("Decrypted Olm message from "+e+" with session "+o),s}catch(n){var a=this._olmDevice.matchesSession(e,o,t.type,t.body);if(a)throw new Error("Error decrypting prekey message with existing session id "+o+": "+n.message);r[o]=n.message}}if(0!==t.type){if(0===n.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(r))}var u=void 0;try{u=this._olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw r["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(r))}return console.log("created new inbound Olm session ID "+u.session_id+" with "+e),u.payload},l.registerAlgorithm(a.OLM_ALGORITHM,r,i)},{"../../utils":44,"../deviceinfo":11,"../olmlib":13,"./base":7,q:51}],11:[function(e,t,n){"use strict";function r(e){Object.defineProperty(this,"deviceId",{enumerable:!0,value:e}),this.algorithms=[],this.keys={},this.verified=i.UNVERIFIED,this.known=!1,this.unsigned={}}r.fromStorage=function(e,t){var n=new r(t);for(var i in e)e.hasOwnProperty(i)&&(n[i]=e[i]);return n},r.prototype.toStorage=function(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned}},r.prototype.getFingerprint=function(){return this.keys["ed25519:"+this.deviceId]},r.prototype.getIdentityKey=function(){return this.keys["curve25519:"+this.deviceId]},r.prototype.getDisplayName=function(){return this.unsigned.device_display_name||null},r.prototype.isBlocked=function(){return this.verified==i.BLOCKED},r.prototype.isVerified=function(){return this.verified==i.VERIFIED},r.prototype.isUnverified=function(){return this.verified==i.UNVERIFIED},r.prototype.isKnown=function(){return 1==this.known},r.DeviceVerification={VERIFIED:1,UNVERIFIED:0,BLOCKED:-1};var i=r.DeviceVerification;t.exports=r},{}],12:[function(e,t,n){"use strict";function r(e,t,n,r,o,s,a){this._baseApis=e,this._sessionStore=n,this._userId=r,this._deviceId=o,this._clientStore=s,this._cryptoStore=a,this._olmDevice=new l(n),this._deviceList=new v(e,n,this._olmDevice),this._initialDeviceListInvalidationPending=!1,this._clientRunning=!1,this._lastOneTimeKeyCheck=null,this._oneTimeKeyCheckInProgress=!1,this._roomEncryptors={},this._roomDecryptors={},this._supportedAlgorithms=c.keys(h.DECRYPTION_CLASSES),this._deviceKeys={},this._deviceKeys["ed25519:"+this._deviceId]=this._olmDevice.deviceEd25519Key,this._deviceKeys["curve25519:"+this._deviceId]=this._olmDevice.deviceCurve25519Key,this._globalBlacklistUnverifiedDevices=!1;var u=this._sessionStore.getEndToEndDevicesForUser(this._userId);if(u||(u={}),!u[this._deviceId]){var d={keys:this._deviceKeys,algorithms:this._supportedAlgorithms,verified:f.VERIFIED,known:!0};u[this._deviceId]=d,this._sessionStore.storeEndToEndDevicesForUser(this._userId,u)}i(this,t)}function i(e,t){t.on("sync",function(t,n,r){try{"STOPPED"===t?e._clientRunning=!1:"PREPARED"===t&&(e._clientRunning=!0),"SYNCING"===t&&e._onSyncCompleted(r)}catch(e){console.error("Error handling sync",e)}}),t.on("RoomMember.membership",function(t,n,r){try{e._onRoomMembership(t,n,r)}catch(e){console.error("Error handling membership change:",e)}}),t.on("toDeviceEvent",function(t){try{"m.room_key"==t.getType()?e._onRoomKeyEvent(t):"m.new_device"==t.getType()&&e._onNewDeviceEvent(t)}catch(e){console.error("Error handling toDeviceEvent:",e)}}),t.on("event",function(t){try{if(!t.isState()||"m.room.encryption"!=t.getType())return;e._onCryptoEvent(t)}catch(e){console.error("Error handling crypto event:",e)}})}function o(e){function t(r){if(!(r<=0)){var i=Math.min(r,n);return e._olmDevice.generateOneTimeKeys(i),s(e).then(function(){return t(r-i)})}}var n=5;if(!e._oneTimeKeyCheckInProgress){var r=Date.now();null!==e._lastOneTimeKeyCheck&&r-e._lastOneTimeKeyCheck<6e4||(e._lastOneTimeKeyCheck=r,e._oneTimeKeyCheckInProgress=!0,u().then(function(){return e._baseApis.uploadKeysRequest({},{device_id:e._deviceId})}).then(function(n){var r=n.one_time_key_counts.signed_curve25519||0,i=e._olmDevice.maxNumberOfOneTimeKeys(),o=Math.floor(i/2);return t(Math.max(o-r,0))}).catch(function(e){console.error("Error uploading one-time keys",e.stack||e)}).finally(function(){e._oneTimeKeyCheckInProgress=!1}).done())}}function s(e){var t=e._olmDevice.getOneTimeKeys(),n={};for(var r in t.curve25519)if(t.curve25519.hasOwnProperty(r)){var i={key:t.curve25519[r]};e._signObject(i),n["signed_curve25519:"+r]=i}return e._baseApis.uploadKeysRequest({one_time_keys:n},{device_id:e._deviceId}).then(function(t){return e._olmDevice.markKeysAsPublished(),t})}var a=e("another-json"),u=e("q"),c=e("../utils"),l=e("./OlmDevice"),d=e("./olmlib"),h=e("./algorithms"),p=e("./deviceinfo"),f=p.DeviceVerification,v=e("./DeviceList").default;r.getOlmVersion=function(){return l.getOlmVersion()},r.prototype.getDeviceEd25519Key=function(){return this._olmDevice.deviceEd25519Key},r.prototype.setGlobalBlacklistUnverifiedDevices=function(e){this._globalBlacklistUnverifiedDevices=e},r.prototype.getGlobalBlacklistUnverifiedDevices=function(){return this._globalBlacklistUnverifiedDevices},r.prototype.uploadDeviceKeys=function(){var e=this,t=e._userId,n=e._deviceId,r={algorithms:e._supportedAlgorithms,device_id:n,keys:e._deviceKeys,user_id:t};return e._signObject(r),e._baseApis.uploadKeysRequest({device_keys:r},{device_id:n})},r.prototype.downloadKeys=function(e,t){return this._deviceList.downloadKeys(e,t)},r.prototype.getStoredDevicesForUser=function(e){return this._deviceList.getStoredDevicesForUser(e)},r.prototype.getStoredDevice=function(e,t){return this._deviceList.getStoredDevice(e,t)},r.prototype.listDeviceKeys=function(e){for(var t=this.getStoredDevicesForUser(e)||[],n=[],r=0;r<t.length;++r){var i=t[r],o=i.getFingerprint();o&&n.push({id:i.deviceId,key:o,verified:Boolean(i.isVerified()),blocked:Boolean(i.isBlocked()),display_name:i.getDisplayName()})}return n.sort(function(e,t){return e.deviceId<t.deviceId?-1:e.deviceId>t.deviceId?1:0}),n},r.prototype.setDeviceVerification=function(e,t,n,r,i){var o=this._sessionStore.getEndToEndDevicesForUser(e);if(!o||!o[t])throw new Error("Unknown device "+e+":"+t);var s=o[t],a=s.verified;n?a=f.VERIFIED:null!==n&&a==f.VERIFIED&&(a=f.UNVERIFIED),r?a=f.BLOCKED:null!==r&&a==f.BLOCKED&&(a=f.UNVERIFIED);var u=s.known;return null!==i&&void 0!==i&&(u=i),s.verified===a&&s.known===u||(s.verified=a,s.known=u,this._sessionStore.storeEndToEndDevicesForUser(e,o)),p.fromStorage(s,t)},r.prototype.getOlmSessionsForUser=function(e){for(var t=this.getStoredDevicesForUser(e)||[],n={},r=0;r<t.length;++r){var i=t[r],o=i.getIdentityKey(),s=this._olmDevice.getSessionInfoForDevice(o);n[i.deviceId]={deviceIdKey:o,sessions:s}}return n},r.prototype.getEventSenderDeviceInfo=function(e){var t=e.getSenderKey(),n=e.getWireContent().algorithm;if(!t||!n)return null;var r=this._deviceList.getDeviceByIdentityKey(e.getSender(),n,t);if(null===r)return null;var i=e.getKeysClaimed().ed25519;return i?i!==r.getFingerprint()?(console.warn("Event "+e.getId()+" claims ed25519 key "+i+"but sender device has key "+r.getFingerprint()),null):r:(console.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)},r.prototype.setRoomEncryption=function(e,t,n){var r=this,i=this._sessionStore.getEndToEndRoom(e);if(i&&JSON.stringify(i)!=JSON.stringify(t))return void console.error("Ignoring m.room.encryption event which requests a change of config in "+e);var o=h.ENCRYPTION_CLASSES[t.algorithm];if(!o)throw new Error("Unable to encrypt with "+t.algorithm);this._sessionStore.storeEndToEndRoom(e,t);var s=new o({userId:this._userId,deviceId:this._deviceId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e,config:t});this._roomEncryptors[e]=s,console.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),this._clientStore.getRoom(e).getJoinedMembers().forEach(function(e){r._deviceList.startTrackingDeviceList(e.userId)}),n||this._deviceList.refreshOutdatedDeviceLists()},r.prototype.ensureOlmSessionsForUsers=function(e){for(var t={},n=0;n<e.length;++n){var r=e[n];t[r]=[];for(var i=this.getStoredDevicesForUser(r)||[],o=0;o<i.length;++o){var s=i[o];s.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(s.verified!=f.BLOCKED&&t[r].push(s))}}return d.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t)},r.prototype.isRoomEncrypted=function(e){return Boolean(this._roomEncryptors[e])},r.prototype.exportRoomKeys=function(){var e=this;return u(this._sessionStore.getAllEndToEndInboundGroupSessionKeys().map(function(t){var n=e._olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId);return n.algorithm=d.MEGOLM_ALGORITHM,n}))},r.prototype.importRoomKeys=function(e){var t=this;e.map(function(e){if(!e.room_id||!e.algorithm)return void console.warn("ignoring session entry with missing fields",e);t._getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e)})},r.prototype.encryptEventIfNeeded=function(e,t){if(e.isEncrypted())return null;if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");var n=e.getRoomId(),r=this._roomEncryptors[n];if(!r){if(this._sessionStore.getEndToEndRoom(n))throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");return null}var i={curve25519:this._olmDevice.deviceCurve25519Key,ed25519:this._olmDevice.deviceEd25519Key};return r.encryptMessage(t,e.getType(),e.getContent()).then(function(t){e.makeEncrypted("m.room.encrypted",t,i)})},r.prototype.decryptEvent=function(e){var t=e.getWireContent();this._getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)},r.prototype.userDeviceListChanged=function(e){this._deviceList.invalidateUserDeviceList(e)},r.prototype._onCryptoEvent=function(e){var t=e.getRoomId(),n=e.getContent();try{this.setRoomEncryption(t,n,!0)}catch(e){console.error("Error configuring encryption in room "+t+":",e)}},r.prototype._onSyncCompleted=function(e){var t=this,n=e.nextSyncToken;if(!e.oldSyncToken){console.log("Completed initial sync"),this._sendNewDeviceEvents();var r=this._sessionStore.getEndToEndDeviceSyncToken();null!==r?(this._initialDeviceListInvalidationPending=!0,this._invalidateDeviceListsSince(r,n).catch(function(e){console.warn("Error fetching changed device list",e),t._deviceList.invalidateAllDeviceLists()}).done(function(){t._initialDeviceListInvalidationPending=!1,t._deviceList.lastKnownSyncToken=n,t._deviceList.refreshOutdatedDeviceLists()})):(console.log("Completed first initialsync; invalidating all device list caches"),this._deviceList.invalidateAllDeviceLists())}this._initialDeviceListInvalidationPending||this._sessionStore.storeEndToEndDeviceSyncToken(n),this._deviceList.lastKnownSyncToken=n,this._deviceList.refreshOutdatedDeviceLists(),e.catchingUp||o(this)},r.prototype._sendNewDeviceEvents=function(){if(!this._sessionStore.getDeviceAnnounced()){var e={},t=!0,n=!1,r=void 0;try{for(var i,o=this._getE2eRooms()[Symbol.iterator]();!(t=(i=o.next()).done);t=!0)for(var s=i.value,a=s.getJoinedMembers(),u=0;u<a.length;u++){var c=a[u];e[c.userId]||(e[c.userId]=[]),e[c.userId].push(s.roomId)}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}var l={};for(var d in e)e.hasOwnProperty(d)&&(l[d]={"*":{device_id:this._deviceId,rooms:e[d]}});var h=this;this._baseApis.sendToDevice("m.new_device",l).done(function(){h._sessionStore.setDeviceAnnounced()})}},r.prototype._invalidateDeviceListsSince=function(e,t){var n=this;return this._baseApis.getKeyChanges(e,t).then(function(t){console.log("got key changes since",e,":",t.changed),t.changed&&Array.isArray(t.changed)&&t.changed.forEach(function(e){n._deviceList.invalidateUserDeviceList(e)})})},r.prototype._getE2eRooms=function(){var e=this;return this._clientStore.getRooms().filter(function(t){if(!e._roomEncryptors[t.roomId])return!1;var n=t.getMember(e._userId);return!(!n||"join"!==n.membership&&"invite"!==n.membership)})},r.prototype._onRoomKeyEvent=function(e){var t=e.getContent();if(!t.room_id||!t.algorithm)return void console.error("key event is missing fields");this._getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)},r.prototype._onRoomMembership=function(e,t,n){var r=t.roomId,i=this._roomEncryptors[r];i&&("join"==t.membership&&(console.log("Join event for "+t.userId+" in "+r),this._deviceList.startTrackingDeviceList(t.userId)),i.onRoomMembership(e,t,n))},r.prototype._onNewDeviceEvent=function(e){var t=e.getContent(),n=e.getSender(),r=t.device_id,i=t.rooms;return i&&r?(console.log("m.new_device event from "+n+":"+r+" for rooms "+i),this.getStoredDevice(n,r)?void console.log("Known device; ignoring"):void this._deviceList.invalidateUserDeviceList(n)):void console.warn("new_device event missing keys")},r.prototype._getRoomDecryptor=function(e,t){var n=void 0,r=void 0;if((e=e||null)&&(n=this._roomDecryptors[e],n||(this._roomDecryptors[e]=n={}),r=n[t]))return r;var i=h.DECRYPTION_CLASSES[t];if(!i)throw new h.DecryptionError('Unknown encryption algorithm "'+t+'".');return r=new i({userId:this._userId,crypto:this,olmDevice:this._olmDevice,roomId:e}),n&&(n[t]=r),r},r.prototype._signObject=function(e){var t={};t[this._userId]={},t[this._userId]["ed25519:"+this._deviceId]=this._olmDevice.sign(a.stringify(e)),e.signatures=t},t.exports=r},{"../utils":44,"./DeviceList":5,"./OlmDevice":6,"./algorithms":8,"./deviceinfo":11,"./olmlib":13,"another-json":46,q:51}],13:[function(e,t,n){"use strict";function r(e,t,n,r){var i=r.deviceId;try{a(e,t,n,i,r.getFingerprint())}catch(e){return console.error("Unable to verify signature on one-time key for device "+n+":"+i+":",e),null}var o=void 0;try{o=e.createOutboundSession(r.getIdentityKey(),t.key)}catch(e){return console.error("Error starting session with device "+n+":"+i+": "+e),null}return console.log("Started new sessionid "+o+" for device "+n+":"+i),o}var i=e("q"),o=e("another-json"),s=e("../utils");t.exports.OLM_ALGORITHM="m.olm.v1.curve25519-aes-sha2",t.exports.MEGOLM_ALGORITHM="m.megolm.v1.aes-sha2",t.exports.encryptMessageForDevice=function(e,t,n,r,i,o,a){var u=o.getIdentityKey(),c=r.getSessionIdForDevice(u);if(null!==c){console.log("Using sessionid "+c+" for device "+i+":"+o.deviceId);var l={sender:t,sender_device:n,keys:{ed25519:r.deviceEd25519Key},recipient:i,recipient_keys:{ed25519:o.getFingerprint()}};s.extend(l,a),e[u]=r.encryptMessage(u,c,JSON.stringify(l))}},t.exports.ensureOlmSessionsForDevices=function(e,t,n){var o=[],s={};for(var a in n)if(n.hasOwnProperty(a)){s[a]={};for(var u=n[a],c=0;c<u.length;c++){var l=u[c],d=l.deviceId,h=l.getIdentityKey(),p=e.getSessionIdForDevice(h);null===p&&o.push([a,d]),s[a][d]={device:l,sessionId:p}}}if(0===o.length)return i(s);return t.claimOneTimeKeys(o,"signed_curve25519").then(function(t){var i=t.one_time_keys||{};for(var o in n)if(n.hasOwnProperty(o))for(var a=i[o]||{},u=n[o],c=0;c<u.length;c++){var l=u[c],d=l.deviceId;if(!s[o][d].sessionId){var h=a[d]||{},p=null;for(var f in h)0===f.indexOf("signed_curve25519:")&&(p=h[f]);if(p){var v=r(e,p,o,l);s[o][d].sessionId=v}else console.warn("No one-time keys (alg=signed_curve25519) for device "+o+":"+d)}}return s})};var a=t.exports.verifySignature=function(e,t,n,r,i){var s="ed25519:"+r,a=t.signatures||{},u=a[n]||{},c=u[s];if(!c)throw Error("No signature");delete t.unsigned,delete t.signatures;var l=o.stringify(t);e.verifySignature(i,l,c)}},{"../utils":44,"another-json":46,q:51}],14:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){var t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=e("q"),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(t,n){if(r(this,e),!t)throw new Error("must pass indexedDB into IndexedDBCryptoStore");this._indexedDB=t,this._dbName=n,this._dbPromise=null}return o(e,[{key:"connect",value:function(){var e=this;return this._dbPromise?this._dbPromise:(this._dbPromise=new a.default.Promise(function(t,n){console.log("connecting to indexeddb "+e._dbName);var r=e._indexedDB.open(e._dbName,1);r.onupgradeneeded=function(e){var t=e.target.result,n=e.oldVersion;console.log("Upgrading IndexedDBCryptoStore from version "+n+" to 1"),n<1&&i(t)},r.onblocked=function(){console.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=function(e){n(new Error("unable to connect to indexeddb: "+e.target.error))},r.onsuccess=function(e){var n=e.target.result;n.onversionchange=function(e){n.close()},t(n)}}),this._dbPromise)}},{key:"deleteAllData",value:function(){var e=this;return new a.default.Promise(function(t,n){console.log("Removing indexeddb instance: "+e._dbName);var r=e._indexedDB.deleteDatabase(e._dbName);r.onblocked=function(){console.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=function(e){console.warn("unable to delete IndexedDBCryptoStore: "+e.target.error),t()},r.onsuccess=function(){console.log("Removed indexeddb instance: "+e._dbName),t()}})}}]),e}();n.default=u},{q:51}],15:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=e("q"),s=function(e){return e&&e.__esModule?e:{default:e}}(o),a=function(){function e(){r(this,e)}return i(e,[{key:"deleteAllData",value:function(){return(0,s.default)()}}]),e}();n.default=a},{q:51}],16:[function(e,t,n){"use strict";function r(e,t){if(t.endsWith("*")){var n=t.slice(0,-1);return e.substr(0,n.length)===n}return e===t}function i(e){this.filter_json=e,this.types=e.types||null,this.not_types=e.not_types||[],this.rooms=e.rooms||null,this.not_rooms=e.not_rooms||[],this.senders=e.senders||null,this.not_senders=e.not_senders||[],this.contains_url=e.contains_url||null}i.prototype.check=function(e){return this._checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)},i.prototype._checkFields=function(e,t,n,i){var o={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return r(n,e)}},s=this;Object.keys(o).forEach(function(e){var t=o[e];if(s["not_"+e].map(t))return!1;var n=s[e];return!(n&&!n.map(t))&&void 0});var a=this.filter_json.contains_url;return void 0===a||a===i},i.prototype.filter=function(e){return e.filter(this.check,this)},i.prototype.limit=function(){return void 0!==this.filter_json.limit?this.filter_json.limit:10},t.exports=i},{}],17:[function(e,t,n){"use strict";function r(e,t,n){for(var r=t.split("."),i=e,o=0;o<r.length-1;o++)i[r[o]]||(i[r[o]]={}),i=i[r[o]];i[r[r.length-1]]=n}function i(e,t){this.userId=e,this.filterId=t,this.definition={}}var o=e("./filter-component");i.prototype.getFilterId=function(){return this.filterId},i.prototype.getDefinition=function(){return this.definition},i.prototype.setDefinition=function(e){this.definition=e;var t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms),this._include_leave=t.include_leave||!1),this._room_filter=new o(n),this._room_timeline_filter=new o(t?t.timeline||{}:{})},i.prototype.getRoomTimelineFilterComponent=function(){return this._room_timeline_filter},i.prototype.filterRoomTimeline=function(e){return this._room_timeline_filter.filter(this._room_filter.filter(e))},i.prototype.setTimelineLimit=function(e){r(this.definition,"room.timeline.limit",e)},i.prototype.setIncludeLeaveRooms=function(e){r(this.definition,"room.include_leave",e)},i.fromJson=function(e,t,n){var r=new i(e,t);return r.setDefinition(n),r},t.exports=i},{"./filter-component":16}],18:[function(e,t,n){(function(n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=e("q"),o=e("./utils"),s=e("./realtime-callbacks");t.exports.PREFIX_R0="/_matrix/client/r0",t.exports.PREFIX_UNSTABLE="/_matrix/client/unstable",t.exports.PREFIX_IDENTITY_V1="/_matrix/identity/api/v1",t.exports.PREFIX_MEDIA_R0="/_matrix/media/r0",t.exports.MatrixHttpApi=function(e,t){o.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.uploads=[]},t.exports.MatrixHttpApi.prototype={getContentUri:function(){var e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/v1/upload",params:e}},uploadContent:function(e,t){o.isFunction(t)?t={callback:t}:void 0===t&&(t={});var r=t.type||e.type||"application/octet-stream",u=t.name||e.name,c=e.stream?e.stream:e,l=t.rawResponse;void 0===l&&(n.XMLHttpRequest?l=!1:(console.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),l=!0));var d=t.onlyContentUri;l||void 0!==d||(n.XMLHttpRequest?(console.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),d=!0):d=!1);var h={loaded:0,total:0},p=void 0,f=null;if(l||(f=function(e){var t=JSON.parse(e);if(d&&void 0===(t=t.content_uri))throw Error("Bad response");return t}),n.XMLHttpRequest){var v=i.defer(),m=new n.XMLHttpRequest;h.xhr=m;var y=a(v,t.callback,this.opts.onlyData),g=function(){m.abort(),y(new Error("Timeout"))};m.timeout_timer=s.setTimeout(g,3e4),m.onreadystatechange=function(){switch(m.readyState){case n.XMLHttpRequest.DONE:s.clearTimeout(m.timeout_timer);var e;try{if(!m.responseText)throw new Error("No response body.");e=m.responseText,f&&(e=f(e))}catch(e){return e.http_status=m.status,void y(e)}y(void 0,m,e)}},m.upload.addEventListener("progress",function(e){s.clearTimeout(m.timeout_timer),h.loaded=e.loaded,h.total=e.total,m.timeout_timer=s.setTimeout(g,3e4),v.notify(e)});var _=this.opts.baseUrl+"/_matrix/media/v1/upload";_+="?access_token="+encodeURIComponent(this.opts.accessToken),_+="&filename="+encodeURIComponent(u),m.open("POST",_),m.setRequestHeader("Content-Type",r),m.send(c),p=v.promise,p.abort=m.abort.bind(m)}else{var S={filename:u};p=this.authedRequest(t.callback,"POST","/upload",S,c,{prefix:"/_matrix/media/v1",headers:{"Content-Type":r},json:!1,bodyParser:f})}var E=this,b=p.finally(function(){for(var e=0;e<E.uploads.length;++e)if(E.uploads[e]===h)return void E.uploads.splice(e,1)});return b.abort=p.abort,h.promise=b,this.uploads.push(h),b},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,n,s,u){var c=this.opts.idBaseUrl+u+n;if(void 0!==e&&!o.isFunction(e))throw Error("Expected callback to be a function but got "+(void 0===e?"undefined":r(e)));var l={uri:c,method:t,withCredentials:!1,json:!1,_matrix_opts:this.opts};"GET"==t?l.qs=s:l.form=s;var d=i.defer();return this.opts.request(l,a(d,e,this.opts.onlyData)),d.promise.then(function(e){return JSON.parse(e)})},authedRequest:function(e,t,n,r,i,o){r||(r={}),r.access_token||(r.access_token=this.opts.accessToken);var s=this.request(e,t,n,r,i,o),a=this;return s.catch(function(e){"M_UNKNOWN_TOKEN"==e.errcode&&a.event_emitter.emit("Session.logged_out")}),s},request:function(e,t,n,r,i,o){o=o||{};var s=void 0!==o.prefix?o.prefix:this.opts.prefix,a=this.opts.baseUrl+s+n;return this.requestOtherUrl(e,t,a,r,i,o)},authedRequestWithPrefix:function(e,t,n,r,i,o,s){return this.authedRequest(e,t,n,r,i,{localTimeoutMs:s,prefix:o})},requestWithPrefix:function(e,t,n,r,i,o,s){return this.request(e,t,n,r,i,{localTimeoutMs:s,prefix:o})},requestOtherUrl:function(e,t,n,r,i,o){return void 0===o||null===o?o={}:isFinite(o)&&(o={localTimeoutMs:o}),this._request(e,t,n,r,i,o)},getUrl:function(e,t,n){var r="";return t&&(r="?"+o.encodeParams(t)),this.opts.baseUrl+n+e+r},_request:function(e,n,u,c,l,d){if(void 0!==e&&!o.isFunction(e))throw Error("Expected callback to be a function but got "+(void 0===e?"undefined":r(e)));d=d||{};var h=this;if(this.opts.extraParams)for(var p in this.opts.extraParams)this.opts.extraParams.hasOwnProperty(p)&&(c[p]=this.opts.extraParams[p]);var f=void 0===d.json||d.json,v=i.defer(),m=void 0,y=!1,g=void 0,_=d.localTimeoutMs||this.opts.localTimeoutMs,S=function(){_&&(m&&s.clearTimeout(m),m=s.setTimeout(function(){y=!0,g&&g.abort&&g.abort(),v.reject(new t.exports.MatrixError({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:_}))},_))};S();var E=v.promise;try{g=this.opts.request({uri:u,method:n,withCredentials:!1,qs:c,body:l,json:f,timeout:_,headers:d.headers||{},_matrix_opts:this.opts},function(t,n,r){if(!_||(s.clearTimeout(m),!y)){var i=!f;a(v,e,h.opts.onlyData,i,d.bodyParser)(t,n,r)}}),g&&("onprogress"in g&&(g.onprogress=function(e){S()}),g.abort&&(E.abort=g.abort.bind(g)))}catch(t){v.reject(t),e&&e(t)}return E}};var a=function(e,n,r,i,o){return n=n||function(){},function(s,a,u){if(!s){try{a.statusCode>=400?(i&&(u=JSON.parse(u)),s=new t.exports.MatrixError(u)):o&&(u=o(u))}catch(e){s=e}s&&(s.httpStatus=a.statusCode)}if(s)e.reject(s),n(s);else{var c={code:a.statusCode,headers:a.headers,data:u};e.resolve(r?u:c),n(null,r?u:c)}}};t.exports.MatrixError=function(e){e=e||{},this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e},t.exports.MatrixError.prototype=Object.create(Error.prototype),t.exports.MatrixError.prototype.constructor=t.exports.MatrixError}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./realtime-callbacks":32,"./utils":44,q:51}],19:[function(e,t,n){"use strict";function r(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._completionDeferred=null,this._inputs=e.inputs||{},e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._currentStage=null}var i=e("q"),o=e("url"),s=e("./utils");r.prototype={attemptAuth:function(){var e=this;return this._completionDeferred=i.defer(),i().then(function(){return e._data.flows?e._startNextAuthStage():e._doRequest(e._data),e._completionDeferred.promise})},poll:function(){if(this._data.session){var e={};if("m.login.email.identity"==this._currentStage&&this._emailSid){var t=o.parse(this._matrixClient.getIdentityServerUrl());e={type:"m.login.email.identity",threepid_creds:{sid:this._emailSid,client_secret:this._clientSecret,id_server:t.host}}}
this.submitAuthDict(e,!0)}},getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){var t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},submitAuthDict:function(e,t){if(!this._completionDeferred)throw new Error("submitAuthDict() called before attemptAuth()");var n={session:this._data.session};s.extend(n,e),this._doRequest(n,t)},getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:function(e,t){var n=this,r=void 0;try{r=this._requestCallback(e,t)}catch(e){r=i.reject(e)}r=r.then(function(e){console.log("result from request: ",e),n._completionDeferred.resolve(e)},function(e){var t=e.data?e.data.flows:null,r=Boolean(n._data.flows)||Boolean(t);if(401!==e.httpStatus||!e.data||!r)throw e;e.data.flows||e.data.completed||e.data.session||(e.data.flows=n._data.flows,e.data.completed=n._data.completed,e.data.session=n._data.session),n._data=e.data,n._startNextAuthStage()}),r=t?r.catch(function(e){console.log("Ignoring error from UI auth: "+e)}):r.catch(this._completionDeferred.reject),r.done()},_startNextAuthStage:function(){var e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"==e)return void this.submitAuthDict({type:"m.login.dummy"});if(this._data.errcode||this._data.error)return void this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});var t={};"m.login.email.identity"==e&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)},_chooseStage:function(){var e=this._chooseFlow();console.log("Active flow => %s",JSON.stringify(e));var t=this._firstUncompletedStage(e);return console.log("Next stage: %s",t),t},_chooseFlow:function(){var e=this._data.flows||[],t=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),n=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber),r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var u=s.value,c=!1,l=!1,d=!0,h=!1,p=void 0;try{for(var f,v=u.stages[Symbol.iterator]();!(d=(f=v.next()).done);d=!0){var m=f.value;"m.login.email.identity"===m?c=!0:"m.login.msisdn"==m&&(l=!0)}}catch(y){h=!0,p=y}finally{try{!d&&v.return&&v.return()}finally{if(h)throw p}}if(c==t&&l==n)return u}}catch(y){i=!0,o=y}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}var y=new Error("No appropriate authentication flow found");throw y.name="NoAuthFlowFoundError",y.required_stages=[],t&&y.required_stages.push("m.login.email.identity"),n&&y.required_stages.push("m.login.msisdn"),y.available_flows=e,y},_firstUncompletedStage:function(e){for(var t=(this._data||{}).completed||[],n=0;n<e.stages.length;++n){var r=e.stages[n];if(-1===t.indexOf(r))return r}}},t.exports=r},{"./utils":44,q:51,url:55}],20:[function(e,t,n){(function(n){"use strict";t.exports.MatrixEvent=e("./models/event").MatrixEvent,t.exports.EventStatus=e("./models/event").EventStatus,t.exports.MatrixInMemoryStore=e("./store/memory").MatrixInMemoryStore,t.exports.IndexedDBStore=e("./store/indexeddb").IndexedDBStore,t.exports.IndexedDBStoreBackend=e("./store/indexeddb").IndexedDBStoreBackend,t.exports.SyncAccumulator=e("./sync-accumulator"),t.exports.MatrixHttpApi=e("./http-api").MatrixHttpApi,t.exports.MatrixError=e("./http-api").MatrixError,t.exports.MatrixClient=e("./client").MatrixClient,t.exports.Room=e("./models/room"),t.exports.EventTimeline=e("./models/event-timeline"),t.exports.EventTimelineSet=e("./models/event-timeline-set"),t.exports.RoomMember=e("./models/room-member"),t.exports.RoomState=e("./models/room-state"),t.exports.User=e("./models/user"),t.exports.MatrixScheduler=e("./scheduler"),t.exports.WebStorageSessionStore=e("./store/session/webstorage"),t.exports.CRYPTO_ENABLED=e("./client").CRYPTO_ENABLED,t.exports.ContentRepo=e("./content-repo"),t.exports.Filter=e("./filter"),t.exports.TimelineWindow=e("./timeline-window").TimelineWindow,t.exports.InteractiveAuth=e("./interactive-auth"),t.exports.MemoryCryptoStore=e("./crypto/store/memory-crypto-store").default,t.exports.IndexedDBCryptoStore=e("./crypto/store/indexeddb-crypto-store").default,t.exports.createNewMatrixCall=e("./webrtc/call").createNewMatrixCall,t.exports.setMatrixCallAudioInput=e("./webrtc/call").setAudioInput,t.exports.setMatrixCallVideoInput=e("./webrtc/call").setVideoInput;var r=void 0;t.exports.request=function(e){r=e},t.exports.getRequest=function(){return r},t.exports.wrapRequest=function(e){var t=r;r=function(n,r){return e(t,n,r)}};var i=function(){return new t.exports.MemoryCryptoStore};t.exports.setCryptoStoreFactory=function(e){i=e},t.exports.createClient=function(e){return"string"==typeof e&&(e={baseUrl:e}),e.request=e.request||r,e.store=e.store||new t.exports.MatrixInMemoryStore({localStorage:n.localStorage}),e.scheduler=e.scheduler||new t.exports.MatrixScheduler,e.cryptoStore=e.cryptoStore||i(),new t.exports.MatrixClient(e)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./client":3,"./content-repo":4,"./crypto/store/indexeddb-crypto-store":14,"./crypto/store/memory-crypto-store":15,"./filter":17,"./http-api":18,"./interactive-auth":19,"./models/event":24,"./models/event-timeline":23,"./models/event-timeline-set":22,"./models/room":28,"./models/room-member":25,"./models/room-state":26,"./models/user":30,"./scheduler":34,"./store/indexeddb":37,"./store/memory":38,"./store/session/webstorage":39,"./sync-accumulator":41,"./timeline-window":43,"./webrtc/call":45}],21:[function(e,t,n){"use strict";function r(e){this._timeline=[e],this._ourEventIndex=0,this._paginateTokens={b:null,f:null},this._paginateRequests={b:null,f:null}}r.prototype.getEvent=function(){return this._timeline[this._ourEventIndex]},r.prototype.getTimeline=function(){return this._timeline},r.prototype.getOurEventIndex=function(){return this._ourEventIndex},r.prototype.getPaginateToken=function(e){return this._paginateTokens[e?"b":"f"]},r.prototype.setPaginateToken=function(e,t){this._paginateTokens[t?"b":"f"]=e},r.prototype.addEvents=function(e,t){t?(this._timeline=e.concat(this._timeline),this._ourEventIndex+=e.length):this._timeline=this._timeline.concat(e)},t.exports=r},{}],22:[function(e,t,n){"use strict";function r(e,t){this.room=e,this._timelineSupport=Boolean(t.timelineSupport),this._liveTimeline=new s(this),this._timelines=[this._liveTimeline],this._eventIdToTimeline={},this._filter=t.filter||null}var i=e("events").EventEmitter,o=e("../utils"),s=e("./event-timeline"),a=void 0;a=console.log.bind(console),o.inherits(r,i),r.prototype.getFilter=function(){return this._filter},r.prototype.setFilter=function(e){this._filter=e},r.prototype.getPendingEvents=function(){return this.room?this._filter?this._filter.filterRoomTimeline(this.room.getPendingEvents()):this.room.getPendingEvents():[]},r.prototype.getLiveTimeline=function(){return this._liveTimeline},r.prototype.eventIdToTimeline=function(e){return this._eventIdToTimeline[e]},r.prototype.replaceEventId=function(e,t){var n=this._eventIdToTimeline[e];n&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=n)},r.prototype.resetLiveTimeline=function(e,t){var n=!this._timelineSupport||t,r=void 0;n?(r=new s(this),this._timelines=[r],this._eventIdToTimeline={}):r=this.addTimeline();var i=this._liveTimeline.getState(s.FORWARDS).events,o=[];for(var a in i)if(i.hasOwnProperty(a))for(var u in i[a])i[a].hasOwnProperty(u)&&o.push(i[a][u]);r.initialiseState(o),r.setPaginationToken(e,s.BACKWARDS),this._liveTimeline=r,this.emit("Room.timelineReset",this.room,this,n)},r.prototype.getTimelineForEvent=function(e){var t=this._eventIdToTimeline[e];return void 0===t?null:t},r.prototype.findEventById=function(e){var t=this.getTimelineForEvent(e);if(t)return o.findElement(t.getEvents(),function(t){return t.getId()==e})},r.prototype.addTimeline=function(){if(!this._timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new s(this);return this._timelines.push(e),e},r.prototype.addEventsToTimeline=function(e,t,n,r){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this._liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!this._filter||(e=this._filter.filterRoomTimeline(e),e.length)){for(var i=t?s.BACKWARDS:s.FORWARDS,o=t?s.FORWARDS:s.BACKWARDS,u=!1,c=!1,l=0;l<e.length;l++){var d=e[l],h=d.getId(),p=this._eventIdToTimeline[h];if(p)if(c=!1,p!=n){var f=n.getNeighbouringTimeline(i);f?(a(p==f?"Event "+h+" in neighbouring timeline - switching to "+p:"Event "+h+" already in a different timeline "+p),n=p):(console.info("Already have timeline for "+h+" - joining timeline "+n+" to "+p),n.setNeighbouringTimeline(p,i),p.setNeighbouringTimeline(n,o),n=p,u=!0)}else a("Event "+h+" already in timeline "+n);else this.addEventToTimeline(d,n,t),c=!0,u=!0}!c&&u||n.setPaginationToken(r,i)}},r.prototype.addLiveEvent=function(e,t){if(this._filter){if(!this._filter.filterRoomTimeline([e]).length)return}var n=this._eventIdToTimeline[e.getId()];if(n)if("replace"===t){a("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var r=n.getEvents(),i=0;i<r.length;i++)if(r[i].getId()===e.getId()){s.setEventMetadata(e,n.getState(s.FORWARDS),!1),r[i].encryptedType||(r[i]=e);break}}else a("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this._liveTimeline,!1)},r.prototype.addEventToTimeline=function(e,t,n){var r=e.getId();t.addEvent(e,n),this._eventIdToTimeline[r]=t;var i={timeline:t,liveEvent:!n&&t==this._liveTimeline};this.emit("Room.timeline",e,this.room,Boolean(n),!1,i)},r.prototype.handleRemoteEcho=function(e,t,n){var r=this._eventIdToTimeline[t];r?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[n]=r):this._filter?this._filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this._liveTimeline,!1):this.addEventToTimeline(e,this._liveTimeline,!1)},r.prototype.removeEvent=function(e){var t=this._eventIdToTimeline[e];if(!t)return null;var n=t.removeEvent(e);if(n){delete this._eventIdToTimeline[e];var r={timeline:t};this.emit("Room.timeline",n,this.room,void 0,!0,r)}return n},r.prototype.compareEventOrdering=function(e,t){if(e==t)return 0;var n=this._eventIdToTimeline[e],r=this._eventIdToTimeline[t];if(void 0===n)return null;if(void 0===r)return null;if(n===r){for(var i=void 0,o=void 0,a=n.getEvents(),u=0;u<a.length&&(void 0===i||void 0===o);u++){var c=a[u].getId();c==e&&(i=u),c==t&&(o=u)}return i-o}for(var l=n;l;){if(l===r)return-1;l=l.getNeighbouringTimeline(s.FORWARDS)}for(l=n;l;){if(l===r)return 1;l=l.getNeighbouringTimeline(s.BACKWARDS)}return null},t.exports=r},{"../utils":44,"./event-timeline":23,events:48}],23:[function(e,t,n){"use strict";function r(e){this._eventTimelineSet=e,this._roomId=e.room?e.room.roomId:null,this._events=[],this._baseIndex=0,this._startState=new i(this._roomId),this._startState.paginationToken=null,this._endState=new i(this._roomId),this._endState.paginationToken=null,this._prevTimeline=null,this._nextTimeline=null,this._paginationRequests={b:null,f:null},this._name=this._roomId+":"+(new Date).toISOString()}var i=e("./room-state"),o=e("../utils"),s=e("./event").MatrixEvent;r.BACKWARDS="b",r.FORWARDS="f",r.prototype.initialiseState=function(e){if(this._events.length>0)throw new Error("Cannot initialise state after events are added");var t=o.map(o.deepCopy(e.map(function(e){return e.event})),function(e){return new s(e)});this._startState.setStateEvents(t),this._endState.setStateEvents(e)},r.prototype.getRoomId=function(){return this._roomId},r.prototype.getFilter=function(){return this._eventTimelineSet.getFilter()},r.prototype.getTimelineSet=function(){return this._eventTimelineSet},r.prototype.getBaseIndex=function(){return this._baseIndex},r.prototype.getEvents=function(){return this._events},r.prototype.getState=function(e){if(e==r.BACKWARDS)return this._startState;if(e==r.FORWARDS)return this._endState;throw new Error("Invalid direction '"+e+"'")},r.prototype.getPaginationToken=function(e){return this.getState(e).paginationToken},r.prototype.setPaginationToken=function(e,t){this.getState(t).paginationToken=e},r.prototype.getNeighbouringTimeline=function(e){if(e==r.BACKWARDS)return this._prevTimeline;if(e==r.FORWARDS)return this._nextTimeline;throw new Error("Invalid direction '"+e+"'")},r.prototype.setNeighbouringTimeline=function(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour");if(t==r.BACKWARDS)this._prevTimeline=e;else{if(t!=r.FORWARDS)throw new Error("Invalid direction '"+t+"'");this._nextTimeline=e}this.setPaginationToken(null,t)},r.prototype.addEvent=function(e,t){var n=t?this._startState:this._endState,i=this.getTimelineSet();i.room&&i.room.getUnfilteredTimelineSet()===i&&(r.setEventMetadata(e,n,t),e.isState()&&(n.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||r.setEventMetadata(e,n,t)));var o=void 0;o=t?0:this._events.length,this._events.splice(o,0,e),t&&this._baseIndex++},r.setEventMetadata=function(e,t,n){e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&n&&(e.forwardLooking=!1)},r.prototype.removeEvent=function(e){for(var t=this._events.length-1;t>=0;t--){var n=this._events[t];if(n.getId()==e)return this._events.splice(t,1),t<this._baseIndex&&this._baseIndex--,n}return null},r.prototype.toString=function(){return this._name},t.exports=r},{"../utils":44,"./event":24,"./room-state":26}],24:[function(e,t,n){"use strict";var r=e("events").EventEmitter,i=e("../utils.js");t.exports.EventStatus={NOT_SENT:"not_sent",ENCRYPTING:"encrypting",SENDING:"sending",QUEUED:"queued",SENT:"sent",CANCELLED:"cancelled"};var o={};t.exports.MatrixEvent=function(e){["state_key","type","sender","room_id"].forEach(function(t){e[t]&&(o[e[t]]||(o[e[t]]=e[t]),e[t]=o[e[t]])}),["membership","avatar_url","displayname"].forEach(function(t){e.content&&e.content[t]&&(o[e.content[t]]||(o[e.content[t]]=e.content[t]),e.content[t]=o[e.content[t]])}),this.event=e||{},this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,this._pushActions=null,this._date=this.event.origin_server_ts?new Date(this.event.origin_server_ts):null,this._clearEvent={},this._keysProved={},this._keysClaimed={}},i.inherits(t.exports.MatrixEvent,r),i.extend(t.exports.MatrixEvent.prototype,{getId:function(){return this.event.event_id},getSender:function(){return this.event.sender||this.event.user_id},getType:function(){return this._clearEvent.type||this.event.type},getWireType:function(){return this.event.type},getRoomId:function(){return this.event.room_id},getTs:function(){return this.event.origin_server_ts},getDate:function(){return this._date},getContent:function(){return this._clearEvent.content||this.event.content||{}},getWireContent:function(){return this.event.content||{}},getPrevContent:function(){return this.getUnsigned().prev_content||this.event.prev_content||{}},getDirectionalContent:function(){return this.forwardLooking?this.getContent():this.getPrevContent()},getAge:function(){return this.getUnsigned().age||this.event.age},getStateKey:function(){return this.event.state_key},isState:function(){return void 0!==this.event.state_key},makeEncrypted:function(e,t,n){this._clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this._keysProved=n,this._keysClaimed=n},setClearData:function(e,t,n){this._clearEvent=e,this._keysProved=t||{},this._keysClaimed=n||{},this.emit("Event.decrypted",this)},isEncrypted:function(){return"m.room.encrypted"===this.event.type},getSenderKey:function(){return this.getKeysProved().curve25519||null},getKeysProved:function(){return this._keysProved},getKeysClaimed:function(){return this._keysClaimed},getUnsigned:function(){return this.event.unsigned||{}},makeRedacted:function(e){if(!e.event)throw new Error("invalid redaction_event in makeRedacted");this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;var t=void 0;for(t in this.event)this.event.hasOwnProperty(t)&&(s[t]||delete this.event[t]);var n=a[this.getType()]||{},r=this.getContent();for(t in r)r.hasOwnProperty(t)&&(n[t]||delete r[t])},isRedacted:function(){return Boolean(this.getUnsigned().redacted_because)},getPushActions:function(){return this._pushActions},setPushActions:function(e){this._pushActions=e},handleRemoteEcho:function(e){this.event=e,this.status=null,this._date=new Date(this.event.origin_server_ts)}});var s=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce(function(e,t){return e[t]=1,e},{}),a={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},{"../utils.js":44,events:48}],25:[function(e,t,n){"use strict";function r(e,t){this.roomId=e,this.userId=t,this.typing=!1,this.name=t,this.powerLevel=0,this.powerLevelNorm=0,this.user=null,this.membership=null,this.events={member:null},this._updateModifiedTime()}function i(e,t,n){var r=t.getDirectionalContent().displayname,i=e.userId;return r?n&&n.getUserIdsWithDisplayName(r).filter(function(e){return e!==i}).length>0?r+" ("+i+")":r:i}var o=e("events").EventEmitter,s=e("../content-repo"),a=e("../utils");a.inherits(r,o),r.prototype.setMembershipEvent=function(e,t){if("m.room.member"===e.getType()){this.events.member=e;var n=this.membership;this.membership=e.getDirectionalContent().membership;var r=this.name;this.name=i(this,e,t),n!==this.membership&&(this._updateModifiedTime(),this.emit("RoomMember.membership",e,this,n)),r!==this.name&&(this._updateModifiedTime(),this.emit("RoomMember.name",e,this,r))}},r.prototype.setPowerLevelEvent=function(e){if("m.room.power_levels"===e.getType()){var t=e.getContent().users_default||0;a.forEach(a.values(e.getContent().users),function(e){t=Math.max(t,e)});var n=this.powerLevel,r=this.powerLevelNorm;void 0!==e.getContent().users[this.userId]?this.powerLevel=e.getContent().users[this.userId]:void 0!==e.getContent().users_default?this.powerLevel=e.getContent().users_default:this.powerLevel=0,this.powerLevelNorm=0,t>0&&(this.powerLevelNorm=100*this.powerLevel/t),n===this.powerLevel&&r===this.powerLevelNorm||(this._updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))}},r.prototype.setTypingEvent=function(e){if("m.typing"===e.getType()){var t=this.typing;this.typing=!1;var n=e.getContent().user_ids;a.isArray(n)&&(-1!==n.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this._updateModifiedTime(),this.emit("RoomMember.typing",e,this)))}},r.prototype._updateModifiedTime=function(){this._modified=Date.now()},r.prototype.getLastModifiedTime=function(){return this._modified},r.prototype.getAvatarUrl=function(e,t,n,r,i,o){if(void 0===i&&(i=!0),!this.events.member&&!i)return null;var a=this.events.member?this.events.member.getContent().avatar_url:null,u=s.getHttpUriForMxc(e,a,t,n,r,o);return u||(i?s.getIdenticonUri(e,this.userId,t,n):null)},t.exports=r},{"../content-repo":4,"../utils":44,events:48}],26:[function(e,t,n){"use strict";function r(e){this.roomId=e,this.members={},this.events={},this.paginationToken=null,this._sentinels={},this._updateModifiedTime(),this._displayNameToUserIds={},this._userIdsToDisplayNames={},this._tokenToInvite={}}function i(e,t){if(t.getContent().third_party_invite){var n=(t.getContent().third_party_invite.signed||{}).token;if(n){e.getStateEvents("m.room.third_party_invite",n)&&(e._tokenToInvite[n]=t)}}}function o(e,t,n){var r=e._userIdsToDisplayNames[t];if(delete e._userIdsToDisplayNames[t],r){for(var i=e._displayNameToUserIds[r]||[],o=0;o<i.length;o++)i[o]===t&&(i.splice(o,1),o--);e._displayNameToUserIds[r]=i}e._userIdsToDisplayNames[t]=n,e._displayNameToUserIds[n]||(e._displayNameToUserIds[n]=[]),e._displayNameToUserIds[n].push(t)}var s=e("events").EventEmitter,a=e("../utils"),u=e("./room-member");a.inherits(r,s),r.prototype.getMembers=function(){return a.values(this.members)},r.prototype.getMember=function(e){return this.members[e]||null},r.prototype.getSentinelMember=function(e){return this._sentinels[e]||null},r.prototype.getStateEvents=function(e,t){if(!this.events[e])return void 0===t?[]:null;if(void 0===t)return a.values(this.events[e]);var n=this.events[e][t];return n||null},r.prototype.setStateEvents=function(e){var t=this;this._updateModifiedTime(),a.forEach(e,function(e){e.getRoomId()===t.roomId&&e.isState()&&(void 0===t.events[e.getType()]&&(t.events[e.getType()]={}),t.events[e.getType()][e.getStateKey()]=e,"m.room.member"===e.getType()&&(o(t,e.getStateKey(),e.getContent().displayname),i(t,e)),t.emit("RoomState.events",e,t))}),a.forEach(e,function(e){if(e.getRoomId()===t.roomId&&e.isState())if("m.room.member"===e.getType()){var n=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);var r=t.members[n];r||(r=new u(e.getRoomId(),n),t.emit("RoomState.newMember",e,t,r));var i=new u(e.getRoomId(),n);a.forEach([r,i],function(n){n.setMembershipEvent(e,t);var r=t.getStateEvents("m.room.power_levels","");r&&n.setPowerLevelEvent(r)}),t._sentinels[n]=i,t.members[n]=r,t.emit("RoomState.members",e,t,r)}else if("m.room.power_levels"===e.getType()){var o=a.values(t.members);a.forEach(o,function(n){n.setPowerLevelEvent(e),t.emit("RoomState.members",e,t,n)})}})},r.prototype.setTypingEvent=function(e){a.forEach(a.values(this.members),function(t){t.setTypingEvent(e)})},r.prototype.getInviteForThreePidToken=function(e){return this._tokenToInvite[e]||null},r.prototype._updateModifiedTime=function(){this._modified=Date.now()},r.prototype.getLastModifiedTime=function(){return this._modified},r.prototype.getUserIdsWithDisplayName=function(e){return this._displayNameToUserIds[e]||[]},r.prototype.maySendRedactionForEvent=function(e,t){var n=this.getMember(t);return!(!n||"leave"===n.membership)&&(!e.status&&!e.isRedacted()&&(e.getSender()===t||this._hasSufficientPowerLevelFor("redact",n.powerLevel)))},r.prototype._hasSufficientPowerLevelFor=function(e,t){var n=this.getStateEvents("m.room.power_levels",""),r={};n&&(r=n.getContent());var i=50;return void 0!==r[e]&&(i=r[e]),t>=i},r.prototype.maySendMessage=function(e){return this._maySendEventOfType("m.room.message",e,!1)},r.prototype.maySendEvent=function(e,t){return this._maySendEventOfType(e,t,!1)},r.prototype.mayClientSendStateEvent=function(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)},r.prototype.maySendStateEvent=function(e,t){return this._maySendEventOfType(e,t,!0)},r.prototype._maySendEventOfType=function(e,t,n){var r=this.getMember(t);if(!r||"leave"==r.membership)return!1;var i=this.getStateEvents("m.room.power_levels",""),o=void 0,s={},a=0,u=0;i&&(o=i.getContent(),s=o.events||{},a=void 0!==o.state_default?o.state_default:50,void 0!==o.events_default&&(u=o.events_default));var c=n?a:u;return void 0!==s[e]&&(c=s[e]),r.powerLevel>=c},t.exports=r},{"../utils":44,"./room-member":25,events:48}],27:[function(e,t,n){"use strict";function r(e,t){this.roomId=e,this.info=t}t.exports=r},{}],28:[function(e,t,n){"use strict";function r(e,t,n){var r={content:{},type:"m.receipt",room_id:t.getRoomId()};return r.content[t.getId()]={},r.content[t.getId()][n]={},r.content[t.getId()][n][e]={ts:t.getTs()},new d(r)}function i(e,t){if(t=t||{},t.pendingEventOrdering=t.pendingEventOrdering||"chronological",-1===["chronological","detached"].indexOf(t.pendingEventOrdering))throw new Error("opts.pendingEventOrdering MUST be either 'chronological' or 'detached'. Got: '"+t.pendingEventOrdering+"'");this.roomId=e,this.name=e,this.tags={},this.accountData={},this.summary=null,this.storageToken=t.storageToken,this._opts=t,this._txnToEvent={},this._receipts={},this._receiptCacheByEventId={},this._realReceipts={},this._notificationCounts={},this._timelineSets=[new v(this,t)],(0,a.default)(this,this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this._fixUpLegacyTimelineFields(),this._filteredTimelineSets={},"detached"==this._opts.pendingEventOrdering&&(this._pendingEventList=[]),this._blacklistUnverifiedDevices=!1}function o(e,t,n){if(!n){var r=e.currentState.getStateEvents("m.room.name","");if(r&&r.getContent()&&r.getContent().name)return r.getContent().name}var i=e.getCanonicalAlias();if(!i){var o=e.getAliases();o.length&&(i=o[0])}if(i)return i;var s=h.filter(e.currentState.getMembers(),function(e){return e.userId!==t&&"leave"!==e.membership&&"ban"!==e.membership}),a=h.filter(e.currentState.getMembers(),function(e){return"leave"!==e.membership}),u=h.filter(e.currentState.getMembers(),function(e){return e.userId==t}),c=u.length&&u[0].events?u[0].events.member.event:void 0;if(c&&"invite"==c.content.membership)return e.currentState.getMember(c.sender)?"Invite from "+e.currentState.getMember(c.sender).name:a[0].events.member?"Invite from "+c.sender:"Room Invite";if(0===s.length){if(1===a.length){if(a[0].userId===t){var l=e.currentState.getStateEvents("m.room.third_party_invite");if(l&&l.length>0){var d="Inviting "+l[0].getContent().display_name;return l.length>1&&(2==l.length?d+=" and "+l[1].getContent().display_name:d+=" and "+l.length+" others"),d}return"Empty room"}return a[0].name}return"Empty room"}return 1===s.length?s[0].name:2===s.length?s[0].name+" and "+s[1].name:s[0].name+" and "+(s.length-1)+" others"}var s=e("../reemit"),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=e("events").EventEmitter,c=e("./event").EventStatus,l=e("./room-summary"),d=e("./event").MatrixEvent,h=e("../utils"),p=e("../content-repo"),f=e("./event-timeline"),v=e("./event-timeline-set");h.inherits(i,u),i.prototype.getPendingEvents=function(){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call getPendingEventList with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList},i.prototype.getLiveTimeline=function(){return this.getUnfilteredTimelineSet().getLiveTimeline()},i.prototype.resetLiveTimeline=function(e,t){for(var n=0;n<this._timelineSets.length;n++)this._timelineSets[n].resetLiveTimeline(e,t);this._fixUpLegacyTimelineFields()},i.prototype._fixUpLegacyTimelineFields=function(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(f.BACKWARDS),this.currentState=this.getLiveTimeline().getState(f.FORWARDS)},i.prototype.getTimelineSets=function(){return this._timelineSets},i.prototype.getUnfilteredTimelineSet=function(){return this._timelineSets[0]},i.prototype.getTimelineForEvent=function(e){return this.getUnfilteredTimelineSet().getTimelineForEvent(e)},i.prototype.addTimeline=function(){return this.getUnfilteredTimelineSet().addTimeline()},i.prototype.findEventById=function(e){return this.getUnfilteredTimelineSet().findEventById(e)},i.prototype.getUnreadNotificationCount=function(e){return e=e||"total",this._notificationCounts[e]},i.prototype.setUnreadNotificationCount=function(e,t){this._notificationCounts[e]=t},i.prototype.setBlacklistUnverifiedDevices=function(e){this._blacklistUnverifiedDevices=e},i.prototype.getBlacklistUnverifiedDevices=function(){return this._blacklistUnverifiedDevices},i.prototype.getAvatarUrl=function(e,t,n,r,i){var o=this.currentState.getStateEvents("m.room.avatar","");if(void 0===i&&(i=!0),!o&&!i)return null;var s=o?o.getContent().url:null;return s?p.getHttpUriForMxc(e,s,t,n,r):i?p.getIdenticonUri(e,this.roomId,t,n):null},i.prototype.getAliases=function(){var e=[],t=this.currentState.getStateEvents("m.room.aliases");if(t)for(var n=0;n<t.length;++n){var r=t[n];h.isArray(r.getContent().aliases)&&Array.prototype.push.apply(e,r.getContent().aliases)}return e},i.prototype.getCanonicalAlias=function(){var e=this.currentState.getStateEvents("m.room.canonical_alias","");return e?e.getContent().alias:null},i.prototype.addEventsToTimeline=function(e,t,n,r){n.getTimelineSet().addEventsToTimeline(e,t,n,r)},i.prototype.getMember=function(e){var t=this.currentState.members[e];return t||null},i.prototype.getJoinedMembers=function(){return this.getMembersWithMembership("join")},i.prototype.getMembersWithMembership=function(e){return h.filter(this.currentState.getMembers(),function(t){return t.membership===e})},i.prototype.getDefaultRoomName=function(e){return o(this,e,!0)},i.prototype.hasMembershipState=function(e,t){var n=this.getMember(e);return!!n&&n.membership===t},i.prototype.getOrCreateFilteredTimelineSet=function(e){if(this._filteredTimelineSets[e.filterId])return this._filteredTimelineSets[e.filterId];var t=Object.assign({filter:e},this._opts),n=new v(this,t);(0,a.default)(this,n,["Room.timeline","Room.timelineReset"]),this._filteredTimelineSets[e.filterId]=n,this._timelineSets.push(n);var r=this.getLiveTimeline();r.getEvents().forEach(function(e){n.addLiveEvent(e)});for(var i=r;i.getNeighbouringTimeline(f.BACKWARDS);)i=i.getNeighbouringTimeline(f.BACKWARDS);return n.getLiveTimeline().setPaginationToken(i.getPaginationToken(f.BACKWARDS),f.BACKWARDS),n},i.prototype.removeFilteredTimelineSet=function(e){var t=this._filteredTimelineSets[e.filterId];delete this._filteredTimelineSets[e.filterId];var n=this._timelineSets.indexOf(t);n>-1&&this._timelineSets.splice(n,1)},i.prototype._addLiveEvent=function(e,t){var n=void 0;if("m.room.redaction"===e.getType()){var i=e.event.redacts,o=this.getUnfilteredTimelineSet().findEventById(i);o&&(o.makeRedacted(e),this.emit("Room.redaction",e,this))}if(e.getUnsigned().transaction_id){var s=this._txnToEvent[e.getUnsigned().transaction_id];if(s)return void this._handleRemoteEcho(e,s)}for(n=0;n<this._timelineSets.length;n++)this._timelineSets[n].addLiveEvent(e,t);e.sender&&this.addReceipt(r(e.sender.userId,e,"m.read"),!0)},i.prototype.addPendingEvent=function(e,t){if(e.status!==c.SENDING)throw new Error("addPendingEvent called on an event with status "+e.status);if(this._txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(f.setEventMetadata(e,this.getLiveTimeline().getState(f.FORWARDS),!1),this._txnToEvent[t]=e,"detached"==this._opts.pendingEventOrdering)this._pendingEventList.push(e);else for(var n=0;n<this._timelineSets.length;n++){var r=this._timelineSets[n];r.getFilter()?this._filter.filterRoomTimeline([e]).length&&r.addEventToTimeline(e,r.getLiveTimeline(),!1):r.addEventToTimeline(e,r.getLiveTimeline(),!1)}this.emit("Room.localEchoUpdated",e,this,null,null)},i.prototype._handleRemoteEcho=function(e,t){var n=t.getId(),r=e.getId(),i=t.status;delete this._txnToEvent[e.transaction_id],this._pendingEventList&&h.removeElement(this._pendingEventList,function(e){return e.getId()==n},!1),t.handleRemoteEcho(e.event);for(var o=0;o<this._timelineSets.length;o++){this._timelineSets[o].handleRemoteEcho(t,n,r)}this.emit("Room.localEchoUpdated",t,this,n,i)};var m={};m[c.ENCRYPTING]=[c.SENDING,c.NOT_SENT],m[c.SENDING]=[c.ENCRYPTING,c.QUEUED,c.NOT_SENT,c.SENT],m[c.QUEUED]=[c.SENDING,c.CANCELLED],m[c.SENT]=[],m[c.NOT_SENT]=[c.SENDING,c.QUEUED,c.CANCELLED],m[c.CANCELLED]=[],i.prototype.updatePendingEvent=function(e,t,n){if(console.log("setting pendingEvent status to "+t+" in "+e.getRoomId()),t==c.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==c.SENT){if(this.getUnfilteredTimelineSet().eventIdToTimeline(n))return}var r=e.status,i=e.getId()
;if(!r)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var o=m[r];if(!o||o.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+r+"->"+t);if(e.status=t,t==c.SENT){e.event.event_id=n;for(var s=0;s<this._timelineSets.length;s++)this._timelineSets[s].replaceEventId(i,n)}else t==c.CANCELLED&&(this._pendingEventList&&h.removeElement(this._pendingEventList,function(e){return e.getId()==i},!1),this.removeEvent(i));this.emit("Room.localEchoUpdated",e,this,e.getId(),r)},i.prototype.addLiveEvents=function(e,t){var n=void 0;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(n=0;n<this._timelineSets.length;n++){var r=this._timelineSets[n].getLiveTimeline();if(r.getPaginationToken(f.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a pagination token ("+r.getPaginationToken(f.FORWARDS)+")");if(r.getNeighbouringTimeline(f.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a neighbouring timeline")}for(n=0;n<e.length;n++)"m.typing"===e[n].getType()?this.currentState.setTypingEvent(e[n]):"m.receipt"===e[n].getType()?this.addReceipt(e[n]):this._addLiveEvent(e[n],t)},i.prototype.removeEvents=function(e){for(var t=0;t<e.length;++t)this.removeEvent(e[t])},i.prototype.removeEvent=function(e){for(var t=!1,n=0;n<this._timelineSets.length;n++){this._timelineSets[n].removeEvent(e)&&(t=!0)}return t},i.prototype.recalculate=function(e){var t=this,n=this.currentState.getStateEvents("m.room.member",e);if(n&&"invite"===n.getContent().membership){var r=n.event.invite_room_state||[];h.forEach(r,function(n){t.currentState.getStateEvents(n.type,n.state_key)||t.currentState.setStateEvents([new d({type:n.type,state_key:n.state_key,content:n.content,event_id:"$fake"+Date.now(),room_id:t.roomId,user_id:e})])})}var i=this.name;this.name=o(this,e),this.summary=new l(this.roomId,{title:this.name}),i!==this.name&&this.emit("Room.name",this)},i.prototype.getUsersReadUpTo=function(e){return this.getReceiptsForEvent(e).filter(function(e){return"m.read"===e.type}).map(function(e){return e.userId})},i.prototype.getEventReadUpTo=function(e,t){var n=this._receipts;return t&&(n=this._realReceipts),void 0===n["m.read"]||void 0===n["m.read"][e]?null:n["m.read"][e].eventId},i.prototype.getReceiptsForEvent=function(e){return this._receiptCacheByEventId[e.getId()]||[]},i.prototype.addReceipt=function(e,t){void 0===t&&(t=!1),t||this._addReceiptsToStructure(e,this._realReceipts),this._addReceiptsToStructure(e,this._receipts),this._receiptCacheByEventId=this._buildReceiptCache(this._receipts),this.emit("Room.receipt",e,this)},i.prototype._addReceiptsToStructure=function(e,t){var n=this;h.keys(e.getContent()).forEach(function(r){h.keys(e.getContent()[r]).forEach(function(i){h.keys(e.getContent()[r][i]).forEach(function(o){var s=e.getContent()[r][i][o];t[i]||(t[i]={});var a=t[i][o];if(a){var u=n.getUnfilteredTimelineSet().compareEventOrdering(a.eventId,r);if(null!==u&&u>=0)return}else t[i][o]={};t[i][o]={eventId:r,data:s}})})})},i.prototype._buildReceiptCache=function(e){var t={};return h.keys(e).forEach(function(n){h.keys(e[n]).forEach(function(r){var i=e[n][r];t[i.eventId]||(t[i.eventId]=[]),t[i.eventId].push({userId:r,type:n,data:i.data})})}),t},i.prototype._addLocalEchoReceipt=function(e,t,n){this.addReceipt(r(e,t,n),!0)},i.prototype.addTags=function(e){this.tags=e.getContent().tags,this.emit("Room.tags",e,this)},i.prototype.addAccountData=function(e){for(var t=0;t<e.length;t++){var n=e[t];"m.tag"===n.getType()&&this.addTags(n),this.accountData[n.getType()]=n,this.emit("Room.accountData",n,this)}},i.prototype.getAccountData=function(e){return this.accountData[e]},t.exports=i},{"../content-repo":4,"../reemit":33,"../utils":44,"./event":24,"./event-timeline":23,"./event-timeline-set":22,"./room-summary":27,events:48}],29:[function(e,t,n){"use strict";function r(e,t){this.rank=e,this.context=t}var i=e("./event-context"),o=e("../utils");r.fromJson=function(e,t){var n=e.context||{},s=n.events_before||[],a=n.events_after||[],u=new i(t(e.result));return u.setPaginateToken(n.start,!0),u.addEvents(o.map(s,t),!0),u.addEvents(o.map(a,t),!1),u.setPaginateToken(n.end,!1),new r(e.rank,u)},t.exports=r},{"../utils":44,"./event-context":21}],30:[function(e,t,n){"use strict";function r(e){this.userId=e,this.presence="offline",this.presenceStatusMsg=null,this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={presence:null,profile:null},this._updateModifiedTime()}var i=e("events").EventEmitter;e("../utils").inherits(r,i),r.prototype.setPresenceEvent=function(e){if("m.presence"===e.getType()){var t=null===this.events.presence;this.events.presence=e;var n=[];(e.getContent().presence!==this.presence||t)&&n.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&n.push("User.currentlyActive"),this.presence=e.getContent().presence,n.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this._updateModifiedTime();for(var r=0;r<n.length;r++)this.emit(n[r],e,this)}},r.prototype.setDisplayName=function(e){var t=this.displayName;this.displayName=e,e!==t&&this._updateModifiedTime()},r.prototype.setRawDisplayName=function(e){this.rawDisplayName=e},r.prototype.setAvatarUrl=function(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this._updateModifiedTime()},r.prototype._updateModifiedTime=function(){this._modified=Date.now()},r.prototype.getLastModifiedTime=function(){return this._modified},r.prototype.getLastActiveTs=function(){return this.lastPresenceTs-this.lastActiveAgo},t.exports=r},{"../utils":44,events:48}],31:[function(e,t,n){"use strict";function r(e){var t=function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},n=function(e,t,n){for(var r=["override","content","room","sender","underride"],s=0;s<r.length;++s)for(var a=r[s],u=t[a],c=0;c<u.length;++c){var l=u[c];if(l.enabled){var d=i(a,l,n);if(d&&o(d,e))return l.kind=a,l}}return null},i=function(e,t,n){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":r.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;r.conditions.push({kind:"event_match",key:"room_id",pattern:t.rule_id});break;case"sender":if(!t.rule_id)return null;r.conditions.push({kind:"event_match",key:"user_id",pattern:t.rule_id});break;case"content":if(!t.pattern)return null;r.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return n&&r.conditions.push({kind:"device",profile_tag:n}),r},o=function(e,t){for(var n=!0,r=0;r<e.conditions.length;++r){var i=e.conditions[r];n&=s(i,t)}return n},s=function(e,t){var n={event_match:l,device:c,contains_display_name:u,room_member_count:a};return!n[e.kind]||n[e.kind](e,t)},a=function(t,n){if(!t.is)return!1;var r=e.getRoom(n.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;var i=Object.keys(r.currentState.members).filter(function(e){return"join"==r.currentState.members[e].membership}).length,o=t.is.match(/^([=<>]*)([0-9]*)$/);if(!o)return!1;var s=o[1],a=parseInt(o[2]);if(isNaN(a))return!1;switch(s){case"":case"==":return i==a;case"<":return i<a;case">":return i>a;case"<=":return i<=a;case">=":return i>=a;default:return!1}},u=function(n,r){var i=r.getContent();if(!i||!i.body||"string"!=typeof i.body)return!1;var o=e.getRoom(r.getRoomId());if(!(o&&o.currentState&&o.currentState.members&&o.currentState.getMember(e.credentials.userId)))return!1;var s=o.currentState.getMember(e.credentials.userId).name,a=new RegExp("(^|\\W)"+t(s)+"(\\W|$)","i");return i.body.search(a)>-1},c=function(e,t){return!1},l=function(e,t){var n=h(e.key,t);if(!n||"string"!=typeof n)return!1;var r=void 0;r="content.body"==e.key?"(^|\\W)"+d(e.pattern)+"(\\W|$)":"^"+d(e.pattern)+"$";var i=new RegExp(r,"i");return!!n.match(i)},d=function(e){var n=t(e);return n=n.replace(/\\\*/,".*"),n=n.replace(/\?/,"."),n=n.replace(/\\\[(!|)(.*)\\]/,function(e,t,n,r,i){return"["+(t&&"^"||"")+n.replace(/\\\-/,"-")+"]"})},h=function(e,t){var n=e.split("."),r=void 0,i=n[0];for("content"==i?(r=t.getContent(),n.shift()):"type"==i?(r=t.getType(),n.shift()):r=t.event;n.length>0;){var o=n.shift();if(!r[o])return null;r=r[o]}return r},p=function(t,r){if(!r||!r.device)return null;if(t.getSender()==e.credentials.userId)return null;for(var i=Object.keys(r.device),o=0;o<i.length;++o){var s=i[o],a=r.device[s],u=n(a,s);if(u)return u}return n(t,r.global)},f=function(e,t){var n=p(e,t);if(!n)return{};var i=r.actionListToActionsObject(n.actions);return void 0===i.tweaks.highlight&&(i.tweaks.highlight="content"==n.kind),i};this.actionsForEvent=function(t){return f(t,e.pushRules)}}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.actionListToActionsObject=function(e){for(var t={notify:!1,tweaks:{}},n=0;n<e.length;++n){var r=e[n];"notify"===r?t.notify=!0:"object"===(void 0===r?"undefined":i(r))&&(void 0===r.value&&(r.value=!0),t.tweaks[r.set_tweak]=r.value)}return t},t.exports=r},{}],32:[function(e,t,n){(function(e){"use strict";function n(){a&&e.clearTimeout(a);var t=u[0];if(!t)return void c("_scheduleRealCallback: no more callbacks, not rescheduling");var n=l(),i=Math.min(t.runAt-n,o);c("_scheduleRealCallback: now:",n,"delay:",i),a=e.setTimeout(r,i)}function r(){var t=void 0,r=l();c("_runCallbacks: now:",r);for(var i=[];;){var o=u[0];if(!o||o.runAt>r)break;t=u.shift(),c("_runCallbacks: popping",t.key),i.push(t)}n();for(var s=0;s<i.length;s++){t=i[s];try{t.func.apply(e,t.params)}catch(e){console.error("Uncaught exception in callback function",e.stack||e)}}}function i(e,t){for(var n=0,r=e.length;n<r;){var i=n+r>>1;t(e[i])>0?r=i:n=i+1}return n}var o=1e3,s=0,a=void 0,u=[],c=function(){};t.exports.setNow=function(e){l=e||Date.now};var l=Date.now;t.exports.setTimeout=function(e,t){(t=t||0)<0&&(t=0);var r=Array.prototype.slice.call(arguments,2),o=l()+t,a=s++;c("setTimeout: scheduling cb",a,"at",o,"(delay",t,")");var d={runAt:o,func:e,params:r,key:a},h=i(u,function(e){return e.runAt-o});return u.splice(h,0,d),n(),a},t.exports.clearTimeout=function(e){if(0!==u.length){var t=void 0;for(t=0;t<u.length;t++){if(u[t].key==e){u.splice(t,1);break}}0===t&&n()}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],33:[function(e,t,n){"use strict";function r(e,t,n){var r=!0,i=!1,o=void 0;try{for(var s,a=n[Symbol.iterator]();!(r=(s=a.next()).done);r=!0)!function(){var n=s.value;t.on(n,function(){for(var t=arguments.length,r=Array(t),i=0;i<t;i++)r[i]=arguments[i];e.emit.apply(e,[n].concat(r))})}()}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}}Object.defineProperty(n,"__esModule",{value:!0}),n.default=r},{}],34:[function(e,t,n){"use strict";function r(e,t){this.retryAlgorithm=e||r.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||r.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function i(e){e._procFn&&c.forEach(c.filter(c.keys(e._queues),function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0}),function(t){e._activeQueues.push(t),u("Spinning up queue: '%s'",t),o(e,t)})}function o(e,t){var n=s(e,t);if(!n){var r=e._activeQueues.indexOf(t);return r>=0&&e._activeQueues.splice(r,1),void u("Stopping queue '%s' as it is now empty",t)}u("Queue '%s' has %s pending events",t,e._queues[t].length),e._procFn(n.event).done(function(r){a(e,t),u("Queue '%s' sent event %s",t,n.event.getId()),n.defer.resolve(r),o(e,t)},function(r){n.attempts+=1;var i=e.retryAlgorithm(n.event,n.attempts,r);u("retry(%s) err=%s event_id=%s waitTime=%s",n.attempts,r,n.event.getId(),i),-1===i?(u("Queue '%s' giving up on event %s",t,n.event.getId()),a(e,t),n.defer.reject(r),o(e,t)):setTimeout(function(){o(e,t)},i)})}function s(e,t){var n=e._queues[t];return c.isArray(n)?n[0]:null}function a(e,t){var n=e._queues[t];return c.isArray(n)?n.shift():null}function u(){if(d){var e;(e=console).log.apply(e,arguments)}}var c=e("./utils"),l=e("q"),d=!1;r.prototype.getQueueForEvent=function(e){var t=this.queueAlgorithm(e);return t&&this._queues[t]?c.map(this._queues[t],function(e){return e.event}):null},r.prototype.removeEventFromQueue=function(e){var t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;var n=!1;return c.removeElement(this._queues[t],function(t){if(t.event.getId()===e.getId())return n=!0,!0}),n},r.prototype.setProcessFunction=function(e){this._procFn=e,i(this)},r.prototype.queueEvent=function(e){var t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);var n=l.defer();return this._queues[t].push({event:e,defer:n,attempts:0}),u("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),i(this),n.promise},r.RETRY_BACKOFF_RATELIMIT=function(e,t,n){if(400===n.httpStatus||403===n.httpStatus||401===n.httpStatus)return-1;if("rejected"===n.cors)return-1;if("M_LIMIT_EXCEEDED"===n.name){var r=n.data.retry_after_ms;if(r)return r}return t>4?-1:1e3*Math.pow(2,t)},r.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()?"message":null},t.exports=r},{"./utils":44,q:51}],35:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}function o(e,t,n){var r=e.openCursor(t);return l.default.Promise(function(e,t){var i=[];r.onerror=function(e){t(new Error("Query failed: "+e.target.errorCode))},r.onsuccess=function(t){var r=t.target.result;if(!r)return void e(i);i.push(n(r)),r.continue()}})}function s(e){return new l.default.Promise(function(t,n){e.oncomplete=function(e){t(e)},e.onerror=function(e){n(e)}})}function a(e){return new l.default.Promise(function(t,n){e.onsuccess=function(e){t(e)},e.onerror=function(e){n(e)}})}Object.defineProperty(n,"__esModule",{value:!0});var u=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),c=e("q"),l=r(c),d=e("../sync-accumulator"),h=r(d),p=e("../utils"),f=r(p),v=function(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._syncAccumulator=new h.default};v.prototype={connect:function(){var e=this;if(this.db)return(0,l.default)();var t=this.indexedDB.open(this._dbName,1);return t.onupgradeneeded=function(e){var t=e.target.result;e.oldVersion<1&&i(t)},a(t).then(function(t){return e.db=t.target.result,e.db.onversionchange=function(){e.db.close()},e._init()})},_init:function(){var e=this;return l.default.all([this._loadAccountData(),this._loadSyncData()]).then(function(t){var n=u(t,2),r=n[0],i=n[1];e._syncAccumulator.accumulate({next_batch:i.nextBatch,rooms:i.roomsData,account_data:{events:r}})})},clearDatabase:function(){var e=this;return new l.default.Promise(function(t,n){console.log("Removing indexeddb instance: "+e._dbName);var r=e.indexedDB.deleteDatabase(e._dbName);r.onblocked=function(){console.log("can't yet delete indexeddb "+e._dbName+" because it is open elsewhere")},r.onerror=function(e){console.warn("unable to delete js-sdk store indexeddb: "+e.target.error),t()},r.onsuccess=function(){console.log("Removed indexeddb instance: "+e._dbName),t()}})},getSavedSync:function(e){void 0===e&&(e=!0);var t=this._syncAccumulator.getJSON();return t.nextBatch?e?(0,l.default)(f.default.deepCopy(t)):(0,l.default)(t):(0,l.default)(null)},setSyncData:function(e){var t=this;return(0,l.default)().then(function(){t._syncAccumulator.accumulate(e)})},syncToDatabase:function(e){var t=this._syncAccumulator.getJSON();return l.default.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData)])},_persistSyncData:function(e,t){var n=this;return console.log("Persisting sync data up to ",e),l.default.try(function(){var r=n.db.transaction(["sync"],"readwrite");return r.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t}),s(r)})},_persistAccountData:function(e){var t=this;return l.default.try(function(){for(var n=t.db.transaction(["accountData"],"readwrite"),r=n.objectStore("accountData"),i=0;i<e.length;i++)r.put(e[i]);return s(n)})},_persistUserPresenceEvents:function(e){var t=this;return l.default.try(function(){var n=t.db.transaction(["users"],"readwrite"),r=n.objectStore("users"),i=!0,o=!1,a=void 0;try{for(var u,c=e[Symbol.iterator]();!(i=(u=c.next()).done);i=!0){var l=u.value;r.put({userId:l[0],event:l[1]})}}catch(e){o=!0,a=e}finally{try{!i&&c.return&&c.return()}finally{if(o)throw a}}return s(n)})},getUserPresenceEvents:function(){var e=this;return l.default.try(function(){return o(e.db.transaction(["users"],"readonly").objectStore("users"),void 0,function(e){return[e.value.userId,e.value.event]})})},_loadAccountData:function(){var e=this;return l.default.try(function(){return o(e.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,function(e){return e.value})})},_loadSyncData:function(){var e=this;return l.default.try(function(){return o(e.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,function(e){return e.value}).then(function(e){return e.length>1&&console.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{}})})}},n.default=v},{"../sync-accumulator":41,"../utils":44,q:51}],36:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("q"),i=function(e){return e&&e.__esModule?e:{default:e}}(r),o=function(e,t,n){this._dbName=t,this._worker=new n(e),this._nextSeq=0,this._inFlight={},this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then(function(){console.log("IndexedDB worker is ready")})};o.prototype={connect:function(){var e=this;return this._startPromise.then(function(){return e._doCmd("connect")})},clearDatabase:function(){var e=this;return this._startPromise.then(function(){return e._doCmd("clearDatabase")})},getSavedSync:function(){return this._doCmd("getSavedSync")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_doCmd:function(e,t){var n=this;return(0,i.default)().then(function(){var r=n._nextSeq++,o=i.default.defer();return n._inFlight[r]=o,n._worker.postMessage({command:e,seq:r,args:t}),o.promise})},_onWorkerMessage:function(e){var t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void console.error("Got reply from worker with no seq");var n=this._inFlight[t.seq];if(void 0===n)return void console.error("Got reply for unknown seq "+t.seq);delete this._inFlight[t.seq],"cmd_success"==t.command?n.resolve(t.result):n.reject(t.error)}else console.warn("Unrecognised message from worker: "+t)}},n.default=o},{q:51}],37:[function(e,t,n){(function(n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}var i=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=e("q"),s=r(o),a=e("./memory"),u=e("../utils"),c=r(u),l=e("./indexeddb-local-backend.js"),d=r(l),h=e("./indexeddb-remote-backend.js"),p=r(h),f=e("../models/user"),v=r(f),m=e("../models/event"),y=function(e){if(a.MatrixInMemoryStore.call(this,e),!e.indexedDB)throw new Error("Missing required option: indexedDB");if(e.workerScript){var t=e.workerApi;t||(t=n.Worker),this.backend=new p.default(e.workerScript,e.dbName,t)}else this.backend=new d.default(e.indexedDB,e.dbName);this.startedUp=!1,this._syncTs=0,this._userModifiedMap={}};c.default.inherits(y,a.MatrixInMemoryStore),y.prototype.startup=function(){var e=this;return this.startedUp?(0,s.default)():this.backend.connect().then(function(){return e.backend.getUserPresenceEvents()}).then(function(t){t.forEach(function(t){var n=i(t,2),r=n[0],o=n[1],s=new v.default(r);o&&s.setPresenceEvent(new m.MatrixEvent(o)),e._userModifiedMap[s.userId]=s.getLastModifiedTime(),e.storeUser(s)})})},y.prototype.getSavedSync=function(){return this.backend.getSavedSync()},y.prototype.deleteAllData=function(){return a.MatrixInMemoryStore.prototype.deleteAllData.call(this),this.backend.clearDatabase().then(function(){console.log("Deleted indexeddb data.")},function(e){throw console.error("Failed to delete indexeddb data: ",e),e})},y.prototype.save=function(){return Date.now()-this._syncTs>3e5?this._reallySave():(0,s.default)()},y.prototype._reallySave=function(){this._syncTs=Date.now();var e=[],t=!0,n=!1,r=void 0;try{for(var i,o=this.getUsers()[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;this._userModifiedMap[s.userId]!==s.getLastModifiedTime()&&(s.events.presence&&(e.push([s.userId,s.events.presence.event]),this._userModifiedMap[s.userId]=s.getLastModifiedTime()))}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}return this.backend.syncToDatabase(e).catch(function(e){console.error("sync fail:",e)})},y.prototype.setSyncData=function(e){return this.backend.setSyncData(e)},t.exports.IndexedDBStore=y}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../models/event":24,"../models/user":30,"../utils":44,"./indexeddb-local-backend.js":35,"./indexeddb-remote-backend.js":36,"./memory":38,q:51}],38:[function(e,t,n){"use strict";var r=e("../utils"),i=e("../models/user"),o=e("q");t.exports.MatrixInMemoryStore=function(e){e=e||{},this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},this.localStorage=e.localStorage},t.exports.MatrixInMemoryStore.prototype={getSyncToken:function(){return this.syncToken},setSyncToken:function(e){this.syncToken=e},storeRoom:function(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this._onRoomMember.bind(this));var t=this;e.currentState.getMembers().forEach(function(n){t._onRoomMember(null,e.currentState,n)})},_onRoomMember:function(e,t,n){if("invite"!==n.membership){var r=this.users[n.userId]||new i(n.userId);n.name&&(r.setDisplayName(n.name),n.events.member&&r.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&r.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[r.userId]=r}},getRoom:function(e){return this.rooms[e]||null},getRooms:function(){return r.values(this.rooms)},removeRoom:function(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this._onRoomMember),delete this.rooms[e]},getRoomSummaries:function(){return r.map(r.values(this.rooms),function(e){return e.summary})},storeUser:function(e){this.users[e.userId]=e},getUser:function(e){return this.users[e]||null},getUsers:function(){return r.values(this.users)},scrollback:function(e,t){return[]},storeEvents:function(e,t,n,r){},storeFilter:function(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)},getFilter:function(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null},getFilterIdByName:function(e){if(!this.localStorage)return null;try{return this.localStorage.getItem("mxjssdk_memory_filter_"+e)}catch(e){}return null},setFilterIdByName:function(e,t){if(this.localStorage)try{this.localStorage.setItem("mxjssdk_memory_filter_"+e,t)}catch(e){}},storeAccountDataEvents:function(e){var t=this;e.forEach(function(e){t.accountData[e.getType()]=e})},getAccountData:function(e){return this.accountData[e]},setSyncData:function(e){return o()},save:function(){},startup:function(){return o()},getSavedSync:function(){return o(null)},deleteAllData:function(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},o()}}},{"../models/user":30,"../utils":44,q:51}],39:[function(e,t,n){"use strict";function r(e){if(this.store=e,!(d.isFunction(e.getItem)&&d.isFunction(e.setItem)&&d.isFunction(e.removeItem)&&d.isFunction(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}function i(e){return p+"devices/"+e}function o(e){return p+"sessions/"+e}function s(e,t){return p+"inboundgroupsessions/"+e+"/"+t}function a(e){return p+"rooms/"+e}function u(e,t){try{return JSON.parse(e.getItem(t))}catch(e){l("Failed to get key %s: %s",t,e),l(e.stack)}return null}function c(e,t,n){e.setItem(t,JSON.stringify(n))}function l(){if(h){var e;(e=console).log.apply(e,arguments)}}var d=e("../../utils"),h=!1,p="session.e2e.";r.prototype={storeEndToEndAccount:function(e){this.store.setItem(f,e)},getEndToEndAccount:function(){return this.store.getItem(f)},setDeviceAnnounced:function(){this.store.setItem(v,"true")},getDeviceAnnounced:function(){return"true"==this.store.getItem(v)},storeEndToEndDevicesForUser:function(e,t){c(this.store,i(e),t)},getEndToEndDevicesForUser:function(e){return u(this.store,i(e))},storeEndToEndDeviceTrackingStatus:function(e){c(this.store,y,e)},getEndToEndDeviceTrackingStatus:function(){return u(this.store,y)},storeEndToEndDeviceSyncToken:function(e){c(this.store,m,e)},getEndToEndDeviceSyncToken:function(){return u(this.store,m)},storeEndToEndSession:function(e,t,n){var r=this.getEndToEndSessions(e)||{};r[t]=n,c(this.store,o(e),r)},getEndToEndSessions:function(e){return u(this.store,o(e))},getAllEndToEndInboundGroupSessionKeys:function(){for(var e=p+"inboundgroupsessions/",t=[],n=0;n<this.store.length;n++){var r=this.store.key(n);r.startsWith(e)&&t.push({senderKey:r.substr(e.length,43),sessionId:r.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){var n=s(e,t);return this.store.getItem(n)},storeEndToEndInboundGroupSession:function(e,t,n){var r=s(e,t);return this.store.setItem(r,n)},storeEndToEndRoom:function(e,t){c(this.store,a(e),t)},getEndToEndRoom:function(e){return u(this.store,a(e))}};var f=p+"account",v=p+"announced",m=p+"device_sync_token",y=p+"device_tracking";t.exports=r},{"../../utils":44}],40:[function(e,t,n){"use strict";function r(){this.fromToken=null}var i=e("q"),o=function(e){return e&&e.__esModule?e:{default:e}}(i);r.prototype={getSyncToken:function(){return this.fromToken},setSyncToken:function(e){this.fromToken=e},storeRoom:function(e){},getRoom:function(e){return null},getRooms:function(){return[]},removeRoom:function(e){},getRoomSummaries:function(){return[]},storeUser:function(e){},getUser:function(e){return null},getUsers:function(){return[]},scrollback:function(e,t){return[]},storeEvents:function(e,t,n,r){},storeFilter:function(e){},getFilter:function(e,t){return null},getFilterIdByName:function(e){return null},setFilterIdByName:function(e,t){},storeAccountDataEvents:function(e){},getAccountData:function(e){},setSyncData:function(e){return(0,o.default)()},save:function(){},startup:function(){return(0,o.default)()},getSavedSync:function(){return(0,o.default)(null)},deleteAllData:function(){return(0,o.default)()}},t.exports=r},{q:51}],41:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=e("./utils"),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(){function e(t){r(this,e),t=t||{},t.maxTimelineEntries=t.maxTimelineEntries||50,this.opts=t,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null}return o(e,[{key:"accumulate",value:function(e){this._accumulateRooms(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}},{key:"_accumulateAccountData",value:function(e){var t=this;e.account_data&&e.account_data.events&&e.account_data.events.forEach(function(e){t.accountData[e.type]=e})}},{key:"_accumulateRooms",value:function(e){var t=this;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(function(n){t._accumulateRoom(n,"invite",e.rooms.invite[n])}),e.rooms.join&&Object.keys(e.rooms.join).forEach(function(n){t._accumulateRoom(n,"join",e.rooms.join[n])}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(function(n){t._accumulateRoom(n,"leave",e.rooms.leave[n])}))}},{key:"_accumulateRoom",value:function(e,t,n){switch(t){case"invite":this._accumulateInviteState(e,n);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,n);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:console.error("Unknown cateogory: ",t)}}},{key:"_accumulateInviteState",value:function(e,t){if(t.invite_state&&t.invite_state.events){if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});var n=this.inviteRooms[e];t.invite_state.events.forEach(function(e){for(var t=!1,r=0;r<n.invite_state.events.length;r++){var i=n.invite_state.events[r];i.type===e.type&&i.state_key==e.state_key&&(n.invite_state.events[r]=e,t=!0)}t||n.invite_state.events.push(e)})}}},{key:"_accumulateJoinState",value:function(e,t){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_readReceipts:{}});var n=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(function(e){n._accountData[e.type]=e}),t.unread_notifications&&(n._unreadNotifications=t.unread_notifications),t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach(function(e){"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach(function(t){e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach(function(r){n._readReceipts[r]={data:e.content[t]["m.read"][r],eventId:t}})})}),t.timeline&&t.timeline.limited&&(n._timeline=[]),t.state&&t.state.events&&t.state.events.forEach(function(e){i(n._currentState,e)}),t.timeline&&t.timeline.events&&t.timeline.events.forEach(function(e,r){i(n._currentState,e),n._timeline.push({event:e,token:0===r?t.timeline.prev_batch:null})}),n._timeline.length>this.opts.maxTimelineEntries)for(var r=n._timeline.length-this.opts.maxTimelineEntries,o=r;o<n._timeline.length;o++)if(n._timeline[o].token){n._timeline=n._timeline.slice(o,n._timeline.length);break}}},{key:"getJSON",value:function(){var e=this,t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(function(n){t.invite[n]=e.inviteRooms[n]}),Object.keys(this.joinRooms).forEach(function(n){var r=e.joinRooms[n],o={ephemeral:{events:[]},
account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:r._unreadNotifications};Object.keys(r._accountData).forEach(function(e){o.account_data.events.push(r._accountData[e])});var s={type:"m.receipt",room_id:n,content:{}};Object.keys(r._readReceipts).forEach(function(e){var t=r._readReceipts[e];s.content[t.eventId]||(s.content[t.eventId]={"m.read":{}}),s.content[t.eventId]["m.read"][e]=t.data}),Object.keys(s.content).length>0&&o.ephemeral.events.push(s),r._timeline.forEach(function(e){if(!o.timeline.prev_batch){if(!e.token)return;o.timeline.prev_batch=e.token}o.timeline.events.push(e.event)});for(var u=Object.create(null),c=o.timeline.events.length-1;c>=0;c--){var l=o.timeline.events[c];if(null!==l.state_key&&void 0!==l.state_key){var d=a.default.deepCopy(l);d.unsigned&&(d.unsigned.prev_content&&(d.content=d.unsigned.prev_content),d.unsigned.prev_sender&&(d.sender=d.unsigned.prev_sender)),i(u,d)}}Object.keys(r._currentState).forEach(function(e){Object.keys(r._currentState[e]).forEach(function(t){var n=r._currentState[e][t];u[e]&&u[e][t]&&(n=u[e][t]),o.state.events.push(n)})}),t.join[n]=o});var n=[];return Object.keys(this.accountData).forEach(function(t){n.push(e.accountData[t])}),{nextBatch:this.nextBatch,roomsData:t,accountData:n}}}]),e}();t.exports=u},{"./utils":44}],42:[function(e,t,n){(function(n){"use strict";function r(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function i(){var e;v&&(e=console).log.apply(e,arguments)}function o(e,t){this.client=e,t=t||{},t.initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoomId=null,this._currentSyncRequest=null,this._syncState=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,e.getNotifTimelineSet()&&(0,u.default)(e,e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function s(e,t){var n=new l(t);return(0,u.default)(e,n,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),n}var a=e("./reemit"),u=function(e){return e&&e.__esModule?e:{default:e}}(a),c=e("q"),l=e("./models/user"),d=e("./models/room"),h=e("./utils"),p=e("./filter"),f=e("./models/event-timeline"),v=!0;o.prototype.createRoom=function(e){var t=this.client,n=new d(e,{pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t.timelineSupport});return(0,u.default)(t,n,["Room.name","Room.timeline","Room.redaction","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData"]),this._registerStateListeners(n),n},o.prototype._registerStateListeners=function(e){var t=this.client;(0,u.default)(t,e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",function(e,n,r){r.user=t.getUser(r.userId),(0,u.default)(t,r,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])})},o.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},o.prototype.syncLeftRooms=function(){var e=this.client,t=this,n=new p(this.client.credentials.userId);n.setTimelineLimit(1),n.setIncludeLeaveRooms(!0);var i=this.opts.pollTimeout+8e4,o={timeout:0};return e.getOrCreateFilter(r(e.credentials.userId,"LEFT_ROOMS"),n).then(function(t){return o.filter=t,e._http.authedRequest(void 0,"GET","/sync",o,void 0,i)}).then(function(n){var r=[];n.rooms&&n.rooms.leave&&(r=t._mapSyncResponseToRoomArray(n.rooms.leave));var i=[];return r.forEach(function(n){var r=n.room;if(i.push(r),n.isBrandNewRoom){n.timeline=n.timeline||{};var o=t._mapSyncEventsFormat(n.timeline,r),s=t._mapSyncEventsFormat(n.state,r);r.getLiveTimeline().setPaginationToken(n.timeline.prev_batch,f.BACKWARDS),t._processRoomEvents(r,s,o),r.recalculate(e.credentials.userId),e.store.storeRoom(r),e.emit("Room",r)}}),i})},o.prototype.peek=function(e){var t=this,n=this.client;return this._peekRoomId=e,this.client.roomInitialSync(e,20).then(function(r){r.messages=r.messages||{},r.messages.chunk=r.messages.chunk||[],r.state=r.state||[];var i=t.createRoom(e),o=h.map(h.deepCopy(r.state),n.getEventMapper()),a=h.map(r.state,n.getEventMapper()),u=h.map(r.messages.chunk,n.getEventMapper());return r.presence&&h.isArray(r.presence)&&r.presence.map(n.getEventMapper()).forEach(function(e){var t=n.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=s(n,e.getContent().user_id),t.setPresenceEvent(e),n.store.storeUser(t)),n.emit("event",e)}),r.messages.start&&(i.oldState.paginationToken=r.messages.start),i.oldState.setStateEvents(o),i.currentState.setStateEvents(a),t._resolveInvites(i),i.recalculate(t.client.credentials.userId),i.addEventsToTimeline(u.reverse(),!0,i.getLiveTimeline(),r.messages.start),n.store.storeRoom(i),n.emit("Room",i),t._peekPoll(i),i})},o.prototype.stopPeeking=function(){this._peekRoomId=null},o.prototype._peekPoll=function(e,t){if(this._peekRoomId!==e.roomId)return void i("Stopped peeking in room %s",e.roomId);var n=this;this.client._http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).done(function(t){if(n._peekRoomId!==e.roomId)return void i("Stopped peeking in room %s",e.roomId);t.chunk.filter(function(e){return"m.presence"===e.type}).map(n.client.getEventMapper()).forEach(function(e){var t=n.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=s(n.client,e.getContent().user_id),t.setPresenceEvent(e),n.client.store.storeUser(t)),n.client.emit("event",e)});var r=t.chunk.filter(function(t){return t.room_id===e.roomId}).map(n.client.getEventMapper());e.addLiveEvents(r),n._peekPoll(e,t.end)},function(r){console.error("[%s] Peek poll failed: %s",e.roomId,r),setTimeout(function(){n._peekPoll(e,t)},3e4)})},o.prototype.getSyncState=function(){return this._syncState},o.prototype.sync=function(){function e(){o.getPushRules().done(function(e){i("Got push rules"),o.pushRules=e,t()},function(t){s._startKeepAlives().done(function(){e()}),s._updateSyncState("ERROR",{error:t})})}function t(){var e=void 0;s.opts.filter?e=s.opts.filter:(e=new p(o.credentials.userId),e.setTimelineLimit(s.opts.initialSyncLimit)),o.getOrCreateFilter(r(o.credentials.userId),e).done(function(e){o.resetNotifTimelineSet(),s._sync({filterId:e})},function(e){s._startKeepAlives().done(function(){t()}),s._updateSyncState("ERROR",{error:e})})}var o=this.client,s=this;this._running=!0,n.document&&(this._onOnlineBound=this._onOnline.bind(this),n.document.addEventListener("online",this._onOnlineBound,!1)),o.isGuest()?s._sync({}):e()},o.prototype.stop=function(){i("SyncApi.stop"),n.document&&(n.document.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},o.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},o.prototype._sync=function(e){var t=this,n=this.client,r=this;if(!this._running)return i("Sync no longer running: exiting."),r._connectionReturnedDefer&&(r._connectionReturnedDefer.reject(),r._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");var o=e.filterId;n.isGuest()&&!o&&(o=this._getGuestFilter());var s=n.store.getSyncToken(),a=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,a=0);var u=a+8e4,l={filter:o,timeout:a};s?l.since=s:l._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(l.timeout=0);var d=!1,h=void 0;h=e.hasSyncedBefore?c(null):n.store.getSavedSync(),h.then(function(e){return e?(i("sync(): not doing HTTP hit, instead returning stored /sync data"),d=!0,{next_batch:e.nextBatch,rooms:e.roomsData,account_data:{events:e.accountData}}):(t._currentSyncRequest=n._http.authedRequest(void 0,"GET","/sync",l,void 0,u),t._currentSyncRequest)}).then(function(e){return n.store.setSyncToken(e.next_batch),r._failedSyncCount=0,d?c(e):n.store.setSyncData(e).then(function(){return e})}).done(function(t){try{r._processSyncResponse(s,t)}catch(e){console.error("Caught /sync error",e.stack||e)}var i={oldSyncToken:s,nextSyncToken:t.next_batch,catchingUp:r._catchingUp};e.hasSyncedBefore||(r._updateSyncState("PREPARED",i),e.hasSyncedBefore=!0),d||(r._updateSyncState("SYNCING",i),n.store.save()),r._sync(e)},function(t){if(!r._running)return i("Sync no longer running: exiting"),r._connectionReturnedDefer&&(r._connectionReturnedDefer.reject(),r._connectionReturnedDefer=null),void r._updateSyncState("STOPPED");console.error("/sync error %s",t),console.error(t),r._failedSyncCount++,console.log("Number of consecutive failed sync requests:",r._failedSyncCount),i("Starting keep-alive"),r._startKeepAlives().done(function(){r._sync(e)}),r._currentSyncRequest=null,r._updateSyncState(r._failedSyncCount>=3?"ERROR":"RECONNECTING")})},o.prototype._processSyncResponse=function(e,t){var n=this,r=this.client,o=this;if(t.presence&&h.isArray(t.presence.events)&&t.presence.events.map(r.getEventMapper()).forEach(function(e){var t=r.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=s(r,e.getSender()),t.setPresenceEvent(e),r.store.storeUser(t)),r.emit("event",e)}),t.account_data&&h.isArray(t.account_data.events)){var a=t.account_data.events.map(r.getEventMapper());r.store.storeAccountDataEvents(a),a.forEach(function(e){return"m.push_rules"==e.getType()&&(r.pushRules=e.getContent()),r.emit("accountData",e),e})}t.to_device&&h.isArray(t.to_device.events)&&t.to_device.events.length>0?t.to_device.events.map(r.getEventMapper()).forEach(function(e){var t=e.getContent();if("m.room.message"==e.getType()&&"m.bad.encrypted"==t.msgtype)return void console.log("Ignoring undecryptable to-device event from "+e.getSender());r.emit("toDeviceEvent",e)}):this._catchingUp=!1;var u=[],c=[],l=[];t.rooms&&(t.rooms.invite&&(u=this._mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(c=this._mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(l=this._mapSyncResponseToRoomArray(t.rooms.leave))),this._notifEvents=[],u.forEach(function(e){var t=e.room,n=o._mapSyncEventsFormat(e.invite_state,t);o._processRoomEvents(t,n),e.isBrandNewRoom&&(t.recalculate(r.credentials.userId),r.store.storeRoom(t),r.emit("Room",t)),n.forEach(function(e){r.emit("event",e)})}),c.forEach(function(t){var n=t.room,s=o._mapSyncEventsFormat(t.state,n),a=o._mapSyncEventsFormat(t.timeline,n),u=o._mapSyncEventsFormat(t.ephemeral),c=o._mapSyncEventsFormat(t.account_data);if(t.unread_notifications&&(n.setUnreadNotificationCount("total",t.unread_notifications.notification_count),n.setUnreadNotificationCount("highlight",t.unread_notifications.highlight_count)),t.timeline=t.timeline||{},t.isBrandNewRoom)n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,f.BACKWARDS);else if(t.timeline.limited){for(var l=!0,d=a.length-1;d>=0;d--){var h=a[d].getId();if(n.getTimelineForEvent(h)){i("Already have event "+h+" in limited sync - not resetting"),l=!1,a.splice(0,d);break}}l&&(n.currentState.paginationToken=e,o._deregisterStateListeners(n),n.resetLiveTimeline(t.timeline.prev_batch,o.opts.canResetEntireTimeline(n.roomId)),r.resetNotifTimelineSet(),o._registerStateListeners(n))}o._processRoomEvents(n,s,a),n.addLiveEvents(u),n.addAccountData(c),n.recalculate(r.credentials.userId),t.isBrandNewRoom&&(r.store.storeRoom(n),r.emit("Room",n)),s.forEach(function(e){r.emit("event",e)}),a.forEach(function(e){r.emit("event",e)}),u.forEach(function(e){r.emit("event",e)}),c.forEach(function(e){r.emit("event",e)})}),l.forEach(function(e){var t=e.room,n=o._mapSyncEventsFormat(e.state,t),i=o._mapSyncEventsFormat(e.timeline,t),s=o._mapSyncEventsFormat(e.account_data);o._processRoomEvents(t,n,i),t.addAccountData(s),t.recalculate(r.credentials.userId),e.isBrandNewRoom&&(r.store.storeRoom(t),r.emit("Room",t)),n.forEach(function(e){r.emit("event",e)}),i.forEach(function(e){r.emit("event",e)}),s.forEach(function(e){r.emit("event",e)})}),e&&this._notifEvents.length&&(this._notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this._notifEvents.forEach(function(e){r.getNotifTimelineSet().addLiveEvent(e)})),this.opts.crypto&&t.device_lists&&t.device_lists.changed&&t.device_lists.changed.forEach(function(e){n.opts.crypto.userDeviceListChanged(e)})},o.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);var t=this;return e>0?t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t),e):t._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=c.defer()),this._connectionReturnedDefer.promise},o.prototype._pokeKeepAlive=function(){function e(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(),t._connectionReturnedDefer=null)}var t=this;this.client._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).done(function(){e()},function(n){400==n.httpStatus?t._keepAliveTimer=setTimeout(e,2e3):(t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:n}))})},o.prototype._mapSyncResponseToRoomArray=function(e){var t=this.client,n=this;return h.keys(e).map(function(r){var i=e[r],o=t.store.getRoom(r),s=!1;return o||(o=n.createRoom(r),s=!0),i.room=o,i.isBrandNewRoom=s,i})},o.prototype._mapSyncEventsFormat=function(e,t){if(!e||!h.isArray(e.events))return[];var n=this.client.getEventMapper();return e.events.map(function(e){return t&&(e.room_id=t.roomId),n(e)})},o.prototype._resolveInvites=function(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership("invite").forEach(function(n){if(!n._requestedProfileInfo){n._requestedProfileInfo=!0;var r=t.getUser(n.userId),i=void 0;i=r?c({avatar_url:r.avatarUrl,displayname:r.displayName}):t.getProfileInfo(n.userId),i.done(function(t){var r=n.events.member;"invite"===r.getContent().membership&&(r.getContent().avatar_url=t.avatar_url,r.getContent().displayname=t.displayname,n.setMembershipEvent(r,e.currentState))},function(e){})}})}},o.prototype._processRoomEvents=function(e,t,n){n=n||[];var r=this.client,i=h.map(h.deepCopy(t.map(function(e){return e.event})),r.getEventMapper()),o=t;if(e.oldState.setStateEvents(i),e.currentState.setStateEvents(o),this._resolveInvites(e),e.recalculate(this.client.credentials.userId),r.getNotifTimelineSet())for(var s=0;s<n.length;s++){var a=r.getPushActionsForEvent(n[s]);a&&a.notify&&a.tweaks&&a.tweaks.highlight&&this._notifEvents.push(n[s])}e.addLiveEvents(n)},o.prototype._getGuestFilter=function(){return this.client._guestRooms?JSON.stringify({room:{timeline:{limit:20}}}):"{}"},o.prototype._updateSyncState=function(e,t){var n=this._syncState;this._syncState=e,this.client.emit("sync",this._syncState,n,t)},o.prototype._onOnline=function(){i("Browser thinks we are back online"),this._startKeepAlives(0)},t.exports=o}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./filter":17,"./models/event-timeline":23,"./models/room":28,"./models/user":30,"./reemit":33,"./utils":44,q:51}],43:[function(e,t,n){"use strict";function r(e,t,n){n=n||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=n.windowLimit||1e3}function i(e,t){this.timeline=e,this.index=t}var o=e("q"),s=e("./models/event-timeline"),a=function(){};r.prototype.load=function(e,t){var n=this;t=t||20;var r=function(r){var o=void 0,s=r.getEvents();if(e){for(var a=0;a<s.length;a++)if(s[a].getId()==e){o=a;break}if(void 0===o)throw new Error("getEventTimeline result didn't include requested event")}else o=s.length;var u=Math.min(s.length,o+Math.ceil(t/2)),c=Math.max(0,u-t);n._start=new i(r,c-r.getBaseIndex()),n._end=new i(r,u-r.getBaseIndex()),n._eventCount=u-c};if(e){var s=this._client.getEventTimeline(this._timelineSet,e),a=s.inspect();return"fulfilled"==a.state?(r(a.value),o()):s.then(r)}return r(this._timelineSet.getLiveTimeline()),o()},r.prototype.canPaginate=function(e){var t=void 0;if(e==s.BACKWARDS)t=this._start;else{if(e!=s.FORWARDS)throw new Error("Invalid direction '"+e+"'");t=this._end}if(!t)return a("TimelineWindow: no timeline yet"),!1;if(e==s.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},r.prototype.paginate=function(e,t,n,r){void 0===n&&(n=!0),void 0===r&&(r=5);var i=void 0;if(e==s.BACKWARDS)i=this._start;else{if(e!=s.FORWARDS)throw new Error("Invalid direction '"+e+"'");i=this._end}if(!i)return a("TimelineWindow: no timeline yet"),o(!1);if(i.pendingPaginate)return i.pendingPaginate;var u=e==s.BACKWARDS?i.retreat(t):i.advance(t);if(u){this._eventCount+=u,a("TimelineWindow: increased cap by "+u+" (now "+this._eventCount+")");var c=this._eventCount-this._windowLimit;return c>0&&this.unpaginate(c,e!=s.BACKWARDS),o(!0)}if(!n||0===r)return o(!1);if(!i.timeline.getPaginationToken(e))return a("TimelineWindow: no token"),o(!1);a("TimelineWindow: starting request");var l=this,d=this._client.paginateEventTimeline(i.timeline,{backwards:e==s.BACKWARDS,limit:t}).finally(function(){i.pendingPaginate=null}).then(function(n){return a("TimelineWindow: request completed with result "+n),!!n&&l.paginate(e,t,!0,r-1)});return i.pendingPaginate=d,d},r.prototype.unpaginate=function(e,t){var n=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){var r=t?n.advance(e):n.retreat(e);if(r<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=r,this._eventCount-=r,a("TimelineWindow.unpaginate: dropped "+r+" (now "+this._eventCount+")")}},r.prototype.getEvents=function(){if(!this._start)return[];for(var e=[],t=this._start.timeline;;){var n=t.getEvents(),r=0,i=n.length;t===this._start.timeline&&(r=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(i=this._end.index+t.getBaseIndex());for(var o=r;o<i;o++)e.push(n[o]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(s.FORWARDS)}return e},i.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},i.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},i.prototype.advance=function(e){if(!e)return 0;var t=void 0;if(e<0){if((t=Math.max(e,this.minIndex()-this.index))<0)return this.index+=t,t}else if((t=Math.min(e,this.maxIndex()-this.index))>0)return this.index+=t,t;var n=this.timeline.getNeighbouringTimeline(e<0?s.BACKWARDS:s.FORWARDS);return n?(this.timeline=n,this.index=e<0?this.maxIndex():this.minIndex(),a("paginate: switched to new neighbour"),this.advance(e)):0},i.prototype.retreat=function(e){return-1*this.advance(-1*e)},t.exports.TimelineWindow=r,t.exports.TimelineIndex=i},{"./models/event-timeline":23,q:51}],44:[function(e,t,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.exports.encodeParams=function(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t+="&"+encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.substring(1)},t.exports.encodeUri=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e=e.replace(n,encodeURIComponent(t[n])));return e},t.exports.map=function(e,t){for(var n=new Array(e.length),r=0;r<e.length;r++)n[r]=t(e[r]);return n},t.exports.filter=function(e,t){for(var n=[],r=0;r<e.length;r++)t(e[r],r,e)&&n.push(e[r]);return n},t.exports.keys=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},t.exports.values=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t},t.exports.forEach=function(e,t){for(var n=0;n<e.length;n++)t(e[n],n)},t.exports.findElement=function(e,t,n){var r=void 0;if(n){for(r=e.length-1;r>=0;r--)if(t(e[r],r,e))return e[r]}else for(r=0;r<e.length;r++)if(t(e[r],r,e))return e[r]},t.exports.removeElement=function(e,t,n){var r=void 0,i=void 0;if(n){for(r=e.length-1;r>=0;r--)if(t(e[r],r,e))return i=e[r],e.splice(r,1),i}else for(r=0;r<e.length;r++)if(t(e[r],r,e))return i=e[r],e.splice(r,1),i;return!1},t.exports.isFunction=function(e){return"[object Function]"==Object.prototype.toString.call(e)},t.exports.isArray=function(e){return Array.isArray?Array.isArray(e):Boolean(e&&e.constructor===Array)},t.exports.checkObjectHasKeys=function(e,t){for(var n=0;n<t.length;n++)if(!e.hasOwnProperty(t[n]))throw new Error("Missing required key: "+t[n])},t.exports.checkObjectHasNoAdditionalKeys=function(e,t){for(var n in e)if(e.hasOwnProperty(n)&&-1===t.indexOf(n))throw new Error("Unknown key: "+n)},t.exports.deepCopy=function(e){return JSON.parse(JSON.stringify(e))};var i=t.exports.deepCompare=function(e,t){if(e===t)return!0;if((void 0===e?"undefined":r(e))!==(void 0===t?"undefined":r(t)))return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(e instanceof Array){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!i(e[n],t[n]))return!1}else{var o=void 0;for(o in t)if(t.hasOwnProperty(o)!==e.hasOwnProperty(o))return!1;for(o in t){if(t.hasOwnProperty(o)!==e.hasOwnProperty(o))return!1;if(!i(e[o],t[o]))return!1}}return!0};t.exports.extend=function(){for(var e=arguments[0]||{},t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)e[r]=n[r]}return e},t.exports.runPolyfills=function(){Array.prototype.filter||(Array.prototype.filter=function(e){if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var r=[],i=arguments.length>=2?arguments[1]:void 0,o=0;o<n;o++)if(o in t){var s=t[o];e.call(i,s,o,t)&&r.push(s)}return r}),Array.prototype.map||(Array.prototype.map=function(e,t){var n=void 0,r=void 0;if(null===this||void 0===this)throw new TypeError(" this is null or not defined");var i=Object(this),o=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");arguments.length>1&&(n=t);var s=new Array(o);for(r=0;r<o;){var a,u;r in i&&(a=i[r],u=e.call(n,a,r,i),s[r]=u),r++}return s}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n=void 0,r=void 0;if(null===this||void 0===this)throw new TypeError(" this is null or not defined");var i=Object(this),o=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),r=0;r<o;){var s;r in i&&(s=i[r],e.call(n,s,r,i)),r++}})},t.exports.inherits=function(e,t){"function"!=typeof Object.create&&(Object.create=function(){function e(){}var t=Object.prototype.hasOwnProperty;return function(n){if("object"!=(void 0===n?"undefined":r(n)))throw new TypeError("Object prototype may only be an Object or null");e.prototype=n;var i=new e;if(e.prototype=null,arguments.length>1){var o=Object(arguments[1]);for(var s in o)t.call(o,s)&&(i[s]=o[s])}return i}}()),e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}},{}],45:[function(e,t,n){(function(n){"use strict";function r(e){this.roomId=e.roomId,this.client=e.client,this.webRtc=e.webRtc,this.forceTURN=e.forceTURN,this.URL=e.URL,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.turnServers.push({urls:[r.FALLBACK_STUN_SERVER]}),i.forEach(this.turnServers,function(e){i.checkObjectHasKeys(e,["urls"])}),this.callId="c"+(new Date).getTime()+Math.random(),this.state="fledgling",this.didConnect=!1,this.candidateSendQueue=[],this.candidateSendTries=0,this.mediaPromises=Object.create(null),this.screenSharingStream=null}var i=e("../utils"),o=e("events").EventEmitter;r.CALL_TIMEOUT_MS=6e4,r.FALLBACK_STUN_SERVER="stun:stun.l.google.com:19302",r.ERR_LOCAL_OFFER_FAILED="local_offer_failed",r.ERR_NO_USER_MEDIA="no_user_media",i.inherits(r,o),r.prototype.placeVoiceCall=function(){y("placeVoiceCall"),v(this),_(this,b("voice")),this.type="voice"},r.prototype.placeVideoCall=function(e,t){y("placeVideoCall"),v(this),this.localVideoElement=t,this.remoteVideoElement=e,_(this,b("video")),this.type="video",p(this)},r.prototype.placeScreenSharingCall=function(e,t){y("placeScreenSharingCall"),v(this);var n=E(this);if(n){this.localVideoElement=t,this.remoteVideoElement=e;var i=this;this.webRtc.getUserMedia(n,function(e){i.screenSharingStream=e,y("Got screen stream, requesting audio stream...");var t=b("voice");_(i,t)},function(e){i.emit("error",m(r.ERR_NO_USER_MEDIA,"Failed to get screen-sharing stream: "+e))}),this.type="video",p(this)}},r.prototype.playElement=function(e,t){console.log("queuing play on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then(function(){return console.log("previous promise completed for "+t),e.play()},function(){return console.log("previous promise failed for "+t),e.play()}):this.mediaPromises[t]=e.play()},r.prototype.pauseElement=function(e,t){console.log("queuing pause on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then(function(){return console.log("previous promise completed for "+t),e.pause()},function(){return console.log("previous promise failed for "+t),e.pause()}):this.mediaPromises[t]=e.pause()},r.prototype.assignElement=function(e,t,n){console.log("queuing assign on "+n+" element "+e+" for "+t),this.mediaPromises[n]?this.mediaPromises[n]=this.mediaPromises[n].then(function(){console.log("previous promise completed for "+n),e.srcObject=t},function(){console.log("previous promise failed for "+n),e.srcObject=t}):e.srcObject=t},r.prototype.getLocalVideoElement=function(){return this.localVideoElement},r.prototype.getRemoteVideoElement=function(){return this.remoteVideoElement},r.prototype.getRemoteAudioElement=function(){return this.remoteAudioElement},r.prototype.setLocalVideoElement=function(e){if(this.localVideoElement=e,e&&this.localAVStream&&"video"===this.type){e.autoplay=!0,this.assignElement(e,this.localAVStream,"localVideo"),e.muted=!0;var t=this;setTimeout(function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")},0)}},r.prototype.setRemoteVideoElement=function(e){this.remoteVideoElement=e,p(this)},r.prototype.setRemoteAudioElement=function(e){this.remoteVideoElement.muted=!0,this.remoteAudioElement=e,this.remoteAudioElement.muted=!1,f(this)},r.prototype._initWithInvite=function(e){this.msg=e.getContent(),this.peerConn=S(this);var t=this;this.peerConn&&this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(this.msg.offer),T(t,t._onSetRemoteDescriptionSuccess),T(t,t._onSetRemoteDescriptionError)),u(this,"ringing"),this.direction="inbound",this.msg.offer&&this.msg.offer.sdp&&this.msg.offer.sdp.indexOf("m=video")>-1?this.type="video":this.type="voice",e.getAge()&&setTimeout(function(){"ringing"==t.state&&(y("Call invite has expired. Hanging up."),t.hangupParty="remote",u(t,"ended"),h(t),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),t.emit("hangup",t))},this.msg.lifetime-e.getAge())},r.prototype._initWithHangup=function(e){this.msg=e.getContent(),u(this,"ended")},r.prototype.answer=function(){y("Answering call %s of type %s",this.callId,this.type);var e=this;this.localAVStream||this.waitForLocalAVStream?this.localAVStream?this._maybeGotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&u(this,"wait_local_media"):(this.webRtc.getUserMedia(b(this.type),T(e,e._maybeGotUserMediaForAnswer),T(e,e._maybeGotUserMediaForAnswer)),u(this,"wait_local_media"))},r.prototype._replacedBy=function(e){y(this.callId+" being replaced by "+e.callId),"wait_local_media"==this.state?(y("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):"create_offer"==this.state?(y("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream):"invite_sent"==this.state&&(y("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),e.localVideoElement=this.localVideoElement,e.remoteVideoElement=this.remoteVideoElement,e.remoteAudioElement=this.remoteAudioElement,this.successor=e,this.emit("replaced",e),this.hangup(!0)},r.prototype.hangup=function(e,t){y("Ending call "+this.callId),d(this,"local",e,!t);var n={version:0,call_id:this.callId,reason:e};c(this,"m.call.hangup",n)},r.prototype.setLocalVideoMuted=function(e){this.localAVStream&&s(this.localAVStream.getVideoTracks(),!e)},r.prototype.isLocalVideoMuted=function(){return!!this.localAVStream&&!a(this.localAVStream.getVideoTracks())},r.prototype.setMicrophoneMuted=function(e){this.localAVStream&&s(this.localAVStream.getAudioTracks(),!e)},r.prototype.isMicrophoneMuted=function(){return!!this.localAVStream&&!a(this.localAVStream.getAudioTracks())},r.prototype._maybeGotUserMediaForInvite=function(e){if(this.successor)return void this.successor._maybeGotUserMediaForAnswer(e);if("ended"!=this.state){y("_maybeGotUserMediaForInvite -> "+this.type);var t=this,n=e,r={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};if(e instanceof MediaStream){var i=this.getLocalVideoElement();i&&"video"==this.type&&(i.autoplay=!0,this.screenSharingStream?(y("Setting screen sharing stream to the local video element"),this.assignElement(i,this.screenSharingStream,"localVideo")):this.assignElement(i,e,"localVideo"),i.muted=!0,setTimeout(function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")},0)),this.screenSharingStream&&(this.screenSharingStream.addTrack(e.getAudioTracks()[0]),e=this.screenSharingStream),this.localAVStream=e,s(e.getAudioTracks(),!0),this.peerConn=S(this),this.peerConn.addStream(e)}else{if("PermissionDeniedError"!==n.name)return y("Failed to getUserMedia."),void this._getUserMediaFailed(n);y("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only."),this.peerConn=S(this)}this.peerConn.createOffer(T(t,t._gotLocalOffer),T(t,t._getLocalOfferFailed),r),u(t,"create_offer")}},r.prototype._maybeGotUserMediaForAnswer=function(e){var t=this;if("ended"!=t.state){var n=e;if(e instanceof MediaStream){var r=t.getLocalVideoElement();r&&"video"==t.type&&(r.autoplay=!0,this.assignElement(r,e,"localVideo"),r.muted=!0,setTimeout(function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")},0)),t.localAVStream=e,s(e.getAudioTracks(),!0),t.peerConn.addStream(e)}else{if("PermissionDeniedError"!==n.name)return y("Failed to getUserMedia."),void this._getUserMediaFailed(n);y("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only.")}var i={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};t.peerConn.createAnswer(function(e){y("Created answer: "+e),t.peerConn.setLocalDescription(e,function(){var e={version:0,call_id:t.callId,answer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type}};c(t,"m.call.answer",e),u(t,"connecting")},function(){y("Error setting local description!")},i)},function(e){y("Failed to create answer: "+e)}),u(t,"create_answer")}},r.prototype._gotLocalIceCandidate=function(e){if(e.candidate){y("Got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate)
;var t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};l(this,t)}},r.prototype._gotRemoteIceCandidate=function(e){"ended"!=this.state&&(y("Got remote ICE "+e.sdpMid+" candidate: "+e.candidate),this.peerConn.addIceCandidate(new this.webRtc.RtcIceCandidate(e),function(){},function(e){}))},r.prototype._receivedAnswer=function(e){if("ended"!=this.state){var t=this;this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(e.answer),T(t,t._onSetRemoteDescriptionSuccess),T(t,t._onSetRemoteDescriptionError)),u(t,"connecting")}},r.prototype._gotLocalOffer=function(e){var t=this;if(y("Created offer: "+e),"ended"==t.state)return void y("Ignoring newly created offer on call ID "+t.callId+" because the call has ended");t.peerConn.setLocalDescription(e,function(){var e={version:0,call_id:t.callId,offer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type},lifetime:r.CALL_TIMEOUT_MS};c(t,"m.call.invite",e),setTimeout(function(){"invite_sent"==t.state&&t.hangup("invite_timeout")},r.CALL_TIMEOUT_MS),u(t,"invite_sent")},function(){y("Error setting local description!")})},r.prototype._getLocalOfferFailed=function(e){this.emit("error",m(r.ERR_LOCAL_OFFER_FAILED,"Failed to start audio for call!"))},r.prototype._getUserMediaFailed=function(e){this.emit("error",m(r.ERR_NO_USER_MEDIA,"Couldn't start capturing media! Is your microphone set up and does this app have permission?")),this.hangup("user_media_failed")},r.prototype._onIceConnectionStateChanged=function(){"ended"!=this.state&&(y("Ice connection state changed to: "+this.peerConn.iceConnectionState),"completed"==this.peerConn.iceConnectionState||"connected"==this.peerConn.iceConnectionState?(u(this,"connected"),this.didConnect=!0):"failed"==this.peerConn.iceConnectionState&&this.hangup("ice_failed"))},r.prototype._onSignallingStateChanged=function(){y("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)},r.prototype._onSetRemoteDescriptionSuccess=function(){y("Set remote description")},r.prototype._onSetRemoteDescriptionError=function(e){y("Failed to set remote description"+e)},r.prototype._onAddStream=function(e){y("Stream id "+e.stream.id+" added");var t=e.stream;t.getVideoTracks().length>0?(this.type="video",this.remoteAVStream=t,this.remoteAStream=t):(this.type="voice",this.remoteAStream=t);var n=this;R(t,function(e){y("Track id "+e.id+" added"),e.onstarted=T(n,n._onRemoteStreamTrackStarted)}),void 0!==e.stream.oninactive?e.stream.oninactive=T(n,n._onRemoteStreamEnded):e.stream.onended=T(n,n._onRemoteStreamEnded),e.stream.onstarted=T(n,n._onRemoteStreamStarted),"video"===this.type?(p(this),f(this)):f(this)},r.prototype._onRemoteStreamStarted=function(e){u(this,"connected")},r.prototype._onRemoteStreamEnded=function(e){y("Remote stream ended"),this.hangupParty="remote",u(this,"ended"),h(this),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit("hangup",this)},r.prototype._onRemoteStreamTrackStarted=function(e){u(this,"connected")},r.prototype._onHangupReceived=function(e){y("Hangup received"),d(this,"remote",e.reason,!0)},r.prototype._onAnsweredElsewhere=function(e){y("Answered elsewhere"),d(this,"remote","answered_elsewhere",!0)};var s=function(e,t){for(var n=0;n<e.length;n++)e[n].enabled=t},a=function(e){for(var t=0;t<e.length;t++)if(e[t].enabled)return!0;return!1},u=function(e,t){var n=e.state;e.state=t,e.emit("state",t,n)},c=function(e,t,n){return e.client.sendEvent(e.roomId,t,n).catch(function(t){e.emit("send_event_error",t)})},l=function(e,t){e.candidateSendQueue.push(t),0===e.candidateSendTries&&setTimeout(function(){g(e)},100)},d=function(e,t,n,r){e.getRemoteVideoElement()&&(e.getRemoteVideoElement().pause&&e.pauseElement(e.getRemoteVideoElement(),"remoteVideo"),e.assignElement(e.getRemoteVideoElement(),null,"remoteVideo")),e.getRemoteAudioElement()&&(e.getRemoteAudioElement().pause&&e.pauseElement(e.getRemoteAudioElement(),"remoteAudio"),e.assignElement(e.getRemoteAudioElement(),null,"remoteAudio")),e.getLocalVideoElement()&&(e.getLocalVideoElement().pause&&e.pauseElement(e.getLocalVideoElement(),"localVideo"),e.assignElement(e.getLocalVideoElement(),null,"localVideo")),e.hangupParty=t,e.hangupReason=n,u(e,"ended"),h(e),e.peerConn&&"closed"!==e.peerConn.signalingState&&e.peerConn.close(),r&&e.emit("hangup",e)},h=function(e){y("stopAllMedia (stream=%s)",e.localAVStream),e.localAVStream&&(R(e.localAVStream,function(e){e.stop&&e.stop()}),e.localAVStream.stop&&e.localAVStream.stop()),e.screenSharingStream&&(R(e.screenSharingStream,function(e){e.stop&&e.stop()}),e.screenSharingStream.stop&&e.screenSharingStream.stop()),e.remoteAVStream&&R(e.remoteAVStream,function(e){e.stop&&e.stop()}),e.remoteAStream&&R(e.remoteAStream,function(e){e.stop&&e.stop()})},p=function(e){if(e.getRemoteVideoElement()&&e.remoteAVStream){var t=e.getRemoteVideoElement();t.autoplay=!0,e.assignElement(t,e.remoteAVStream,"remoteVideo"),setTimeout(function(){var t=e.getRemoteVideoElement();t.play&&e.playElement(t,"remoteVideo"),e.webRtc.isOpenWebRTC()&&u(e,"connected")},0)}},f=function(e){if(e.getRemoteAudioElement()&&e.remoteAStream){var t=e.getRemoteAudioElement();t.autoplay=!0,e.assignElement(t,e.remoteAStream,"remoteAudio"),setTimeout(function(){var t=e.getRemoteAudioElement();t.play&&e.playElement(t,"remoteAudio"),e.webRtc.isOpenWebRTC()&&u(e,"connected")},0)}},v=function(e){if(0===e.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")},m=function(e,t){var n=new Error(t);return n.code=e,n},y=function(){var e;(e=console).log.apply(e,arguments)},g=function e(t){if(0!==t.candidateSendQueue.length){var n=t.candidateSendQueue;t.candidateSendQueue=[],++t.candidateSendTries;var r={version:0,call_id:t.callId,candidates:n};y("Attempting to send "+n.length+" candidates"),c(t,"m.call.candidates",r).then(function(){t.candidateSendTries=0,e(t)},function(r){for(var i=0;i<n.length;i++)t.candidateSendQueue.push(n[i]);if(t.candidateSendTries>5)return y("Failed to send candidates on attempt %s. Giving up for now.",t.candidateSendTries),void(t.candidateSendTries=0);var o=500*Math.pow(2,t.candidateSendTries);++t.candidateSendTries,y("Failed to send candidates. Retrying in "+o+"ms"),setTimeout(function(){e(t)},o)})}},_=function(e,t){e.client.callList[e.callId]=e,e.webRtc.getUserMedia(t,T(e,e._maybeGotUserMediaForInvite),T(e,e._maybeGotUserMediaForInvite)),u(e,"wait_local_media"),e.direction="outbound",e.config=t},S=function(e){var t=e.turnServers;if("mozilla"===e.webRtc.vendor){t=[];for(var n=0;n<e.turnServers.length;n++)for(var r=0;r<e.turnServers[n].urls.length;r++)t.push({url:e.turnServers[n].urls[r],username:e.turnServers[n].username,credential:e.turnServers[n].credential})}var i=new e.webRtc.RtcPeerConnection({iceTransportPolicy:e.forceTURN?"relay":void 0,iceServers:t});return i.oniceconnectionstatechange=T(e,e._onIceConnectionStateChanged),i.onsignalingstatechange=T(e,e._onSignallingStateChanged),i.onicecandidate=T(e,e._gotLocalIceCandidate),i.onaddstream=T(e,e._onAddStream),i},E=function(e){var t=n.screen;return t?{video:{mediaSource:"screen",mandatory:{chromeMediaSource:"screen",chromeMediaSourceId:""+Date.now(),maxWidth:t.width,maxHeight:t.height,minFrameRate:1,maxFrameRate:10}}}:void e.emit("error",m(r.ERR_NO_USER_MEDIA,"Couldn't determine screen sharing constaints."))},b=function(e){var t=!!n.window.navigator.webkitGetUserMedia;switch(e){case"voice":return{audio:{deviceId:k?{exact:k}:void 0},video:!1};case"video":return{audio:{deviceId:k?{exact:k}:void 0},video:{deviceId:D?{exact:D}:void 0,width:t?{exact:640}:{ideal:640},height:t?{exact:360}:{ideal:360}}}}},T=function(e,t){return function(){return t.apply(e,arguments)}},w=function(e,t){for(var n=e.getVideoTracks(),r=0;r<n.length;r++)t(n[r])},I=function(e,t){for(var n=e.getAudioTracks(),r=0;r<n.length;r++)t(n[r])},R=function(e,t){w(e,t),I(e,t)};t.exports.MatrixCall=r;var k=void 0,D=void 0;t.exports.setAudioInput=function(e){k=e},t.exports.setVideoInput=function(e){D=e},t.exports.createNewMatrixCall=function(e,t,i){var o=n.window,s=n.document;if(!o||!s)return null;var a={};a.isOpenWebRTC=function(){var e=s.getElementById("script");if(!e||!e.length)return!1;for(var t=0;t<e.length;t++)if(e[t].src.indexOf("owr.js")>-1)return!0;return!1};var u=o.navigator.getUserMedia||o.navigator.webkitGetUserMedia||o.navigator.mozGetUserMedia;return u&&(a.getUserMedia=function(){return u.apply(o.navigator,arguments)}),a.RtcPeerConnection=o.RTCPeerConnection||o.webkitRTCPeerConnection||o.mozRTCPeerConnection,a.RtcSessionDescription=o.RTCSessionDescription||o.webkitRTCSessionDescription||o.mozRTCSessionDescription,a.RtcIceCandidate=o.RTCIceCandidate||o.webkitRTCIceCandidate||o.mozRTCIceCandidate,a.vendor=null,o.mozRTCPeerConnection?a.vendor="mozilla":o.webkitRTCPeerConnection?a.vendor="webkit":o.RTCPeerConnection&&(a.vendor="generic"),a.RtcIceCandidate&&a.RtcSessionDescription&&a.RtcPeerConnection&&a.getUserMedia?new r({webRtc:a,client:e,URL:o.URL,roomId:t,turnServers:e.getTurnServers(),forceTURN:!!i&&i.forceTURN}):null}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../utils":44,events:48}],46:[function(e,t,n){"use strict";function r(e){return a.lastIndex=0,e.replace(a,function(e){return u[e]})}function i(e){switch(typeof e){case"string":return'"'+r(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?o(e):s(e);default:throw new Error("Cannot stringify: "+typeof e)}}function o(e){for(var t="[",n="",r=0;r<e.length;++r)n+=t,t=",",n+=i(e[r]);return","!=t?"[]":n+"]"}function s(e){var t="{",n="",o=Object.keys(e);o.sort();for(var s=0;s<o.length;++s){var a=o[s];n+=t+'"'+r(a)+'":',t=",",n+=i(e[a])}return","!=t?"{}":n+"}"}for(var a=/[\\\"\x00-\x1F]/g,u={},c=0;c<32;++c)u[String.fromCharCode(c)]="\\U"+("0000"+c.toString(16)).slice(-4).toUpperCase();u["\b"]="\\b",u["\t"]="\\t",u["\n"]="\\n",u["\f"]="\\f",u["\r"]="\\r",u['"']='\\"',u["\\"]="\\\\",t.exports={stringify:i}},{}],47:[function(e,t,n){!function(e,r){"function"==typeof define&&define.amd?define([],r):"object"==typeof n?t.exports=r():e.returnExports=r()}(this,function(){function e(i,o){if("function"!=typeof o)throw new Error("Bad callback given: "+o);if(!i)throw new Error("No options given");var a=i.onResponse;if(i="string"==typeof i?{uri:i}:JSON.parse(JSON.stringify(i)),i.onResponse=a,i.verbose&&(e.log=r()),i.url&&(i.uri=i.url,delete i.url),!i.uri&&""!==i.uri)throw new Error("options.uri is a required argument");if("string"!=typeof i.uri)throw new Error("options.uri must be a string");for(var u=["proxy","_redirectsFollowed","maxRedirects","followRedirect"],c=0;c<u.length;c++)if(i[u[c]])throw new Error("options."+u[c]+" is not supported");if(i.callback=o,i.method=i.method||"GET",i.headers=i.headers||{},i.body=i.body||null,i.timeout=i.timeout||e.DEFAULT_TIMEOUT,i.headers.host)throw new Error("Options.headers.host is not supported");i.json&&(i.headers.accept=i.headers.accept||"application/json","GET"!==i.method&&(i.headers["content-type"]="application/json"),"boolean"!=typeof i.json?i.body=JSON.stringify(i.json):"string"!=typeof i.body&&(i.body=JSON.stringify(i.body)));var l=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};if(i.qs){var d="string"==typeof i.qs?i.qs:l(i.qs);-1!==i.uri.indexOf("?")?i.uri=i.uri+"&"+d:i.uri=i.uri+"?"+d}if(i.form){if("string"==typeof i.form)throw"form name unsupported";if("POST"===i.method){var h=(i.encoding||"application/x-www-form-urlencoded").toLowerCase();switch(i.headers["content-type"]=h,h){case"application/x-www-form-urlencoded":i.body=l(i.form).replace(/%20/g,"+");break;case"multipart/form-data":var p=function(e){var t={};t.boundry="-------------------------------"+Math.floor(1e9*Math.random());var n=[];for(var r in e)e.hasOwnProperty(r)&&n.push("--"+t.boundry+'\nContent-Disposition: form-data; name="'+r+'"\n\n'+e[r]+"\n");return n.push("--"+t.boundry+"--"),t.body=n.join(""),t.length=t.body.length,t.type="multipart/form-data; boundary="+t.boundry,t}(i.form);i.body=p.body,i.headers["content-type"]=p.type;break;default:throw new Error("unsupported encoding:"+h)}}}return i.onResponse=i.onResponse||n,!0===i.onResponse&&(i.onResponse=o,i.callback=n),!i.headers.authorization&&i.auth&&(i.headers.authorization="Basic "+s(i.auth.username+":"+i.auth.password)),t(i)}function t(t){function n(){d=!0;var n=new Error("ETIMEDOUT");return n.code="ETIMEDOUT",n.duration=t.timeout,e.log.error("Timeout",{id:l._id,milliseconds:t.timeout}),t.callback(n,l)}function r(n){if(d)return e.log.debug("Ignoring timed out state change",{state:l.readyState,id:l.id});if(e.log.debug("State change",{state:l.readyState,id:l.id,timed_out:d}),l.readyState===a.OPENED){e.log.debug("Request started",{id:l.id});for(var r in t.headers)l.setRequestHeader(r,t.headers[r])}else l.readyState===a.HEADERS_RECEIVED?i():l.readyState===a.LOADING?(i(),s()):l.readyState===a.DONE&&(i(),s(),c())}function i(){if(!v.response){if(v.response=!0,e.log.debug("Got response",{id:l.id,status:l.status}),clearTimeout(l.timeoutTimer),l.statusCode=l.status,h&&0==l.statusCode){var n=new Error("CORS request rejected: "+t.uri);return n.cors="rejected",v.loading=!0,v.end=!0,t.callback(n,l)}t.onResponse(null,l)}}function s(){v.loading||(v.loading=!0,e.log.debug("Response body loading",{id:l.id}))}function c(){if(!v.end){if(v.end=!0,e.log.debug("Request done",{id:l.id}),l.body=l.responseText,t.json)try{l.body=JSON.parse(l.responseText)}catch(e){return t.callback(e,l)}t.callback(null,l,l.body)}}var l=new a,d=!1,h=o(t.uri),p="withCredentials"in l;if(u+=1,l.seq_id=u,l.id=u+": "+t.method+" "+t.uri,l._id=l.id,h&&!p){var f=new Error("Browser does not support cross-origin request: "+t.uri);return f.cors="unsupported",t.callback(f,l)}l.timeoutTimer=setTimeout(n,t.timeout);var v={response:!1,loading:!1,end:!1};return l.onreadystatechange=r,l.open(t.method,t.uri,!0),h&&(l.withCredentials=!!t.withCredentials),l.send(t.body),l}function n(){}function r(){var e,t,r={},o=["trace","debug","info","warn","error"];for(t=0;t<o.length;t++)e=o[t],r[e]=n,"undefined"!=typeof console&&console&&console[e]&&(r[e]=i(console,e));return r}function i(e,t){function n(n,r){return"object"==typeof r&&(n+=" "+JSON.stringify(r)),e[t].call(e,n)}return n}function o(e){var t,n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/;try{t=location.href}catch(e){t=document.createElement("a"),t.href="",t=t.href}var r=n.exec(t.toLowerCase())||[],i=n.exec(e.toLowerCase());return!(!i||i[1]==r[1]&&i[2]==r[2]&&(i[3]||("http:"===i[1]?80:443))==(r[3]||("http:"===r[1]?80:443)))}function s(e){var t,n,r,i,o,s,a,u,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,d=0,h="",p=[];if(!e)return e;do{t=e.charCodeAt(l++),n=e.charCodeAt(l++),r=e.charCodeAt(l++),u=t<<16|n<<8|r,i=u>>18&63,o=u>>12&63,s=u>>6&63,a=63&u,p[d++]=c.charAt(i)+c.charAt(o)+c.charAt(s)+c.charAt(a)}while(l<e.length);switch(h=p.join(""),e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"="}return h}var a=XMLHttpRequest;if(!a)throw new Error("missing XMLHttpRequest");e.log={trace:n,debug:n,info:n,warn:n,error:n};var u=0;return e.withCredentials=!1,e.DEFAULT_TIMEOUT=18e4,e.defaults=function(t,n){var r=function(e){return function(n,r){n="string"==typeof n?{uri:n}:JSON.parse(JSON.stringify(n));for(var i in t)void 0===n[i]&&(n[i]=t[i]);return e(n,r)}},i=r(e);return i.get=r(e.get),i.post=r(e.post),i.put=r(e.put),i.head=r(e.head),i},["get","put","post","head"].forEach(function(t){var n=t.toUpperCase();e[t.toLowerCase()]=function(t){"string"==typeof t?t={method:n,uri:t}:(t=JSON.parse(JSON.stringify(t)),t.method=n);var r=[t].concat(Array.prototype.slice.apply(arguments,[1]));return e.apply(this,r)}}),e.couch=function(t,r){function i(e,t,n){if(e)return r(e,t,n);if((t.statusCode<200||t.statusCode>299)&&n.error){e=new Error("CouchDB error: "+(n.error.reason||n.error.error));for(var i in n)e[i]=n[i];return r(e,t,n)}return r(e,t,n)}return"string"==typeof t&&(t={uri:t}),t.json=!0,t.body&&(t.json=t.body),delete t.body,r=r||n,e(t,i)},e})},{}],48:[function(e,t,n){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(e){return"function"==typeof e}function o(e){return"number"==typeof e}function s(e){return"object"==typeof e&&null!==e}function a(e){return void 0===e}t.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!o(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,n,r,o,u,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(n=this._events[e],a(n))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),n.apply(this,o)}else if(s(n))for(o=Array.prototype.slice.call(arguments,1),c=n.slice(),r=c.length,u=0;u<r;u++)c[u].apply(this,o);return!0},r.prototype.addListener=function(e,t){var n;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?s(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,s(this._events[e])&&!this._events[e].warned&&(n=a(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function n(){this.removeListener(e,n),r||(r=!0,t.apply(this,arguments))}if(!i(t))throw TypeError("listener must be a function");var r=!1;return n.listener=t,this.on(e,n),this},r.prototype.removeListener=function(e,t){var n,r,o,a;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],o=n.length,r=-1,n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(s(n)){for(a=o;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){r=a;break}if(r<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],i(n))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)}},{}],49:[function(e,t,n){function r(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(e){if(d===setTimeout)return setTimeout(e,0);if((d===r||!d)&&setTimeout)return d=setTimeout,setTimeout(e,0);try{return d(e,0)}catch(t){try{return d.call(null,e,0)}catch(t){return d.call(this,e,0)}}}function s(e){if(h===clearTimeout)return clearTimeout(e);if((h===i||!h)&&clearTimeout)return h=clearTimeout,clearTimeout(e);try{return h(e)}catch(t){try{return h.call(null,e)}catch(t){return h.call(this,e)}}}function a(){m&&f&&(m=!1,f.length?v=f.concat(v):y=-1,v.length&&u())}function u(){if(!m){var e=o(a);m=!0;for(var t=v.length;t;){for(f=v,v=[];++y<t;)f&&f[y].run();y=-1,t=v.length}f=null,m=!1,s(e)}}function c(e,t){this.fun=e,this.array=t}function l(){}var d,h,p=t.exports={};!function(){try{d="function"==typeof setTimeout?setTimeout:r}catch(e){d=r}try{h="function"==typeof clearTimeout?clearTimeout:i}catch(e){h=i}}();var f,v=[],m=!1,y=-1;p.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];v.push(new c(e,t)),1!==v.length||m||o(u)},c.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=l,p.addListener=l,p.once=l,p.off=l,p.removeListener=l,p.removeAllListeners=l,p.emit=l,p.prependListener=l,p.prependOnceListener=l,p.listeners=function(e){return[]},p.binding=function(e){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(e){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},{}],50:[function(e,t,n){(function(e){!function(r){function i(e){throw new RangeError(U[e])}function o(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}function s(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),e=e.replace(O,"."),r+o(e.split("."),t).join(".")}function a(e){for(var t,n,r=[],i=0,o=e.length;i<o;)t=e.charCodeAt(i++),t>=55296&&t<=56319&&i<o?(n=e.charCodeAt(i++),56320==(64512&n)?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--)):r.push(t);return r}function u(e){return o(e,function(e){var t="";return e>65535&&(e-=65536,t+=L(e>>>10&1023|55296),e=56320|1023&e),t+=L(e)}).join("")}function c(e){return e-48<10?e-22:e-65<26?e-65:e-97<26?e-97:b}function l(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function d(e,t,n){var r=0;for(e=n?M(e/R):e>>1,e+=M(e/t);e>P*w>>1;r+=b)e=M(e/P);return M(r+(P+1)*e/(e+I))}function h(e){var t,n,r,o,s,a,l,h,p,f,v=[],m=e.length,y=0,g=D,_=k;for(n=e.lastIndexOf(x),n<0&&(n=0),r=0;r<n;++r)e.charCodeAt(r)>=128&&i("not-basic"),v.push(e.charCodeAt(r));for(o=n>0?n+1:0;o<m;){for(s=y,a=1,l=b;o>=m&&i("invalid-input"),h=c(e.charCodeAt(o++)),(h>=b||h>M((E-y)/a))&&i("overflow"),y+=h*a,p=l<=_?T:l>=_+w?w:l-_,!(h<p);l+=b)f=b-p,a>M(E/f)&&i("overflow"),a*=f;t=v.length+1,_=d(y-s,t,0==s),M(y/t)>E-g&&i("overflow"),g+=M(y/t),y%=t,v.splice(y++,0,g)}return u(v)}function p(e){var t,n,r,o,s,u,c,h,p,f,v,m,y,g,_,S=[];for(e=a(e),m=e.length,t=D,n=0,s=k,u=0;u<m;++u)(v=e[u])<128&&S.push(L(v));for(r=o=S.length,o&&S.push(x);r<m;){for(c=E,u=0;u<m;++u)(v=e[u])>=t&&v<c&&(c=v);for(y=r+1,c-t>M((E-n)/y)&&i("overflow"),n+=(c-t)*y,t=c,u=0;u<m;++u)if(v=e[u],v<t&&++n>E&&i("overflow"),v==t){for(h=n,p=b;f=p<=s?T:p>=s+w?w:p-s,!(h<f);p+=b)_=h-f,g=b-f,S.push(L(l(f+_%g,0))),h=M(_/g);S.push(L(l(h,0))),s=d(n,y,r==o),n=0,++r}++n,++t}return S.join("")}function f(e){return s(e,function(e){return C.test(e)?h(e.slice(4).toLowerCase()):e})}function v(e){return s(e,function(e){return A.test(e)?"xn--"+p(e):e})}var m="object"==typeof n&&n&&!n.nodeType&&n,y="object"==typeof t&&t&&!t.nodeType&&t,g="object"==typeof e&&e;g.global!==g&&g.window!==g&&g.self!==g||(r=g);var _,S,E=2147483647,b=36,T=1,w=26,I=38,R=700,k=72,D=128,x="-",C=/^xn--/,A=/[^\x20-\x7E]/,O=/[\x2E\u3002\uFF0E\uFF61]/g,U={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},P=b-T,M=Math.floor,L=String.fromCharCode;if(_={version:"1.4.1",ucs2:{decode:a,encode:u},decode:h,encode:p,toASCII:v,toUnicode:f},"function"==typeof define&&"object"==typeof define.amd&&define.amd)define("punycode",function(){return _});else if(m&&y)if(t.exports==m)y.exports=_;else for(S in _)_.hasOwnProperty(S)&&(m[S]=_[S]);else r.punycode=_}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],51:[function(e,t,n){(function(e){!function(e){"use strict";if("function"==typeof bootstrap)bootstrap("promise",e);else if("object"==typeof n&&"object"==typeof t)t.exports=e();else if("function"==typeof define&&define.amd)define(e);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=e}else{if("undefined"==typeof window&&"undefined"==typeof self)throw new Error("This environment was not anticipated by Q. Please file a bug.");var r="undefined"!=typeof window?window:self,i=r.Q;r.Q=e(),r.Q.noConflict=function(){return r.Q=i,this}}}(function(){"use strict";function t(e){return function(){return Q.apply(e,arguments)}}function n(e){return e===Object(e)}function r(e){return"[object StopIteration]"===ne(e)||e instanceof $}function i(e,t){if(K&&t.stack&&"object"==typeof e&&null!==e&&e.stack){for(var n=[],r=t;r;r=r.source)r.stack&&(!e.__minimumStackCounter__||e.__minimumStackCounter__>r.stackCounter)&&(Z(e,"__minimumStackCounter__",{value:r.stackCounter,configurable:!0}),n.unshift(r.stack));n.unshift(e.stack);var i=n.join("\n"+re+"\n"),s=o(i);Z(e,"stack",{value:s,configurable:!0})}}function o(e){for(var t=e.split("\n"),n=[],r=0;r<t.length;++r){var i=t[r];u(i)||s(i)||!i||n.push(i)}return n.join("\n")}function s(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}function a(e){var t=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(t)return[t[1],Number(t[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(n)return[n[1],Number(n[2])];var r=/.*@(.+):(\d+)$/.exec(e);return r?[r[1],Number(r[2])]:void 0}function u(e){var t=a(e);if(!t)return!1;var n=t[0],r=t[1];return n===B&&r>=G&&r<=ce}function c(){if(K)try{throw new Error}catch(r){var e=r.stack.split("\n"),t=e[0].indexOf("@")>0?e[1]:e[2],n=a(t);if(!n)return;return B=n[0],n[1]}}function l(e){return e instanceof f?e:g(e)?k(e):R(e)}function d(){function e(e){t=e,l.longStackSupport&&K&&(o.source=e),J(n,function(t,n){l.nextTick(function(){e.promiseDispatch.apply(e,n)})},void 0),n=void 0,r=void 0}var t,n=[],r=[],i=z(d.prototype),o=z(f.prototype);if(o.promiseDispatch=function(e,i,o){var s=H(arguments);n?(n.push(s),"when"===i&&o[1]&&r.push(o[1])):l.nextTick(function(){t.promiseDispatch.apply(t,s)})},o.valueOf=function(){if(n)return o;var e=m(t);return y(e)&&(t=e),e},o.inspect=function(){return t?t.inspect():{state:"pending"}},l.longStackSupport&&K)try{throw new Error}catch(e){o.stack=e.stack.substring(e.stack.indexOf("\n")+1),o.stackCounter=ie++}return i.promise=o,i.resolve=function(n){t||e(l(n))},i.fulfill=function(n){t||e(R(n))},i.reject=function(n){t||e(I(n))},i.notify=function(e){t||J(r,function(t,n){l.nextTick(function(){n(e)})},void 0)},i}function h(e){if("function"!=typeof e)throw new TypeError("resolver must be a function.");var t=d();try{e(t.resolve,t.reject,t.notify)}catch(e){t.reject(e)}return t.promise}function p(e){return h(function(t,n){for(var r=0,i=e.length;r<i;r++)l(e[r]).then(t,n)})}function f(e,t,n){void 0===t&&(t=function(e){return I(new Error("Promise does not support operation: "+e))}),void 0===n&&(n=function(){return{state:"unknown"}});var r=z(f.prototype);if(r.promiseDispatch=function(n,i,o){var s;try{s=e[i]?e[i].apply(r,o):t.call(r,i,o)}catch(e){s=I(e)}n&&n(s)},r.inspect=n,n){var i=n();"rejected"===i.state&&(r.exception=i.reason),r.valueOf=function(){var e=n();return"pending"===e.state||"rejected"===e.state?r:e.value}}return r}function v(e,t,n,r){return l(e).then(t,n,r)}function m(e){if(y(e)){var t=e.inspect();if("fulfilled"===t.state)return t.value}return e}function y(e){return e instanceof f}function g(e){return n(e)&&"function"==typeof e.then}function _(e){return y(e)&&"pending"===e.inspect().state}function S(e){return!y(e)||"fulfilled"===e.inspect().state}function E(e){return y(e)&&"rejected"===e.inspect().state}function b(){oe.length=0,se.length=0,ue||(ue=!0)}function T(t,n){ue&&("object"==typeof e&&"function"==typeof e.emit&&l.nextTick.runAfter(function(){-1!==X(se,t)&&(e.emit("unhandledRejection",n,t),ae.push(t))}),se.push(t),n&&void 0!==n.stack?oe.push(n.stack):oe.push("(no stack) "+n))}function w(t){if(ue){var n=X(se,t);-1!==n&&("object"==typeof e&&"function"==typeof e.emit&&l.nextTick.runAfter(function(){var r=X(ae,t);-1!==r&&(e.emit("rejectionHandled",oe[n],t),ae.splice(r,1))}),se.splice(n,1),oe.splice(n,1))}}function I(e){var t=f({when:function(t){return t&&w(this),t?t(e):this}},function(){return this},function(){return{state:"rejected",reason:e}});return T(t,e),t}function R(e){return f({when:function(){return e},get:function(t){return e[t]},set:function(t,n){e[t]=n},delete:function(t){delete e[t]},post:function(t,n){return null===t||void 0===t?e.apply(void 0,n):e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},keys:function(){return te(e)}},void 0,function(){return{state:"fulfilled",value:e}})}function k(e){var t=d();return l.nextTick(function(){try{e.then(t.resolve,t.reject,t.notify)}catch(e){t.reject(e)}}),t.promise}function D(e){return f({isDef:function(){}},function(t,n){return P(e,t,n)},function(){return l(e).inspect()})}function x(e,t,n){return l(e).spread(t,n)}function C(e){return function(){function t(e,t){var s;if("undefined"==typeof StopIteration){try{s=n[e](t)}catch(e){return I(e)}return s.done?l(s.value):v(s.value,i,o)}try{s=n[e](t)}catch(e){return r(e)?l(e.value):I(e)}return v(s,i,o)}var n=e.apply(this,arguments),i=t.bind(t,"next"),o=t.bind(t,"throw");return i()}}function A(e){l.done(l.async(e)())}function O(e){throw new $(e)}function U(e){return function(){return x([this,M(arguments)],function(t,n){return e.apply(t,n)})}}function P(e,t,n){return l(e).dispatch(t,n)}function M(e){return v(e,function(e){var t=0,n=d();return J(e,function(r,i,o){var s;y(i)&&"fulfilled"===(s=i.inspect()).state?e[o]=s.value:(++t,v(i,function(r){e[o]=r,0==--t&&n.resolve(e)},n.reject,function(e){n.notify({index:o,value:e})}))},void 0),0===t&&n.resolve(e),n.promise})}function L(e){if(0===e.length)return l.resolve();var t=l.defer(),n=0;return J(e,function(r,i,o){function s(e){t.resolve(e)}function a(e){0===--n&&(e.message="Q can't get fulfillment value from any promise, all promises were rejected. Last error message: "+e.message,t.reject(e))}function u(e){t.notify({index:o,value:e})}var c=e[o];n++,v(c,s,a,u)},void 0),t.promise}function N(e){return v(e,function(e){return e=Y(e,l),v(M(Y(e,function(e){return v(e,V,V)})),function(){return e})})}function q(e){return l(e).allSettled()}function F(e,t){return l(e).then(void 0,void 0,t)}function j(e,t){return l(e).nodeify(t)}var K=!1;try{throw new Error}catch(e){K=!!e.stack}var B,$,G=c(),V=function(){},W=function(){function t(){for(var e,t;r.next;)r=r.next,e=r.task,r.task=void 0,t=r.domain,t&&(r.domain=void 0,t.enter()),n(e,t);for(;u.length;)e=u.pop(),n(e);o=!1}function n(e,n){try{e()}catch(e){if(a)throw n&&n.exit(),setTimeout(t,0),n&&n.enter(),e;setTimeout(function(){throw e},0)}n&&n.exit()}var r={task:void 0,next:null},i=r,o=!1,s=void 0,a=!1,u=[];if(W=function(t){i=i.next={task:t,domain:a&&e.domain,next:null},o||(o=!0,s())},"object"==typeof e&&"[object process]"===e.toString()&&e.nextTick)a=!0,s=function(){e.nextTick(t)};else if("function"==typeof setImmediate)s="undefined"!=typeof window?setImmediate.bind(window,t):function(){setImmediate(t)};else if("undefined"!=typeof MessageChannel){var c=new MessageChannel;c.port1.onmessage=function(){s=l,c.port1.onmessage=t,t()};var l=function(){c.port2.postMessage(0)};s=function(){setTimeout(t,0),l()}}else s=function(){setTimeout(t,0)};return W.runAfter=function(e){u.push(e),o||(o=!0,s())},W}(),Q=Function.call,H=t(Array.prototype.slice),J=t(Array.prototype.reduce||function(e,t){var n=0,r=this.length;if(1===arguments.length)for(;;){if(n in this){t=this[n++]
;break}if(++n>=r)throw new TypeError}for(;n<r;n++)n in this&&(t=e(t,this[n],n));return t}),X=t(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),Y=t(Array.prototype.map||function(e,t){var n=this,r=[];return J(n,function(i,o,s){r.push(e.call(t,o,s,n))},void 0),r}),z=Object.create||function(e){function t(){}return t.prototype=e,new t},Z=Object.defineProperty||function(e,t,n){return e[t]=n.value,e},ee=t(Object.prototype.hasOwnProperty),te=Object.keys||function(e){var t=[];for(var n in e)ee(e,n)&&t.push(n);return t},ne=t(Object.prototype.toString);$="undefined"!=typeof ReturnValue?ReturnValue:function(e){this.value=e};var re="From previous event:";l.resolve=l,l.nextTick=W,l.longStackSupport=!1;var ie=1;"object"==typeof e&&e&&e.env&&e.env.Q_DEBUG&&(l.longStackSupport=!0),l.defer=d,d.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(H(arguments,1)):e.resolve(n)}},l.Promise=h,l.promise=h,h.race=p,h.all=M,h.reject=I,h.resolve=l,l.passByCopy=function(e){return e},f.prototype.passByCopy=function(){return this},l.join=function(e,t){return l(e).join(t)},f.prototype.join=function(e){return l([this,e]).spread(function(e,t){if(e===t)return e;throw new Error("Q can't join: not the same: "+e+" "+t)})},l.race=p,f.prototype.race=function(){return this.then(l.race)},l.makePromise=f,f.prototype.toString=function(){return"[object Promise]"},f.prototype.then=function(e,t,n){function r(t){try{return"function"==typeof e?e(t):t}catch(e){return I(e)}}function o(e){if("function"==typeof t){i(e,a);try{return t(e)}catch(e){return I(e)}}return I(e)}function s(e){return"function"==typeof n?n(e):e}var a=this,u=d(),c=!1;return l.nextTick(function(){a.promiseDispatch(function(e){c||(c=!0,u.resolve(r(e)))},"when",[function(e){c||(c=!0,u.resolve(o(e)))}])}),a.promiseDispatch(void 0,"when",[void 0,function(e){var t,n=!1;try{t=s(e)}catch(e){if(n=!0,!l.onerror)throw e;l.onerror(e)}n||u.notify(t)}]),u.promise},l.tap=function(e,t){return l(e).tap(t)},f.prototype.tap=function(e){return e=l(e),this.then(function(t){return e.fcall(t).thenResolve(t)})},l.when=v,f.prototype.thenResolve=function(e){return this.then(function(){return e})},l.thenResolve=function(e,t){return l(e).thenResolve(t)},f.prototype.thenReject=function(e){return this.then(function(){throw e})},l.thenReject=function(e,t){return l(e).thenReject(t)},l.nearer=m,l.isPromise=y,l.isPromiseAlike=g,l.isPending=_,f.prototype.isPending=function(){return"pending"===this.inspect().state},l.isFulfilled=S,f.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},l.isRejected=E,f.prototype.isRejected=function(){return"rejected"===this.inspect().state};var oe=[],se=[],ae=[],ue=!0;l.resetUnhandledRejections=b,l.getUnhandledReasons=function(){return oe.slice()},l.stopUnhandledRejectionTracking=function(){b(),ue=!1},b(),l.reject=I,l.fulfill=R,l.master=D,l.spread=x,f.prototype.spread=function(e,t){return this.all().then(function(t){return e.apply(void 0,t)},t)},l.async=C,l.spawn=A,l.return=O,l.promised=U,l.dispatch=P,f.prototype.dispatch=function(e,t){var n=this,r=d();return l.nextTick(function(){n.promiseDispatch(r.resolve,e,t)}),r.promise},l.get=function(e,t){return l(e).dispatch("get",[t])},f.prototype.get=function(e){return this.dispatch("get",[e])},l.set=function(e,t,n){return l(e).dispatch("set",[t,n])},f.prototype.set=function(e,t){return this.dispatch("set",[e,t])},l.del=l.delete=function(e,t){return l(e).dispatch("delete",[t])},f.prototype.del=f.prototype.delete=function(e){return this.dispatch("delete",[e])},l.mapply=l.post=function(e,t,n){return l(e).dispatch("post",[t,n])},f.prototype.mapply=f.prototype.post=function(e,t){return this.dispatch("post",[e,t])},l.send=l.mcall=l.invoke=function(e,t){return l(e).dispatch("post",[t,H(arguments,2)])},f.prototype.send=f.prototype.mcall=f.prototype.invoke=function(e){return this.dispatch("post",[e,H(arguments,1)])},l.fapply=function(e,t){return l(e).dispatch("apply",[void 0,t])},f.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])},l.try=l.fcall=function(e){return l(e).dispatch("apply",[void 0,H(arguments,1)])},f.prototype.fcall=function(){return this.dispatch("apply",[void 0,H(arguments)])},l.fbind=function(e){var t=l(e),n=H(arguments,1);return function(){return t.dispatch("apply",[this,n.concat(H(arguments))])}},f.prototype.fbind=function(){var e=this,t=H(arguments);return function(){return e.dispatch("apply",[this,t.concat(H(arguments))])}},l.keys=function(e){return l(e).dispatch("keys",[])},f.prototype.keys=function(){return this.dispatch("keys",[])},l.all=M,f.prototype.all=function(){return M(this)},l.any=L,f.prototype.any=function(){return L(this)},l.allResolved=function(e,t,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(t+" is deprecated, use "+n+" instead.",new Error("").stack),e.apply(e,arguments)}}(N,"allResolved","allSettled"),f.prototype.allResolved=function(){return N(this)},l.allSettled=q,f.prototype.allSettled=function(){return this.then(function(e){return M(Y(e,function(e){function t(){return e.inspect()}return e=l(e),e.then(t,t)}))})},l.fail=l.catch=function(e,t){return l(e).then(void 0,t)},f.prototype.fail=f.prototype.catch=function(e){return this.then(void 0,e)},l.progress=F,f.prototype.progress=function(e){return this.then(void 0,void 0,e)},l.fin=l.finally=function(e,t){return l(e).finally(t)},f.prototype.fin=f.prototype.finally=function(e){if(!e||"function"!=typeof e.apply)throw new Error("Q can't apply finally callback");return e=l(e),this.then(function(t){return e.fcall().then(function(){return t})},function(t){return e.fcall().then(function(){throw t})})},l.done=function(e,t,n,r){return l(e).done(t,n,r)},f.prototype.done=function(t,n,r){var o=function(e){l.nextTick(function(){if(i(e,s),!l.onerror)throw e;l.onerror(e)})},s=t||n||r?this.then(t,n,r):this;"object"==typeof e&&e&&e.domain&&(o=e.domain.bind(o)),s.then(void 0,o)},l.timeout=function(e,t,n){return l(e).timeout(t,n)},f.prototype.timeout=function(e,t){var n=d(),r=setTimeout(function(){t&&"string"!=typeof t||(t=new Error(t||"Timed out after "+e+" ms"),t.code="ETIMEDOUT"),n.reject(t)},e);return this.then(function(e){clearTimeout(r),n.resolve(e)},function(e){clearTimeout(r),n.reject(e)},n.notify),n.promise},l.delay=function(e,t){return void 0===t&&(t=e,e=void 0),l(e).delay(t)},f.prototype.delay=function(e){return this.then(function(t){var n=d();return setTimeout(function(){n.resolve(t)},e),n.promise})},l.nfapply=function(e,t){return l(e).nfapply(t)},f.prototype.nfapply=function(e){var t=d(),n=H(e);return n.push(t.makeNodeResolver()),this.fapply(n).fail(t.reject),t.promise},l.nfcall=function(e){var t=H(arguments,1);return l(e).nfapply(t)},f.prototype.nfcall=function(){var e=H(arguments),t=d();return e.push(t.makeNodeResolver()),this.fapply(e).fail(t.reject),t.promise},l.nfbind=l.denodeify=function(e){if(void 0===e)throw new Error("Q can't wrap an undefined function");var t=H(arguments,1);return function(){var n=t.concat(H(arguments)),r=d();return n.push(r.makeNodeResolver()),l(e).fapply(n).fail(r.reject),r.promise}},f.prototype.nfbind=f.prototype.denodeify=function(){var e=H(arguments);return e.unshift(this),l.denodeify.apply(void 0,e)},l.nbind=function(e,t){var n=H(arguments,2);return function(){function r(){return e.apply(t,arguments)}var i=n.concat(H(arguments)),o=d();return i.push(o.makeNodeResolver()),l(r).fapply(i).fail(o.reject),o.promise}},f.prototype.nbind=function(){var e=H(arguments,0);return e.unshift(this),l.nbind.apply(void 0,e)},l.nmapply=l.npost=function(e,t,n){return l(e).npost(t,n)},f.prototype.nmapply=f.prototype.npost=function(e,t){var n=H(t||[]),r=d();return n.push(r.makeNodeResolver()),this.dispatch("post",[e,n]).fail(r.reject),r.promise},l.nsend=l.nmcall=l.ninvoke=function(e,t){var n=H(arguments,2),r=d();return n.push(r.makeNodeResolver()),l(e).dispatch("post",[t,n]).fail(r.reject),r.promise},f.prototype.nsend=f.prototype.nmcall=f.prototype.ninvoke=function(e){var t=H(arguments,1),n=d();return t.push(n.makeNodeResolver()),this.dispatch("post",[e,t]).fail(n.reject),n.promise},l.nodeify=j,f.prototype.nodeify=function(e){if(!e)return this;this.then(function(t){l.nextTick(function(){e(null,t)})},function(t){l.nextTick(function(){e(t)})})},l.noConflict=function(){throw new Error("Q.noConflict only works when Q is used as a global")};var ce=c();return l})}).call(this,e("_process"))},{_process:49}],52:[function(e,t,n){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.exports=function(e,t,n,o){t=t||"&",n=n||"=";var s={};if("string"!=typeof e||0===e.length)return s;var a=/\+/g;e=e.split(t);var u=1e3;o&&"number"==typeof o.maxKeys&&(u=o.maxKeys);var c=e.length;u>0&&c>u&&(c=u);for(var l=0;l<c;++l){var d,h,p,f,v=e[l].replace(a,"%20"),m=v.indexOf(n);m>=0?(d=v.substr(0,m),h=v.substr(m+1)):(d=v,h=""),p=decodeURIComponent(d),f=decodeURIComponent(h),r(s,p)?i(s[p])?s[p].push(f):s[p]=[s[p],f]:s[p]=f}return s};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{}],53:[function(e,t,n){"use strict";function r(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var i=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};t.exports=function(e,t,n,a){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"==typeof e?r(s(e),function(s){var a=encodeURIComponent(i(s))+n;return o(e[s])?r(e[s],function(e){return a+encodeURIComponent(i(e))}).join(t):a+encodeURIComponent(i(e[s]))}).join(t):a?encodeURIComponent(i(a))+n+encodeURIComponent(i(e)):""};var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},s=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}},{}],54:[function(e,t,n){"use strict";n.decode=n.parse=e("./decode"),n.encode=n.stringify=e("./encode")},{"./decode":52,"./encode":53}],55:[function(e,t,n){"use strict";function r(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function i(e,t,n){if(e&&c.isObject(e)&&e instanceof r)return e;var i=new r;return i.parse(e,t,n),i}function o(e){return c.isString(e)&&(e=i(e)),e instanceof r?e.format():r.prototype.format.call(e)}function s(e,t){return i(e,!1,!0).resolve(t)}function a(e,t){return e?i(e,!1,!0).resolveObject(t):t}var u=e("punycode"),c=e("./util");n.parse=i,n.resolve=s,n.resolveObject=a,n.format=o,n.Url=r;var l=/^([a-z0-9.+-]+:)/i,d=/:[0-9]*$/,h=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,p=["<",">",'"',"`"," ","\r","\n","\t"],f=["{","}","|","\\","^","`"].concat(p),v=["'"].concat(f),m=["%","/","?",";","#"].concat(v),y=["/","?","#"],g=/^[+a-z0-9A-Z_-]{0,63}$/,_=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,S={javascript:!0,"javascript:":!0},E={javascript:!0,"javascript:":!0},b={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},T=e("querystring");r.prototype.parse=function(e,t,n){if(!c.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var r=e.indexOf("?"),i=-1!==r&&r<e.indexOf("#")?"?":"#",o=e.split(i),s=/\\/g;o[0]=o[0].replace(s,"/"),e=o.join(i);var a=e;if(a=a.trim(),!n&&1===e.split("#").length){var d=h.exec(a);if(d)return this.path=a,this.href=a,this.pathname=d[1],d[2]?(this.search=d[2],this.query=t?T.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var p=l.exec(a);if(p){p=p[0];var f=p.toLowerCase();this.protocol=f,a=a.substr(p.length)}if(n||p||a.match(/^\/\/[^@\/]+@[^@\/]+/)){var w="//"===a.substr(0,2);!w||p&&E[p]||(a=a.substr(2),this.slashes=!0)}if(!E[p]&&(w||p&&!b[p])){for(var I=-1,R=0;R<y.length;R++){var k=a.indexOf(y[R]);-1!==k&&(-1===I||k<I)&&(I=k)}var D,x;x=-1===I?a.lastIndexOf("@"):a.lastIndexOf("@",I),-1!==x&&(D=a.slice(0,x),a=a.slice(x+1),this.auth=decodeURIComponent(D)),I=-1;for(var R=0;R<m.length;R++){var k=a.indexOf(m[R]);-1!==k&&(-1===I||k<I)&&(I=k)}-1===I&&(I=a.length),this.host=a.slice(0,I),a=a.slice(I),this.parseHost(),this.hostname=this.hostname||"";var C="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!C)for(var A=this.hostname.split(/\./),R=0,O=A.length;R<O;R++){var U=A[R];if(U&&!U.match(g)){for(var P="",M=0,L=U.length;M<L;M++)U.charCodeAt(M)>127?P+="x":P+=U[M];if(!P.match(g)){var N=A.slice(0,R),q=A.slice(R+1),F=U.match(_);F&&(N.push(F[1]),q.unshift(F[2])),q.length&&(a="/"+q.join(".")+a),this.hostname=N.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),C||(this.hostname=u.toASCII(this.hostname));var j=this.port?":"+this.port:"",K=this.hostname||"";this.host=K+j,this.href+=this.host,C&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==a[0]&&(a="/"+a))}if(!S[f])for(var R=0,O=v.length;R<O;R++){var B=v[R];if(-1!==a.indexOf(B)){var $=encodeURIComponent(B);$===B&&($=escape(B)),a=a.split(B).join($)}}var G=a.indexOf("#");-1!==G&&(this.hash=a.substr(G),a=a.slice(0,G));var V=a.indexOf("?");if(-1!==V?(this.search=a.substr(V),this.query=a.substr(V+1),t&&(this.query=T.parse(this.query)),a=a.slice(0,V)):t&&(this.search="",this.query={}),a&&(this.pathname=a),b[f]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var j=this.pathname||"",W=this.search||"";this.path=j+W}return this.href=this.format(),this},r.prototype.format=function(){var e=this.auth||"";e&&(e=encodeURIComponent(e),e=e.replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",r=this.hash||"",i=!1,o="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&c.isObject(this.query)&&Object.keys(this.query).length&&(o=T.stringify(this.query));var s=this.search||o&&"?"+o||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||b[t])&&!1!==i?(i="//"+(i||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):i||(i=""),r&&"#"!==r.charAt(0)&&(r="#"+r),s&&"?"!==s.charAt(0)&&(s="?"+s),n=n.replace(/[?#]/g,function(e){return encodeURIComponent(e)}),s=s.replace("#","%23"),t+i+n+s+r},r.prototype.resolve=function(e){return this.resolveObject(i(e,!1,!0)).format()},r.prototype.resolveObject=function(e){if(c.isString(e)){var t=new r;t.parse(e,!1,!0),e=t}for(var n=new r,i=Object.keys(this),o=0;o<i.length;o++){var s=i[o];n[s]=this[s]}if(n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol){for(var a=Object.keys(e),u=0;u<a.length;u++){var l=a[u];"protocol"!==l&&(n[l]=e[l])}return b[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n}if(e.protocol&&e.protocol!==n.protocol){if(!b[e.protocol]){for(var d=Object.keys(e),h=0;h<d.length;h++){var p=d[h];n[p]=e[p]}return n.href=n.format(),n}if(n.protocol=e.protocol,e.host||E[e.protocol])n.pathname=e.pathname;else{for(var f=(e.pathname||"").split("/");f.length&&!(e.host=f.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==f[0]&&f.unshift(""),f.length<2&&f.unshift(""),n.pathname=f.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var v=n.pathname||"",m=n.search||"";n.path=v+m}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var y=n.pathname&&"/"===n.pathname.charAt(0),g=e.host||e.pathname&&"/"===e.pathname.charAt(0),_=g||y||n.host&&e.pathname,S=_,T=n.pathname&&n.pathname.split("/")||[],f=e.pathname&&e.pathname.split("/")||[],w=n.protocol&&!b[n.protocol];if(w&&(n.hostname="",n.port=null,n.host&&(""===T[0]?T[0]=n.host:T.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===f[0]?f[0]=e.host:f.unshift(e.host)),e.host=null),_=_&&(""===f[0]||""===T[0])),g)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,T=f;else if(f.length)T||(T=[]),T.pop(),T=T.concat(f),n.search=e.search,n.query=e.query;else if(!c.isNullOrUndefined(e.search)){if(w){n.hostname=n.host=T.shift();var I=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@");I&&(n.auth=I.shift(),n.host=n.hostname=I.shift())}return n.search=e.search,n.query=e.query,c.isNull(n.pathname)&&c.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!T.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var R=T.slice(-1)[0],k=(n.host||e.host||T.length>1)&&("."===R||".."===R)||""===R,D=0,x=T.length;x>=0;x--)R=T[x],"."===R?T.splice(x,1):".."===R?(T.splice(x,1),D++):D&&(T.splice(x,1),D--);if(!_&&!S)for(;D--;D)T.unshift("..");!_||""===T[0]||T[0]&&"/"===T[0].charAt(0)||T.unshift(""),k&&"/"!==T.join("/").substr(-1)&&T.push("");var C=""===T[0]||T[0]&&"/"===T[0].charAt(0);if(w){n.hostname=n.host=C?"":T.length?T.shift():"";var I=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@");I&&(n.auth=I.shift(),n.host=n.hostname=I.shift())}return _=_||n.host&&T.length,_&&!C&&T.unshift(""),T.length?n.pathname=T.join("/"):(n.pathname=null,n.path=null),c.isNull(n.pathname)&&c.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},r.prototype.parseHost=function(){var e=this.host,t=d.exec(e);t&&(t=t[0],":"!==t&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},{"./util":56,punycode:50,querystring:54}],56:[function(e,t,n){"use strict";t.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},{}]},{},[1]);
//# sourceMappingURL=dist/browser-matrix.min.js.map